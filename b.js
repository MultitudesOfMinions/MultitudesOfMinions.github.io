"use strict";const equipped={weapon:null,shield:null,feet:null,legs:null,torso:null,head:null,trinket:null,amulet:null},soldItems=[];function itemDrop(t){if(!tierUnlocked(4))return;if(inventory.length>=maxInventory){toggleUIElementByID("fullInventory",!0);return}let e=itemFactory(t);inventory.push(e),setElementTextById("inventoryCount",inventory.length),filterInventory();let i=getUIElement("ddlForgeItems"),n=createNewElement("option","opt"+e.id,i,[],e.toString());n.value=e.id}function equip(t){let e=inventory.find(e=>e.id===t);unequip(e.type),equipped[e.type]=e,recalculateSellValue()}function sell(t){let e=inventory.find(e=>e.id===t),i=inventory.indexOf(e);if(i<0)return;let n=inventory[i].sellValue();soldItems.push({value:n,item:inventory[i]}),inventory.splice(i,1),toggleUIElementByID("fullInventory",!0),setItemBuyBack(),resources.e.amt+=n,achievements.itemScrapped.count++,recalculateSellValue(),setElementTextById("inventoryCount",inventory.length);let a=document.getElementById("divItem"+t);a&&a.parentNode.removeChild(a);let o=getUIElement("ddlForgeItems");if(t==o.value)populateForgeItems(),o.selectedIndex=-1;else{let l=document.getElementById("opt"+t);l&&l.parentElement==o&&o.removeChild(l)}}function buyBack(){if(0==soldItems.length)return;for(;soldItems.length>8;)soldItems.shift();if(inventory.length>=24){toggleUIElementByID("buyBackFullInventory",!1);return}let t=soldItems[soldItems.length-1].value;if(resources.e.amt<t)return;resources.e.amt-=t,achievements.itemScrapped.count--;let e=soldItems.pop().item;e.isLocked=!0,inventory.push(e),setItemBuyBack()}function setItemBuyBack(){if(0==soldItems.length){toggleUIElementByID("divBuyBack",!0);return}toggleUIElementByID("divBuyBack",!1);let t=getUIElement("divBuyBackPreview");clearChildren(t);let e=soldItems[soldItems.length-1].item;e.buildHtml(t,"BuyBack"),setElementTextById("buyBackValue",soldItems[soldItems.length-1].value||"0")}function toggleLock(t,e){let i=inventory.find(t=>t.id===e),n=inventory.indexOf(i);if(n<0)return;inventory[n].isLocked=!inventory[n].isLocked;let a=inventory[n].isLocked?"\uD83D\uDD12":"\uD83D\uDD13";setElementText(t,a)}function unequip(t){let e=document.getElementById("divEquipped"+t.fixString());equipped[t]=null,e.textContent=null}function getEquippedEffect(t,e){let i=1,n=0;for(let[a,o]of Object.entries(equipped)){if(null===o)continue;let l=getEquippedItemEffect(a,t,e);n+=l.a,i*=l.m}return backwardsStats.includes(e)&&(i=1/i,n*=-1),{m:i,a:n}}function getEquippedItemEffect(t,e,i){let n=1,a=0,o=equipped[t];if(null==o)return{m:n,a:a};"Boss"===e&&o.stat.attr===i&&(a+=o.stat.power);for(let l=0;l<o.attributes.length;l++){let c=o.attributes[l],r=isTeam0(e)&&"Invaders"===c.target||isTeam1(e)&&"Defenders"===c.target||void 0!==resources[e]&&"All"===c.target;(c.target===e||r)&&c.effect===i&&(c.range.type===rangeTypes.a?a+=c.power:c.range.type===rangeTypes.m&&(n*=c.power))}return{m:n,a:a}}function recalculateSellValue(){for(var t=0;t<inventory.length;t++)inventory[t].updateSellValue()}function filterInventory(){let t=getUIElement("divItems").children;for(let e=0;e<t.length;e++){let i=t[e].id.replace("divItem",""),n=inventory.find(t=>t.id==i).type,a=document.getElementById("chkFilter"+n).checked;toggleUIElement(t[e],!a)}}function filterAll(t){let e=document.getElementsByClassName("chkItemFilter");for(let i=0;i<e.length;i++)e[i].checked=t.checked;filterInventory()}function deleteSaveData(){setCookie("gs","",new Date(0).toUTCString()),setCookie("opt","",new Date(0).toUTCString()),setCookie("inv","",new Date(0).toUTCString())}function setCookie(t,e,i){document.cookie=`${t}=${e};expires=${i};SameSite=Strict;domain=${document.domain};path=/`}function loadURL(){var t=new URL(window.location.href),e=t.searchParams.get("D");if(null!==e){let i=atob(e);loadDataFromString(i),buildWorld(),yesCookies(),window.history.replaceState({},document.title,t.origin+t.pathname)}return!1}function isEmpty(t){return 0===Object.keys(t).length}function isObject(t){return t&&"object"==typeof t&&!Array.isArray(t)}function mergeDeep(t,...e){if(!e.length)return t;let i=e.shift();if(!isObject(t)||!isObject(i))return mergeDeep(t,...e);for(let n in i)isObject(i[n])?(t[n]||Object.assign(t,{[n]:{}}),mergeDeep(t[n],i[n])):Object.assign(t,{[n]:i[n]});return mergeDeep(t,...e)}function cleanObject(t,e){if(isObject(t)&&isObject(e))for(let i in e)i in t?isObject(t[i])&&isObject(e[i])&&cleanObject(t[i],e[i]):(console.warn(`Unexpected property '${i}' with value '${e[i]}' on ${e}.`),delete e[i])}function offlineGains(t){if(0==t)return;let e=getAchievementScore(),i=Math.floor(t/60*e),n={};for(let a=0;a<5;a++){if(!tierUnlocked(a))return;switch(i=Math.floor(Math.max(i**.5-1,0)),a){case 0:resources.a.amt+=i,n.a=i;break;case 1:resources.b.amt+=i,n.b=i;break;case 2:resources.c.amt+=i,n.c=i;break;case 3:resources.d.amt+=i,n.d=i;break;case 4:resources.e.amt+=i,n.e=i}}let o=document.getElementById("gainsList");for(let l in n){let c=`
${resources[l].name}: ${n[l]}${resources[l].symbol}`;createNewElement("li","gains"+l,o,[],c)}toggleUIElementByID("gainsModal",!1)}const year=525600;function loadCookieData(){let t=getCookie("gs");t&&null!=t&&(yesCookies(),toggleUIElementByID("introModal",!0),loadDataFromString(atob(t)));let e=getCookie("opt");e&&null!==e&&loadDataFromString(atob(e));let i=getCookie("inv");i&&null!=i&&loadDataFromString(atob(i))}function loadDataFromString(t){let e={};try{e=JSON.parse(t)}catch{console.error(t,e),console.error("Error loading JSON"),console.trace()}loadMinionResearch(e),loadMinionUpgrades(e),loadBossResearch(e),loadBossUpgrades(e),loadGauges(e),loadResources(e),loadTierMisc(e),loadAchievements(e),loadMisc(e),loadInventory(e),loadOptions(e),loadTime(e)}function loadTime(t){if(!t.hasOwnProperty("t"))return;let e=getTimeSave(),i=t.t,n=e-i;for(;n<0;)n+=525600;offlineGains(n=Math.max(0,n-30))}function loadMinionResearch(t){if(t.hasOwnProperty("mr"))for(let e in t.mr){let i=slMap.toLoad(e);if(!minionResearch.hasOwnProperty(i))continue;minionResearch[i].isUnlocked=1,minionResearch[i].lastSpawn=t.mr[e];let n=document.getElementById("chkSpawn"+i);null!=n&&(n.checked=!0)}}function loadMinionUpgrades(t){if(t.hasOwnProperty("mu"))for(let e in t.mu){let i=slMap.toLoad(e);if(minionUpgrades.hasOwnProperty(i))for(let n in t.mu[e]){let a=slMap.toLoad(n);minionUpgrades[i].hasOwnProperty(a)&&(minionUpgrades[i][a]=t.mu[e][n])}}}function loadBossResearch(t){if(t.hasOwnProperty("br"))for(let e in t.br){let i=slMap.toLoad(e);bossResearch.hasOwnProperty(i)&&(bossResearch[i].isUnlocked=1,bossResearch[i].lastSpawn=t.br[e])}}function loadBossUpgrades(t){if(t.hasOwnProperty("bu"))for(let e in t.bu){let i=slMap.toLoad(e);if(bossUpgrades.hasOwnProperty(i))for(let n in t.bu[e]){let a=slMap.toLoad(n);bossUpgrades[i].hasOwnProperty(a)&&(bossUpgrades[i][a]=t.bu[e][n])}}}function loadGauges(t){if(t.hasOwnProperty("g"))for(let e in t.g){let i=slMap.toLoad(t.g[e]);gauges.hasOwnProperty(i)&&(gauges[i].isUnlocked=1)}}function loadResources(t){if(t.hasOwnProperty("r"))for(let e in t.r)resources.hasOwnProperty(e)&&(resources[e].amt=t.r[e])}function loadTierMisc(t){if(!t.hasOwnProperty("tm"))return;let e=t.tm;for(let i in e)e[i].hasOwnProperty("ab")&&(tierMisc[i].autobuy.isUnlocked=1),e[i].hasOwnProperty("p")&&(tierMisc[i].upgradePotency=e[i].p)}function loadAchievements(t){if(t.hasOwnProperty("a"))for(let e in t.a){let i=slMap.toLoad(e);if(achievements.hasOwnProperty(i)){if(!t.a[e].hasOwnProperty("c")){achievements[i].count=t.a[e]||0;continue}achievements[i].count=t.a[e].c||0,achievements[i].maxCount=t.a[e].m||0}}}function loadMisc(t){if(!t.hasOwnProperty("m"))return;let e=t.m;e.hasOwnProperty("l")&&(totalPaths=LevelToTotalPaths(e.l),level=e.l),e.hasOwnProperty("mm")&&(maxMinions=e.mm),e.hasOwnProperty("ul")&&(maxUpgradeLevel=e.ul),e.hasOwnProperty("gsr")&&(globalSpawnDelayReduction=e.gsr),e.hasOwnProperty("MP")&&(moneyPitLevel=e.MP),e.hasOwnProperty("al")&&(maxAutosellLimit=e.al,getUIElement("autoSellLimit").max=maxAutosellLimit,setElementTextById("maxAutosell",maxAutosellLimit)),e.hasOwnProperty("af")&&(maxAutoForgeLimit=e.af,getUIElement("autoForgeLimit").max=maxAutoForgeLimit,setElementTextById("maxAutoForge",maxAutoForgeLimit)),e.hasOwnProperty("R")&&(maxResetLevel=e.R,getUIElement("startingLevelSelector").max=e.R)}function loadInventory(t){if(!t.hasOwnProperty("i"))return;inventory.length=0;let e=t.i;for(let i=0;i<e.length;i++)loadItem(e[i]);setElementTextById("inventoryCount",inventory.length)}function loadOptions(t){if(!t.hasOwnProperty("o"))return;let e=t.o;e.hasOwnProperty("fps")&&(document.getElementById("chkShowFPS").checked=e.fps),e.hasOwnProperty("simple")&&(document.getElementById("chkSmipleMinions").checked=e.simple),e.hasOwnProperty("compact")&&(document.getElementById("chkCompactMinions").checked=e.compact),e.hasOwnProperty("p1Rate")&&(document.getElementById("ddlP1Rate").value=e.p1Rate),e.hasOwnProperty("quality")&&(document.getElementById("ddlQuality").value=e.quality),e.hasOwnProperty("style")&&(document.getElementById("ddlColors").value=e.style),e.hasOwnProperty("blind")&&(document.getElementById("chkColorblind").checked=e.blind),e.hasOwnProperty("boss")&&(document.querySelector("input[name='bossSelect'][value='"+e.boss+"']").checked=!0),e.hasOwnProperty("bPos")&&(document.getElementById("bossPosition").value=e.bPos),e.hasOwnProperty("p0B")&&(document.getElementById("chkAutoBuy0").checked=e.p0B),e.hasOwnProperty("p0P")&&(document.getElementById("chkAutoPrestige0").checked=e.p0P),e.hasOwnProperty("p1B")&&(document.getElementById("chkAutoBuy1").checked=e.p1B),e.hasOwnProperty("p1P")&&(document.getElementById("chkAutoPrestige1").checked=e.p1P),e.hasOwnProperty("p2B")&&(document.getElementById("chkAutoBuy2").checked=e.p2B),e.hasOwnProperty("p2P")&&(document.getElementById("chkAutoPrestige2").checked=e.p2P),e.hasOwnProperty("p3B")&&(document.getElementById("chkAutoBuy3").checked=e.p3B),e.hasOwnProperty("p3P")&&(document.getElementById("chkAutoPrestige3").checked=e.p3P),e.hasOwnProperty("p4A")&&(document.getElementById("chkAutoSell").checked=e.p4A),e.hasOwnProperty("p4L")&&(document.getElementById("autoSellLimit").value=e.p4L,autoSellLimit=+e.p4L,getUIElement("autoSellLimitSelection").textContent=autoSellLimit),e.hasOwnProperty("p4F")&&(document.getElementById("chkAutoForge").checked=e.p4F,onChangeChkAutoForge()),e.hasOwnProperty("p4U")&&(document.getElementById("autoForgeLimit").value=e.p4U,autoForgeLimit=+e.p4U,getUIElement("autoForgeLimitSelection").textContent=autoForgeLimit),e.hasOwnProperty("p4S")&&(document.getElementById("startingLevelSelector").value=e.p4S,document.getElementById("startingLevelSelection").textContent=e.p4S,resetLevel=e.p4S)}function saveData(){let t=new Date;t.setDate(t.getTime()+7);let e=buildGameState(!0,!1,!1),i=buildGameState(!1,!0,!1),n=buildGameState(!1,!1,!0),a=btoa(e),o=btoa(i),l=btoa(n);setCookie("gs",a,t.toUTCString()),setCookie("inv",o,t.toUTCString()),setCookie("opt",l,t.toUTCString()),lastSave=0,document.getElementById("txtExport").value=null}function buildGameState(t,e,i){let n={t:getTimeSave()};if(t){let a=getResourcesSave();isEmpty(a)||(n.r=a);let o=getMinionResearchSave();isEmpty(o)||(n.mr=o);let l=getMinionUpgradeSave();isEmpty(l)||(n.mu=l);let c=getBossResearchSave();isEmpty(c)||(n.br=c);let r=getBossUpgradeSave();isEmpty(r)||(n.bu=r);let s=getGaugesSave();isEmpty(s)||(n.g=s);let h=getAchievementSave();isEmpty(h)||(n.a=h);let u=getTierMiscSave();isEmpty(u)||(n.tm=u);let m=getMiscSave();isEmpty(m)||(n.m=m)}if(e){let d=getInventorySave();isEmpty(d)||(n.i=d)}if(i){let x=getOptionsSave();isEmpty(x)||(n.o=x)}return JSON.stringify(n)}function getTimeSave(){return Math.floor(Date.now()/6e4)%525600}function getMinionResearchSave(){let t={};for(let e in minionResearch)minionResearch[e].isUnlocked&&(t[slMap.toSave(e)]=minionResearch[e].lastSpawn);return t}function getMinionUpgradeSave(){let t={};for(let e in minionUpgrades)for(let i in minionUpgrades[e])if(minionUpgrades[e][i]>0){let n=slMap.toSave(e);t.hasOwnProperty(n)||(t[n]={}),t[n][slMap.toSave(i)]=minionUpgrades[e][i]}return t}function getBossResearchSave(){let t={};for(let e in bossResearch)bossResearch[e].isUnlocked&&(t[slMap.toSave(e)]=bossResearch[e].lastSpawn);return t}function getBossUpgradeSave(){let t={};for(let e in bossUpgrades)for(let i in bossUpgrades[e])if(bossUpgrades[e][i]>0){let n=slMap.toSave(e);t.hasOwnProperty(n)||(t[n]={});let a=slMap.toSave(i),o=bossUpgrades[e][i];t[n][a]=o}return t}function getGaugesSave(){let t=[];for(let e in gauges)gauges[e].isUnlocked&&t.push(slMap.toSave(e));return t}function getResourcesSave(){let t={};for(let e in resources)resources[e].amt>0&&(t[e]=resources[e].amt);return t}function getTierMiscSave(){let t={};for(let e in tierMisc)tierMisc[e].autobuy.isUnlocked&&(t.hasOwnProperty(e)||(t[e]={}),t[e].ab=1),tierMisc[e].upgradePotency>1&&(t.hasOwnProperty(e)||(t[e]={}),t[e].p=tierMisc[e].upgradePotency);return t}function getAchievementSave(){let t={};for(let e in achievements)(achievements[e].count>0||achievements[e].maxCount>0)&&(t[slMap.toSave(e)]={c:achievements[e].count,m:achievements[e].maxCount});return t}function getMiscSave(){let t={};return level>0&&(t.l=level),maxMinions>0&&(t.mm=maxMinions),maxUpgradeLevel>defaultMaxUpgradeLevel&&(t.ul=maxUpgradeLevel),globalSpawnDelayReduction>0&&(t.gsr=globalSpawnDelayReduction),moneyPitLevel>0&&(t.MP=moneyPitLevel),maxAutosellLimit>100&&(t.al=maxAutosellLimit),maxAutoForgeLimit>100&&(t.af=maxAutoForgeLimit),maxResetLevel>0&&(t.R=maxResetLevel),t}function getInventorySave(){let t=[];for(let e=0;e<inventory.length;e++)t.push(inventory[e].buildSave());return t}function getOptionsSave(){let t={};return t.fps=document.getElementById("chkShowFPS")?.checked,t.simple=document.getElementById("chkSmipleMinions").checked,t.compact=document.getElementById("chkCompactMinions").checked,t.p1Rate=document.getElementById("ddlP1Rate").value,t.quality=document.getElementById("ddlQuality").value,t.style=document.getElementById("ddlColors").value,t.blind=document.getElementById("chkColorblind").checked,t.boss=document.querySelector("input[name='bossSelect']:checked")?.value,t.bPos=document.getElementById("bossPosition").value,t.p0B=document.getElementById("chkAutoBuy0").checked,t.p0P=document.getElementById("chkAutoPrestige0").checked,t.p1B=document.getElementById("chkAutoBuy1").checked,t.p1P=document.getElementById("chkAutoPrestige1").checked,t.p2B=document.getElementById("chkAutoBuy2").checked,t.p2P=document.getElementById("chkAutoPrestige2").checked,t.p3B=document.getElementById("chkAutoBuy3").checked,t.p3P=document.getElementById("chkAutoPrestige3").checked,t.p4A=document.getElementById("chkAutoSell").checked,t.p4L=document.getElementById("autoSellLimit").value,t.p4F=document.getElementById("chkAutoForge").checked,t.p4U=document.getElementById("autoForgeLimit").value,t.p4S=document.getElementById("startingLevelSelector").value,t}const saveLoadDictionary={a:"Air",Ab:"bossesSummoned",Ad:statTypes.abilityDuration,Ac:statTypes.abilityCooldown,Ak:"heroesKilled",Al:"maxLevelCleared",Am:"minionsSpawned",A0:"prestige0",A1:"prestige1",A2:"prestige2",A3:"prestige3",A4:"prestige4",Ao:"boostsPurchased",Ap:"itemPrestiged",As:"itemScrapped",At:"towersDestroyed",al:"maxAutosellLimit",af:"maxAutoForgeLimit",ac:statTypes.attackCharges,ap:statTypes.auraPower,ar:statTypes.auraRange,at:statTypes.attackDelay,ag:statTypes.attackRange,b:"Bomber",c:"Catapult",cr:statTypes.chainReduction,de:"Death",d:statTypes.damage,D:"Damage",e:"Earth",f:"Fire",F:"Famine",g:"Golem",h:"Harpy",hp:statTypes.health,HP:"Health",i:statTypes.initialMinions,I:"Imp",l:"lastSpawn",m:"Mite",mp:statTypes.minionsPerDeploy,MP:"MoneyPitLevel",ms:statTypes.moveSpeed,P:"Pestilence",ps:statTypes.projectileSpeed,pt:"projectileType",r:"Ram",R:"resetLevel",Ra:"Range",Re:"Reload",sd:statTypes.spawnDelay,sr:statTypes.impactRadius,tc:statTypes.targetCount,u:"isUnlocked",v:"Vampire",w:"Water",W:"War",wr:statTypes.regen},slMap=new TwoWayMap(saveLoadDictionary);function TwoWayMap(t){for(let e in this.map=t,this.reverseMap={},t){let i=t[e];this.reverseMap[i]=e}}function getCookie(t){let e=document.cookie;t+="=";let i=e.indexOf(t);if(-1==i)return null;let n=e.indexOf(";",i);-1==n&&(n=e.length);let a=e.substring(i+t.length,n);return a}function getExport(){saveData();let t=buildGameState(!0,!0),e=btoa(t),i=document.getElementById("txtExport");i.value=e,document.getElementById("txtImport").value=null}function doImport(){let t=document.getElementById("txtImport"),e=t.value,i=atob(e);loadDataFromString(i),buildWorld(),t.value=null,document.getElementById("txtExport").value=null}function getPrestigeBonus(t){switch(t){case 0:return getAchievementBonus("towersDestroyed");case 1:return getAchievementBonus("heroesKilled");case 2:return getAchievementBonus("bossesSummoned");case 3:return getAchievementBonus("itemScrapped");default:return console.warn(t),0}}function getDiscount(t){let e=Object.keys(resources)[t],i=getEquippedEffect(e,"discount"),n="prestige"+t,a=getAchievementBonus(n),o=a+a**.5;return o+=i.a,Math.floor(o*=i.m)}function getBossBoost(){let t=getAchievementBonus("minionsSpawned")/20;return 1+t}function getRarityBoost(){return getAchievementBonus("maxLevelCleared")}function getDamageModifier(){let t=getAchievementBonus("boostsPurchased"),e=.8,i=(.4*t)**e;return i*=8,Math.min(99,i=Math.floor(i))}function getAchievementLevel(t){let e=achievements[t];if(null==e)return 0;let i=e.add,n=e.mult;if(i<=0&&n<=1)return -1;let a=0,o=e.first;for(;o<=e.count;)o=(o+i)*n,a++;return a}function getAchievementBonuses(){let t={};for(let e=0;e<4;e++)t[e]=getAchievementBonus("prestige"+e);return t}function getAchievementBonus(t){let e=achievements[t];if(null==e)return 0;let i=getAchievementLevel(t);if(0==i)return 0;let n=3*e.maxCount;return i+n}function getAchievementNext(t){let e=achievements[t];if(null==e)return 0;let i=e.add,n=e.mult;if(i<=0&&n<=1)return -1;let a=e.first;for(;a<=e.count;)a=(a+i)*n;return Math.ceil(a)}function getAchievementLast(t){let e=achievements[t];if(null==e)return 0;let i=getAchievementLevel(t);if(0==i&&0==e.maxCount)return 0;let n=e.add,a=e.mult;if(n<=0&&a<=1)return -1;let o=e.first;for(;o<=e.count;)o=(o+n)*a;return o/a-n}function tierUnlocked(t){switch(t){case 0:return!0;case 1:return achievements.prestige0.count>0||tierUnlocked(2);case 2:return achievements.prestige1.count>0||tierUnlocked(3);case 3:return achievements.prestige2.count>0||tierUnlocked(4);case 4:return achievements.prestige3.count>0||tierUnlocked(5);case 5:return achievements.itemPrestiged.count>0||resources.f.amt>0;default:return!1}}function getAchievementScore(){let t=0;for(let e in achievements){let i=achievements[e],n=getAchievementLevel(e),a=i.maxCount,o=i.maxLevel,l=getAchievementLast(e),c=getAchievementNext(e),r=(i.count-l)*100/(c-l),s=n+a*o;s*=100,s+=r,t+=s}return Math.floor(100*t)/100}TwoWayMap.prototype.toLoad=function(t){return this.map[t]},TwoWayMap.prototype.toSave=function(t){return this.reverseMap[t]};const minionUpgradeTypes=[[statTypes.health,statTypes.damage],[statTypes.attackDelay,statTypes.moveSpeed],[statTypes.attackRange,statTypes.impactRadius],[statTypes.minionsPerDeploy,statTypes.spawnDelay]];function getUpgradeTier(t){for(let e=0;e<minionUpgradeTypes.length;e++)if(minionUpgradeTypes[e].includes(t))return e;return -1}function getMoneyPitCost(){let t=getDiscount(0),e=2**moneyPitLevel;return Math.max(1,e-t)}function getMaxMinionCost(){let t=getDiscount(1),e=maxMinions+1;return Math.max(1,4*e**4+2*e**2+e-t)}function getMaxUpgradeLevelCost(){let t=maxUpgradeLevel+1,e=getDiscount(2);return Math.max(1,2**t*t-e)}function getGlobalSpawnDelayReductionCost(){let t=getDiscount(3),e=globalSpawnDelayReduction**2;return Math.max(1,e-t)}function getAutoSellCost(){let t=getDiscount(4),e=maxAutosellLimit/100;return Math.max(1,(e<<2+e)-t)}function getAutoForgeCost(){let t=getDiscount(4),e=maxAutoForgeLimit/100;return Math.max(1,(e<<1+e)-t)}function getRestartLevelCost(){let t=getDiscount(4),e=maxResetLevel+1,i=Math.min(achievements.maxLevelCleared.count+1,10);return e>i?1/0:Math.max(1,2**e+e**2+61-t)}function getStoreChestCost(){let t=+getUIElement("numStoreTier").value,e=getDiscount(5);return Math.max(1,(t+1)**2-e)}function getAutobuyCost(t){let e=t+1,i=getDiscount(e);return Math.max(1,8*e-i)}function getPotencies(){let t={};for(let e=0;e<4;e++)t[e]=getUpgradePotency(e);return t}function getUpgradePotency(t){return tierMisc["t"+t]?.upgradePotency||1}function getPotencyCost(t){let e=getDiscount(t+1),i=getUpgradePotency(t);return Math.max(1,4*i**4+2*i**2+60-e)}function getUpgradeCost(t,e){if(null===t||null===e)return 1/0;let i=minionUpgrades[t][e];if(null==i)return -1;if(i>=getMaxUpgradeLevel())return 1/0;let n=getUpgradeTier(e),a=2**Math.floor(i),o=Math.min(getDiscount(n),.9*a);return Math.max(1,Math.floor(a-o))}function getEnhanceCost(t,e){let i=bossUpgrades[t][e];if(null==i)return -1;if(i>=getMaxUpgradeLevel())return 1/0;let n=getDiscount(3);return Math.max(1,2**Math.floor(i+2)-n)}function getPrestigeCost(t){let e=(achievements["prestige"+t].count+8)**.8,i=getDiscount(t);return Math.max(1,Math.floor(e*(t+1)+12)-i)}function getPrestigeGain(t){let e=getPrestigeBonus(t)**((5+t/2)/10)||1,i=Object.keys(resources)[t+1],n=getEquippedEffect(i,"gain"),a=getUpgradeCount(t);return Math.floor((a+n.a)*e*n.m)}function getUpgradeCount(t){let e=0,i=minionUpgradeTypes[t];if(0==t){for(let n in minionUpgrades)for(let a in i){let o=i[a];e+=minionUpgrades[n][o]}e+=moneyPitLevel}else if(1==t){for(let l in minionUpgrades)for(let c in i){let r=i[c];e+=minionUpgrades[l][r]}e+=maxMinions}else if(2==t){for(let s in minionUpgrades)for(let h in i){let u=i[h];e+=minionUpgrades[s][u]}e+=globalSpawnDelayReduction,e+=maxUpgradeLevel-defaultMaxUpgradeLevel}else if(3==t){for(let m in minionUpgrades)for(let d in i){let x=i[d];e+=minionUpgrades[m][x]}for(let f in bossUpgrades)for(let g in bossUpgrades[f])e+=bossUpgrades[f][g]}else 4==t&&(e+=maxAutosellLimit/100);return e*getUpgradePotency(t)}function unlockMinionCost(t){let e=minionResearch[t].unlockT,i=getDiscount(e),n=0;for(let a in minionResearch)minionResearch[a].isUnlocked&&minionResearch[a].unlockT==e&&n++;let o=Math.floor(8*n+getMinionBaseStats(t).unlockCost-i);return Math.max(1,o)}function unlockBossCost(){let t=getDiscount(3),e=Object.keys(bossResearch).reduce((t,e)=>t+(bossResearch[e].isUnlocked?1:0),0),i=Math.floor(baseBossDefault.unlockCost+16*e-t);return Math.max(1,i)}function unlock(t){let e=document.getElementById(t),i=e.getAttribute("unlockType"),n=e.getAttribute("unlockCategory");switch(n){case"Minion":unlockMinion(i);break;case"Boss":unlockBoss(i);break;case"Gauge":unlockGauge(i);break;default:console.warn("Unknown category:"+n)}}function unlockMinion(t){let e=unlockMinionCost(t);if(minionResearch[t].isUnlocked)return;let i=!1;0==minionResearch[t].unlockT&&resources.a.amt>=e&&(resources.a.amt-=e,i=!0,0===e&&0===achievements.prestige0.count&&addHilite("btnMnuMinions",1/0)),1==minionResearch[t].unlockT?resources.b.amt>=e&&(resources.b.amt-=e,i=!0):2==minionResearch[t].unlockT&&resources.c.amt>=e&&(resources.c.amt-=e,i=!0),i&&(minionResearch[t].isUnlocked=1)}function unlockBoss(t){let e=bossResearch[t];if(null==e||e.isUnlocked)return;let i=unlockBossCost();!(resources.d.amt<i)&&(resources.d.amt-=i,e.isUnlocked=1)}function unlockGauge(t){let e=gauges[t];if(null==e||e.isUnlocked)return;let i=gauges.Range.cost;!(resources.b.amt<i)&&(resources.b.amt-=i,e.isUnlocked=1)}function unlockAutobuy(t,e){if(!tierMisc["t"+t].autobuy.isUnlocked)switch(e||(e=getAutobuyCost(t)),t){case 0:resources.b.amt>=e&&(resources.b.amt-=e,tierMisc.t0.autobuy.isUnlocked=1);break;case 1:resources.c.amt>=e&&(resources.c.amt-=e,tierMisc.t1.autobuy.isUnlocked=1);break;case 2:resources.d.amt>=e&&(resources.d.amt-=e,tierMisc.t2.autobuy.isUnlocked=1);break;case 3:resources.e.amt>=e&&(resources.e.amt-=e,tierMisc.t3.autobuy.isUnlocked=1);break;default:console.warn("Unknown unlock autobuy:'"+type+"'")}}function upgradePotency(t,e){switch(e||(e=getPotencyCost(t)),t){case 0:resources.b.amt>=e&&(resources.b.amt-=e,tierMisc.t0.upgradePotency++);break;case 1:resources.c.amt>=e&&(resources.c.amt-=e,tierMisc.t1.upgradePotency++);break;case 2:resources.d.amt>=e&&(resources.d.amt-=e,tierMisc.t2.upgradePotency++);break;case 3:resources.e.amt>=e&&(resources.e.amt-=e,tierMisc.t3.upgradePotency++)}}function prestige(t){let e=document.getElementById(t),i=Number(e.getAttribute("tier"));prestigeTier(i)}function prestigeTier(t){switch(t){case 0:{let e=getPrestigeCost(0);resources.a.amt>=e&&(0==achievements.prestige0.count&&(addHilite("btnMnuGym",1/0),addHilite("btnMnuAchievements",1/0),addHilite("divT1Resource",10)),resources.b.amt+=getPrestigeGain(0),resetT0(),achievements.prestige0.count++,boss=null);break}case 1:{let i=getPrestigeCost(1);resources.b.amt>=i&&(0==achievements.prestige1.count&&(addHilite("btnMnuLab",1/0),addHilite("btnMnuStatistics",1/0),addHilite("divT2Resource",10)),resources.c.amt+=getPrestigeGain(1),resetT1(),achievements.prestige1.count++);break}case 2:{let n=getPrestigeCost(2);resources.c.amt>=n&&(0==achievements.prestige2.count&&(addHilite("btnMnuBosses",1/0),addHilite("btnMnuOffice",1/0),addHilite("divT3Resource",10)),resources.d.amt+=getPrestigeGain(2),resetT2(),achievements.prestige2.count++);break}case 3:{let a=getPrestigeCost(3);resources.d.amt>=a&&(0==achievements.prestige3.count&&(addHilite("btnMnuForge",1/0),addHilite("divT4Resource",10)),resources.e.amt+=getPrestigeGain(3),resetT3(),achievements.prestige3.count++);break}default:console.warn("Unknown prestige:'"+t+"'")}}function GetMiscCost(t,e){switch(t=t.split("_")[0]){case"moneyPit":return getMoneyPitCost();case"maxMinions":return getMaxMinionCost();case"upgradePotency":return getPotencyCost(e-1);case"autoBuy":return getAutobuyCost(e-1);case"upgradeLimit":return getMaxUpgradeLevelCost();case"reduceDeployTime":return getGlobalSpawnDelayReductionCost();case"autoSell":return getAutoSellCost();case"autoForge":return getAutoForgeCost();case"startingLevel":return getRestartLevelCost();default:console.warn("Unknown cost:'"+t+"'"),console.trace()}return -1}function buy(t,e){let i=document.getElementById(t),n=i.getAttribute("purchaseType").split("_")[0],a=Number(i.getAttribute("tier")),o=GetMiscCost(n,a);switch(n){case"moneyPit":resources.a.amt>=o&&(resources.a.amt-=o,moneyPitLevel++);break;case"maxMinions":resources.b.amt>=o&&(resources.b.amt-=o,maxMinions++);break;case"autoBuy":unlockAutobuy(a-1,o);break;case"upgradePotency":upgradePotency(a-1,o);break;case"upgradeLimit":resources.c.amt>=o&&(resources.c.amt-=o,maxUpgradeLevel++);break;case"reduceDeployTime":resources.d.amt>=o&&(resources.d.amt-=o,globalSpawnDelayReduction++);break;case"autoSell":resources.e.amt>=o&&(resources.e.amt-=o,maxAutosellLimit+=100,getUIElement("autoSellLimit").max=maxAutosellLimit,setElementTextById("maxAutosell",maxAutosellLimit));break;case"autoForge":resources.e.amt>=o&&(resources.e.amt-=o,maxAutoForgeLimit+=100,getUIElement("autoForgeLimit").max=maxAutoForgeLimit,setElementTextById("maxAutoForge",maxAutoForgeLimit));break;case"startingLevel":resources.e.amt>=o&&(resources.e.amt-=o,maxResetLevel++,getUIElement("startingLevelSelector").max=maxResetLevel,10==maxResetLevel&&(resources.f.amt+=64));break;default:console.warn("Unknown buy:'"+n+"'"+e),console.trace()}updatePnl1()}function upgrade(t){let e=document.getElementById(t),i=e.getAttribute("minionType"),n=e.getAttribute("upgradeType");buyUpgrade(i,n)}function buyUpgrade(t,e){let i=getUpgradeCost(t,e);i<0&&console.error(`Unable to upgrade:${t}:${e}`);let n=getUpgradeTier(e);0==n?resources.a.amt>=i&&(resources.a.amt-=i,minionUpgrades[t][e]++):1==n?resources.b.amt>=i&&(resources.b.amt-=i,minionUpgrades[t][e]++):2==n?resources.c.amt>=i&&(resources.c.amt-=i,minionUpgrades[t][e]++):3==n&&resources.d.amt>=i&&(resources.d.amt-=i,minionUpgrades[t][e]++)}function enhance(t){let e=document.getElementById(t),i=e.getAttribute("bossType"),n=e.getAttribute("upgradeType");enhanceBoss(i,n)}function enhanceBoss(t,e){let i=getEnhanceCost(t,e);resources.d.amt>=i&&(resources.d.amt-=i,bossUpgrades[t][e]++)}function upgradeItemAttr(t,e){let i=inventory.find(e=>e.id==t),n="stat"==e?i.stat:i.attributes[e];if(n.power>=n.range.max)return;let a=n.range.upgradePrice();if(a>resources.e.amt)return;let o=n.range.step();resources.e.amt-=a;let l=Math.floor((n.power+o)*100)/100;if(n.power=Math.min(n.range.max,l),n.range.max==n.power){tierUnlocked(5)||(addHilite("btnMnuStore",1/0),addHilite("divT5Resource",10));let c=getEquippedEffect("f","gain");resources.f.amt+=(i.tier+1+c.a)*c.m}populateForgeAttributes(),i.updateHtml("inv"),i.isEquipped()&&i.updateHtml("eq");let r=getUIElement("ddlForgeItems").selectedOptions[0];setElementText(r,i.toString())}function prestigeItemAttr(t,e){if("stat"==e)return;let i=inventory.find(e=>e.id==t),n=i.attributes[e],a=Math.max(0,i.maxAttrIndex()+n.indexAdjustment);if(n.range.index>=a)return;let o=n.range.prestigePrice();if(o>resources.e.amt)return;n.range.index++,resources.e.amt-=o,n.range.recalculate(),populateForgeAttributes(),i.updateHtml("inv"),i.isEquipped()&&i.updateHtml("eq");let l=getUIElement("ddlForgeItems").selectedOptions[0];setElementText(l,i.toString())}function rerollItemAttr(t,e){if("stat"==e||e<0)return;let i=inventory.find(e=>e.id==t);if(e>i.attributes.length-1)return;let n=i.rerollAttrCost();if(n>resources.e.amt)return;let a=attributeFactory(i.tier,i.type);i.attributes[e]=a,resources.e.amt-=n,populateForgeAttributes(),i.updateHtml("inv"),i.isEquipped()&&i.updateHtml("eq");let o=getUIElement("ddlForgeItems").selectedOptions[0];setElementText(o,i.toString())}function prestigeItem(){let t=getUIElement("ddlForgeItems"),e=t?.value;null!=e&&"null"!=e&&prestigeItemByID(e)}function prestigeItemByID(t){let e=inventory.find(e=>e.id==t);if(!e.canPrestige())return;let i=getDiscount(5),n=e.prestigeCost();if((n=Math.max(1,n-i))>resources.e.amt)return;let a=Math.min(7,e.tier+1);items["t"+a][e.type];let o=getItem(a,e.type);for(;itemTier["t"+a].attrCount>e.attributes.length;)e.attributes.push(attributeFactory(a,e.type));resources.e.amt-=n,e.tier++,e.name=o,e.stat.range.index++,e.stat.range.recalculate(),populateForgeItems(),achievements.itemPrestiged.count++,e.updateHtml("inv"),e.isEquipped()&&e.updateHtml("eq")}function getChestCost(){let t=+getUIElement("numStoreChestLevel").value,e=getDiscount(5);return Math.max(1,(t+3)**2-e)}function openChest(){let t=getChestCost();if(t>resources.f.amt)return;resources.f.amt-=t;let e=+getUIElement("numStoreChestLevel").value+getAchievementBonus("bossesSummoned");null!=newItemPreview&&sellNewItem();let i=getUIElement("itemPreview");clearChildren(i),(newItemPreview=itemFactory(4*e)).buildHtml(i,"preview"),setElementTextById("newItemSellValue",newItemPreview.sellValue()),toggleUIElementByID("divChestResult",!1),toggleUIElementByID("fullInventory",inventory.length<maxInventory),toggleUIElementByID("buyBackFullInventory",!0)}function keepItem(){if(inventory.length>=24){toggleUIElementByID("buyBackFullInventory",!1);return}setElementTextById("inventoryCount",inventory.length),newItemPreview.isLocked=!0,inventory.push(newItemPreview),newItemPreview=null;let t=getUIElement("itemPreview");clearChildren(t),toggleUIElementByID("fullInventory",!0),toggleUIElementByID("divChestResult",!0)}function sellNewItem(){let t=getEquippedEffect("e","gain");resources.e.amt+=(newItemPreview.sellValue()+t.a)*t.m,newItemPreview=null;let e=getUIElement("itemPreview");clearChildren(e),toggleUIElementByID("fullInventory",!0),toggleUIElementByID("divChestResult",!0)}function exchange(t){!(resources.f.amt<10)&&(resources[t.rType].amt+=+t.value,resources.f.amt-=10)}const twoPi=2*Math.PI,halfPi=Math.PI/2;function point(t,e){this.x=t||0,this.y=e||0}function start(){document.getElementById("paused").classList.add("hide"),paused=!1,setAchievementInterval(503),setBuySellInterval(211),setSaveInterval(601),requestAnimationFrame(drawUnits),setP1Rate(),mainCycle||(mainCycle=setInterval(update,3))}function setAchievementInterval(t){if(t<=0){console.warn("Invalid achievement interval");return}achievementCycle&&(clearInterval(achievementCycle),achievementCycle=0),achievementCycle=setInterval(updateAchievements,t)}function setBuySellInterval(t){if(t<=0){console.warn("Invalid buy/sell interval");return}autoBuySellCycle&&(clearInterval(autoBuySellCycle),autoBuySellCycle=0),autoBuySellCycle=setInterval(autoBuySell,t)}function setSaveInterval(t){if(t<=0){console.warn("Invalid save interval");return}autoSaveCycle&&(clearInterval(autoSaveCycle),autoSaveCycle=0),autoSaveCycle=setInterval(updateAutosave,t)}function setP1Rate(){let t=getP1Rate();if(clearInterval(p1Cycle),p1Cycle=0,0===t){toggleUIElement(reshowP1,!1),toggleUIElement(pnl1,!0);return}toggleUIElement(reshowP1,!0),toggleUIElement(pnl1,!1),setP1Interval(t)}function setP0Interval(t){if(0==t){console.warn("Invalid p0 interval");return}p0Cycle&&(clearInterval(p0Cycle),p0Cycle=0),p0Cycle=setInterval(updateP0,t)}function setP1Interval(t){if(0==t){console.warn("Invalid p1 interval");return}p1Cycle&&(clearInterval(p1Cycle),p1Cycle=0),p1Cycle=setInterval(updateP1,t)}function stop(){document.getElementById("paused").classList.remove("hide"),paused=!0,clearInterval(achievementCycle),achievementCycle=0,clearInterval(autoBuySellCycle),autoBuySellCycle=0,clearInterval(autoSaveCycle),autoSaveCycle=0,clearInterval(p0Cycle),p0Cycle=0,clearInterval(p1Cycle),p1Cycle=0,clearInterval(mainCycle),mainCycle=0}function getScale(){return(pathL+pathW)/2}function calcMove(t,e,i){if(e.equals(i))return i;let n=i.x-e.x,a=i.y-e.y,o=t/(n**2+a**2)**.5,l=n*o,c=a*o,r=e.x+l,s=e.y+c;return Math.abs(n)<=Math.abs(l)&&Math.abs(a)<=Math.abs(c)?i:new point(r,s)}function buildDictionary(t,e,i){let n={};for(let a=0;a<t.length;a++)n[t[a][e]]=t[a][i];return n}function clearChildren(t){for(;t.firstChild;)t.removeChild(t.firstChild)}function calcDistance(t,e){let i=t.x-e.x,n=t.y-e.y;return(i**2+n**2)**.5}function nanAdd(t,e){return isNaN(t)?e:isNaN(e)?t:t+e}function nanMult(t,e){return isNaN(t)?e:isNaN(e)?t:t*e}function nanMax(t,e){return isNaN(t)?e:isNaN(e)?t:Math.max(t,e)}function inRange(t,e,i){let n=t.x-e.x,a=t.y-e.y;return n**2+a**2<=i**2}function getRandomInt(t,e){return t=Math.ceil(t),Math.floor(Math.random()*((e=Math.floor(e))-t))+t}function getRandomIntExclusions(t,e,i){if(null==i)return getRandomInt(t,e);let n=0;if(Array.isArray(i))for(let a=0;a<i.length;a++)i[a].min=Math.max(t,i[a].min),i[a].min=Math.min(e,i[a].min),i[a].max=Math.max(t,i[a].max),i[a].max=Math.min(e,i[a].max),n+=i[a].max-i.min;else i.min=Math.max(t,i.min),i.min=Math.min(e,i.min),i.max=Math.max(t,i.max),i.max=Math.min(e,i.max),n=i.max-i.min;let o=getRandomInt(t,e-=n);if(Array.isArray(i))for(let l=0;l<i.length;l++)o>i[l].min&&(o+=i[l].max-i[l].min);else o>i.min&&(o+=i.max-i.min);return o}function fileExists(t){var e=new XMLHttpRequest;try{e.open("HEAD",t,!1),e.send()}catch{}return 404!=e.status}function getMaxUpgradeLevel(){let t=getEquippedEffect("All",tierMisc.t2.miscUpgrades.upgradeLimit_2);return(maxUpgradeLevel+t.a)*t.m}function pickAKey(t){let e=Object.keys(t),i=getRandomInt(0,e.length),n=t[e[i]];return n}function pickOne(t){let e=getRandomInt(0,t.length),i=t[e];return i}point.prototype.plus=function(t){let e=t?.x||0,i=t?.y||0;return new point(this.x+e,this.y+i)},point.prototype.equals=function(t){let e=t?.x||0,i=t?.y||0;return this.x===e&&this.y===i};const PathsPerLevel=64;function getLevelAtPathCount(t){return Math.floor(t/64)}function getLevelSpan(){return 64*pathL}function LevelToTotalPaths(t){return 64*t}function getEndOfLevelX(t){let e=(+t+1)*64-totalPaths;return e*pathL}function unitArrayOrderByLocationX(t){let e=t.length,i=Array(e);for(let n=0;n<e;++n)i[n]=n;return i.sort(function(e,i){return t[e].Location.x<t[i].Location.x?1:t[e].Location.x>t[i].Location.x?-1:0}),i}function isInEllipse(t,e,i,n){i=i**2,n=n**2;let a=n*(t.x-e.x)**2,o=i*(t.y-e.y)**2,l=i*n;return a+o<=l}function getPathYatX(t){let e=1;for(;path[e].x<t&&e<path.length-1;)e++;let i=path[e-1].x,n=path[e].x,a=path[e-1].y,o=path[e].y;return a==o||t==i?a:t==n?o:a+(t-i)*((a-o)/(i-n))}String.prototype.fixString=function(){let t=this.charAt(0).toUpperCase()+this.slice(1);return t.replace(/([A-Z])/g," $1").trim()},String.prototype.unfixString=function(){let t=this.charAt(0).toLowerCase()+this.slice(1);return t.replace(/\s/g,"")};const rangeTypes={a:"a",m:"m"};function Range(t,e){this.type=t||rangeTypes.a,this.index=Math.max(e||0,0);let i=e+1;this.min=Math.floor(1+e+e*e*.1),this.max=Math.floor(1+i+i*i*.1),this.type==rangeTypes.m?(this.min=1+this.min/10,this.max=1+this.max/10):(this.min*=2,this.max*=2)}function statFactory(t,e,i){let n=getItemStatRangeIndex(t,e,i),a=new Range(rangeTypes.a,n);return new Stat(itemType[e].stat,a)}function Stat(t,e){this.attr=t,this.power=e.min,this.range=e}function getItemStatRangeIndex(t,e,i){let n=t;return n+=itemType[e].rangeAdjustment||0,Math.max(n+=items["t"+Math.min(7,t)][e][i].rangeAdjustment||0,0)}function getItemStatRange(t,e){return new Range(rangeTypes[t],e)}Range.prototype.recalculate=function(){let t=this.index+1;this.min=Math.floor(1+this.index+this.index*this.index*.1),this.max=Math.floor(1+t+t*t*.1),this.type==rangeTypes.m?(this.min=1+this.min/10,this.max=1+this.max/10):(this.min*=2,this.max*=2)},Range.prototype.delta=function(){return this.max-this.min},Range.prototype.step=function(){let t=this.index,e=this.delta()/t;return Math.floor(100*e)/100},Range.prototype.score=function(t){return t===this.max?100:0>=this.delta()?0:(t-this.min)*100/this.delta()},Range.prototype.upgradePrice=function(){let t=getDiscount(4),e=this.index;return Math.max(1,Math.floor(e**1.25+e**.5)-t)},Range.prototype.prestigePrice=function(){let t=getDiscount(4),e=this.index+1;return Math.max(1,Math.floor(e**1.25)-t)},Stat.prototype.score=function(){return this.range.score(this.power)},Stat.prototype.toString=function(){return backwardsStats.includes(this.attr)?this.attr.fixString()+": -"+this.power:this.attr.fixString()+": +"+this.power};const attributeTarget={self:{options:["Boss"],rangeAdjustment:0},minion:{options:["Mite","Bomber","Catapult","Golem","Harpy","Ram","Vampire","Air","Earth","Fire","Water"],rangeAdjustment:-1},invaders:{options:["Invaders"],rangeAdjustment:-2},defenders:{options:["Defenders"],rangeAdjustment:-2},currencyDiscount:{options:["a","b","c","d"],rangeAdjustment:2},currencyGain:{options:["b","c","d"],rangeAdjustment:0},allCurrency:{options:["All"],rangeAdjustment:-6},upg:{options:["All"],rangeAdjustment:-8}},defaultAttributeOptions={option0:{effectTypes:[statTypes.health],target:attributeTarget.self,rangeAdjustment:0,rangeType:rangeTypes.a}},attributeTypes={bossStat0:{dropWeight:16,itemTypes:[itemType.shield.name,itemType.torso.name,itemType.head.name,itemType.feet.name],effectTypes:[statTypes.health],target:attributeTarget.self,rangeAdjustment:0,rangeType:rangeTypes.a},bossStat1:{dropWeight:16,itemTypes:[itemType.weapon.name],effectTypes:[statTypes.damage],target:attributeTarget.self,rangeAdjustment:0,rangeType:rangeTypes.a},bossStat2:{dropWeight:8,itemTypes:[itemType.weapon.name,itemType.shield.name,itemType.torso.name,itemType.head.name,itemType.feet.name],effectTypes:[statTypes.attackDelay,statTypes.spawnDelay],target:attributeTarget.self,rangeAdjustment:0,rangeType:rangeTypes.a},bossStat3:{dropWeight:4,itemTypes:[itemType.weapon.name,itemType.shield.name,itemType.torso.name,itemType.head.name,itemType.feet.name],effectTypes:[statTypes.health],target:attributeTarget.self,rangeAdjustment:-1,rangeType:rangeTypes.m},bossStat4:{dropWeight:1,itemTypes:[itemType.weapon.name,itemType.shield.name,itemType.torso.name,itemType.head.name,itemType.feet.name],effectTypes:[statTypes.attackDelay,statTypes.spawnDelay],target:attributeTarget.self,rangeAdjustment:-2,rangeType:rangeTypes.m},bossStat5:{dropWeight:8,itemTypes:[itemType.weapon.name,itemType.shield.name,itemType.torso.name,itemType.head.name,itemType.feet.name,itemType.shield.name,itemType.head.name],effectTypes:[statTypes.auraRange,statTypes.auraPower],target:attributeTarget.self,rangeAdjustment:0,rangeType:rangeTypes.a},minionStat0:{dropWeight:16,itemTypes:[itemType.weapon.name,itemType.shield.name,itemType.torso.name,itemType.head.name,itemType.feet.name,itemType.legs.name],effectTypes:[statTypes.health,statTypes.damage],target:attributeTarget.minion,rangeAdjustment:0,rangeType:rangeTypes.a},minionStat1:{dropWeight:8,itemTypes:[itemType.weapon.name,itemType.shield.name,itemType.torso.name,itemType.head.name,itemType.feet.name,itemType.legs.name],effectTypes:[statTypes.moveSpeed,statTypes.attackDelay,statTypes.spawnDelay],target:attributeTarget.minion,rangeAdjustment:0,rangeType:rangeTypes.a},minionStat2:{dropWeight:4,itemTypes:[itemType.weapon.name,itemType.shield.name,itemType.torso.name,itemType.head.name,itemType.feet.name,itemType.legs.name],effectTypes:[statTypes.health],target:attributeTarget.minion,rangeAdjustment:-2,rangeType:rangeTypes.m},minionStat3:{dropWeight:2,itemTypes:[itemType.weapon.name,itemType.shield.name,itemType.torso.name,itemType.head.name,itemType.feet.name,itemType.legs.name],effectTypes:[statTypes.attackDelay,statTypes.spawnDelay],target:attributeTarget.minion,rangeAdjustment:-2,rangeType:rangeTypes.m},minionStat4:{dropWeight:1,itemTypes:[itemType.weapon.name,itemType.shield.name,itemType.torso.name,itemType.head.name,itemType.feet.name,itemType.legs.name],effectTypes:[statTypes.minionsPerDeploy],target:attributeTarget.minion,rangeAdjustment:-12,rangeType:rangeTypes.a},allStat0:{dropWeight:2,itemTypes:[itemType.amulet.name,itemType.trinket.name],effectTypes:[statTypes.attackRange,statTypes.health,statTypes.damage],target:attributeTarget.invaders,rangeAdjustment:-1,rangeType:rangeTypes.a},allStat1:{dropWeight:2,itemTypes:[itemType.amulet.name,itemType.trinket.name],effectTypes:[statTypes.attackDelay,statTypes.spawnDelay],target:attributeTarget.invaders,rangeAdjustment:-4,rangeType:rangeTypes.m},allStat2:{dropWeight:2,itemTypes:[itemType.amulet.name,itemType.trinket.name],effectTypes:[statTypes.health],target:attributeTarget.invaders,rangeAdjustment:-4,rangeType:rangeTypes.m},resource0:{dropWeight:16,itemTypes:[itemType.weapon.name,itemType.shield.name,itemType.head.name],effectTypes:["discount"],target:attributeTarget.currencyDiscount,rangeAdjustment:0,rangeType:rangeTypes.a},resource1:{dropWeight:4,itemTypes:[itemType.amulet.name,itemType.trinket.name],effectTypes:["discount"],target:attributeTarget.allCurrency,rangeAdjustment:-8,rangeType:rangeTypes.a},resource2:{dropWeight:16,itemTypes:[itemType.weapon.name,itemType.shield.name,itemType.head.name],effectTypes:["gain"],target:attributeTarget.currencyGain,rangeAdjustment:0,rangeType:rangeTypes.a},resource3:{dropWeight:4,itemTypes:[itemType.amulet.name,itemType.trinket.name],effectTypes:["gain"],target:attributeTarget.allCurrency,rangeAdjustment:-8,rangeType:rangeTypes.a},allUpg:{dropWeight:8,itemTypes:[itemType.trinket.name,itemType.amulet.name],effectTypes:[tierMisc.t1.miscUpgrades.maxMinions_1,tierMisc.t2.miscUpgrades.upgradeLimit_2,tierMisc.t3.miscUpgrades.reduceDeployTime_3],target:attributeTarget.self,rangeAdjustment:-4,rangeType:rangeTypes.a}};function buildItemAttributes(t,e){let i=[],n=itemTier["t"+Math.min(t,7)].attrCount;if(0==n)return i;for(let a=0;a<n;a++)i.push(attributeFactory(t,e));return i}function attributeFactory(t,e){let i=getWeightedAttributeTypes(e);(null==i||0==i.length)&&(i=defaultAttributeOptions);let n=attributeTypes[pickAKey(i)],a=pickOne(n.effectTypes),o=n.target,l=n.rangeAdjustment+o.rangeAdjustment+itemType[e].rangeAdjustment,c=getItemAttrRangeIndex(t,e,l),r=new Range(n.rangeType,c),s=pickOne(o.options),h=new Attribute(a,s,r,l);return h}function Attribute(t,e,i,n){this.effect=t,this.target=e,this.range=i,this.power=i.min,this.indexAdjustment=n}function getWeightedAttributeTypes(t){let e=[];for(let i in attributeTypes)if(attributeTypes[i].itemTypes.includes(t))for(let n=0;n<attributeTypes[i].dropWeight;n++)e.push(i);return e}function getItemAttrRangeIndex(t,e,i){let n=t-2;return n+=itemType[e].rangeAdjustment||0,Math.max(n+=i||0,0)}function getItemTierChances(t){let e=Math.max(0,getRarityBoost()+(t>>2))-2,i=[],n=Math.max(0,.1*e),a=.25*e+2,o=a-n,l=n,c=0;for(;l<a;){let r=l,s=Math.ceil(l);s=Math.min(s=s==r?r+1:s,a);let h=s-r,u=h/o;c+=u,i.push({tier:Math.floor(r),pct:u,sum:c}),l=s}return i[i.length-1].sum=1,i}function getItemTier(t){let e=Math.random(),i=getItemTierChances(t),n=i.find(t=>t.sum>e);return n.tier}function getItemType(t){let e=[];for(let i in isNaN(t)||(t="t"+Math.min(7,t)),items[t]){let n=itemType[i].dropWeight||1;for(let a=0;a<n;a++)e.push(i)}let o=getRandomInt(0,e.length);return e[o]}function getItem(t,e){let i=[];for(let n in isNaN(t)||(t="t"+Math.min(t,7)),items[t][e]){let a=items[t][e].dropWeight||1;for(let o=0;o<a;o++)i.push(n)}let l=getRandomInt(0,i.length);return i[l]}function itemFactory(t){let e=getItemTier(t),i=getItemType(e),n=getItem(e,i),a=buildItemAttributes(e,i);return new Item(e,i,n,a)}function Item(t,e,i,n){this.tier=t,this.name=i,this.type=e,this.stat=statFactory(t,e,i),this.attributes=n,this.scrapValue=Math.floor((this.score()>>7)+1),this.id=generateItemUid(e.charAt(0))}function loadItem(t){let e=[];for(let i=0;i<t.a.length;i++){let n=new Range(t.a[i].r,t.a[i].i),a=new Attribute(t.a[i].e,t.a[i].t,n);a.power=t.a[i].p,a.indexAdjustment=t.a[i].a||0,e.push(a)}let o=new Item(t.r,t.t,t.n,e);o.stat.power=t.p,o.isLocked=!!t.l,inventory.push(o),t.e&&equip(o.id)}function generateItemUid(t){let e="I_"+new Date%1e4+t,i=0,n=inventory.filter(t=>t.id==e+i);for(;n.length;)i++,n=inventory.filter(t=>t.id===e+i);return e+i}function getRerollAttrCost(t){let e=getDiscount(4);return Math.floor(Math.max(1,1.5*t-e))}Attribute.prototype.score=function(){return this.range.score(this.power)},Attribute.prototype.toString=function(){let t=resources[this.target]?.name??this.target,e=backwardsStats.includes(this.effect),i=this.range.type==rangeTypes.a;return t+" "+this.effect.fixString()+": "+(i?e?"-":"+":e?"/":"*")+this.power},Attribute.prototype.buildSave=function(){let t={};return t.t=this.target,t.e=this.effect,t.p=this.power,t.r=this.range.type,t.i=this.range.index,t.a=this.indexAdjustment,t},Item.prototype.score=function(){let t=this.stat.score();for(let e=0;e<this.attributes.length;e++){let i=Math.max(0,this.maxAttrIndex()+this.attributes[e].indexAdjustment),n=100*this.attributes[e].range.index/(i+1),a=this.attributes[e].score()/(i+1);t+=n+a}return t/=this.attributes.length+1,Math.max(1,Math.floor(t+=100*this.tier))},Item.prototype.toString=function(){let t=this.type+" : "+this.name+" ("+this.score()+")";return t+=this.isLocked?"*":" ",t=(this.isEquipped()?"[E] ":"")+t},Item.prototype.isEquipped=function(){return null!=equipped[this.type]&&equipped[this.type].id===this.id},Item.prototype.sellValue=function(){let t=getEquippedEffect("e","gain"),e=this.score()/100,i=e**2/4+4*e;return i+=getAchievementBonus("itemScrapped"),i+=t.a,Math.floor(i*=t.m)},Item.prototype.maxAttrIndex=function(){return this.tier+5},Item.prototype.canPrestige=function(){if(this.stat.power<this.stat.range.max)return!1;for(let t of this.attributes){let e=this.maxAttrIndex()+t.indexAdjustment;if(t.range.index<e||t.power<t.range.max)return!1}return!0},Item.prototype.prestigeCost=function(){let t=getDiscount(5),e=this.tier;return Math.max(1,Math.floor(e**1.5+1.5)-t)},Item.prototype.rerollAttrCost=function(){return getRerollAttrCost(this.maxAttrIndex())},Item.prototype.updateSellValue=function(){let t="Sell:"+this.sellValue()+resources.e.symbol,e=document.getElementById("btnSell"+this.id);e&&setElementText(e,t)};const itemColorClass=function(t){return t<100?"itemT0":t<200?"itemT1":t<300?"itemT2":t<400?"itemT3":t<500?"itemT4":t<600?"itemT5":t<700?"itemT6":t<800?"itemT7":t<900?"itemT8":t<1e3?"itemT9":t<1100?"itemT10":"itemT11"};function ManageAccents(){for(let t=0;t<accents.length;t++)accents[t].Location.x<path[0].x&&(accents.splice(t,1),t--)}function Accent(t,e){this.type=t,this.loc=e}function addAccent(){let t=["pebble0","pebble1","pebble2","pebble3"],e=Math.max(...accents.map(t=>t.loc.x),0)+gameW/50,i=1.2*pathW,n=1.3*i,a=getRandomInt(-n,n),o=t[0];o=Math.abs(a)<i/2?pickOne(t):pickOne(["grass0","grass1","grass2","grass3"]);let l=new point(e,a);accents.push(new Accent(o,l))}function drawPath(){if(0!==path.length){if(Quality>=2&&!isColorblind()){let t=.6*pathW,e=["9","A","A","B","C"],i=["9","8","7"],n=["4","5"],a=totalPaths%2+1;for(let o=a;o<path.length;o+=2){let l=o+totalPaths,c=e[l%e.length],r=i[l%i.length],s=n[l%n.length];mctx.fillStyle=`#${c}${r}${s}7`,mctx.beginPath(),mctx.ellipse(path[o].x,path[o].y,pathW,t,0,0,2*Math.PI),mctx.fill()}}mctx.lineWidth=pathW,mctx.strokeStyle="#B85",isColorblind()&&(mctx.strokeStyle=GetColorblindColor());for(let h=0;h<4;h++){mctx.beginPath(),mctx.moveTo(path[0].x,path[0].y);for(let u=h;u<path.length;u+=4)mctx.lineTo(path[u].x,path[u].y);mctx.stroke()}}}function drawAccents(t){!(3!==Quality||isColorblind())&&accents.forEach(e=>e.draw(t))}function drawHUD(){let t=getPathYatX(leaderPoint);if(mctx.strokeStyle="#F001",isColorblind()&&(mctx.strokeStyle=GetColorblindColor()),mctx.beginPath(),mctx.lineWidth=1,mctx.moveTo(leaderPoint,t-pathW/2),mctx.lineTo(leaderPoint,t+pathW/2),mctx.stroke(),isUIElementHiddenByID("divBossArea")){let e=getBossMoveTarget();if(mctx.beginPath(),mctx.moveTo(e.x,0),mctx.lineTo(e.x,pathW),mctx.moveTo(e.x-pathW/4,pathW/2),mctx.lineTo(e.x,pathW),mctx.lineTo(e.x+pathW/4,pathW/2),mctx.stroke(),boss){let i=isColorblind()?GetColorblindColor():boss.color;mctx.beginPath(),mctx.fillStyle=i,mctx.font="bold 20pt Arial";let n=ctx.measureText(boss.symbol);mctx.fillText(boss.symbol,e.x-n.width/2,20),mctx.font="bold 12pt Arial"}}}function drawLevelEnd(t){let e=achievements.maxLevelCleared.maxCount%4;switch(e){case 0:default:drawTentEnd(t);break;case 1:drawCabinEnd(t);break;case 2:drawFortEnd(t);break;case 3:drawCastleEnd(t)}}function drawLevelFlag(t,e,i,n,a,o){mctx.beginPath(),mctx.fillStyle=a,mctx.font="bold "+(t/4-3)+"pt Arial";let l=t/4,c=3*ctx.measureText(n).width,r=e+2,s=i-3*l,h=1.5*c,u=l/2;mctx.beginPath(),mctx.fillRect(r,s+l/2,c,l),mctx.fillStyle=a,mctx.moveTo(r,s),mctx.lineTo(r+h,s+u),mctx.lineTo(r+c,s+2*u),mctx.lineTo(r+h,s+3*u),mctx.lineTo(r,s+4*u),mctx.fill(),mctx.beginPath(),mctx.lineWidth=2,mctx.strokeStyle=o,mctx.moveTo(e,i),mctx.lineTo(e,s-1),mctx.stroke(),mctx.beginPath(),mctx.fillStyle=o,mctx.fillText(n,r+c/4,s+3*u),mctx.closePath()}function drawTentEnd(t){let e=endZoneStartX(),i=levelEndX,n=t,a=gameH-1.5*n,o=isColorblind()?"#555":"#950",l=isColorblind()?"#777":"#B71",c="#000",r=null!=hero?hero.color:null!=squire?squire.color:null!=page?page.color:"#777",s=isColorblind()?GetColorblindBackgroundColor():r,h=isColorblind()?GetColorblindColor():"#000";drawTent(t,e,a,[o,l,c]),drawLevelFlag(t,e,a,level,s,h);let u=getPathYatX(i);drawTent(t,i,u,[o,l,c]),!(Quality<2)&&(drawTent(t,e,n,[o,l,c]),drawTent(t,i,n,[o,l,c]),drawTent(t,i,a,[o,l,c]),drawLevelFlag(t,e,n,level,s,h),drawLevelFlag(t,i,n,level,s,h),drawLevelFlag(t,i,a,level,s,h))}function drawTent(t,e,i,n){let a=t/2,o=1.4*a,l=2*o,c=o/3;mctx.fillStyle=n[0],mctx.beginPath(),mctx.moveTo(e,i),mctx.lineTo(e-a,i-o),mctx.lineTo(e-a,i+o),mctx.closePath(),mctx.fill(),mctx.fillStyle=n[1],mctx.beginPath(),mctx.moveTo(e,i),mctx.lineTo(e-a,i-o),mctx.lineTo(e+(l-a),i-o),mctx.lineTo(e+l,i),mctx.lineTo(e+(l-a),i+o),mctx.lineTo(e-a,i+o),mctx.closePath(),mctx.fill(),mctx.fillStyle=n[2],mctx.strokeStyle=n[2]+"4",mctx.lineWidth=2,mctx.beginPath(),mctx.moveTo(e,i),mctx.lineTo(e+l,i),mctx.stroke(),mctx.beginPath(),mctx.moveTo(e-a/4,i),mctx.lineTo(e-a+1,i-c),mctx.lineTo(e-a+1,i+c),mctx.closePath(),mctx.fill()}function drawCabinEnd(t){let e=endZoneStartX(),i=levelEndX,n=t,a=gameH-1.5*n,o=isColorblind()?"#555":"#950",l=isColorblind()?"#777":"#630",c=isColorblind()?"#000":"#410",r=null!=hero?hero.color:null!=squire?squire.color:null!=page?page.color:"#777",s=isColorblind()?GetColorblindBackgroundColor():r,h=isColorblind()?GetColorblindColor():"#000";drawCabin(t,e,a,[o,l,c]),drawLevelFlag(t,e,a,level,s,h);let u=getPathYatX(i);drawCabin(t,i,u,[o,l,c]),!(Quality<2)&&(drawCabin(t,e,n,[o,l,c]),drawCabin(t,i,n,[o,l,c]),drawCabin(t,i,a,[o,l,c]),drawLevelFlag(t,e,n,level,s,h),drawLevelFlag(t,i,n,level,s,h),drawLevelFlag(t,i,a,level,s,h))}function drawCabin(t,e,i,n){let a=t/2,o=1.5*a,l=2*o,c=.7*a,r=o/4,s=a/4,h=.9*o,u=a/7;mctx.fillStyle=n[0],mctx.beginPath(),mctx.moveTo(e+1,i),mctx.lineTo(e-s+1,i-h),mctx.lineTo(e-a,i-h),mctx.lineTo(e-a,i+h),mctx.lineTo(e-s+1,i+h),mctx.closePath(),mctx.fill(),mctx.beginPath(),mctx.strokeStyle=n[1],mctx.lineWidth=u;for(let m=1;m<7;m+=2)mctx.moveTo(e-u*m,i-h),mctx.lineTo(e-u*m,i+h);mctx.stroke(),mctx.fillStyle=n[2],mctx.beginPath(),mctx.moveTo(e-a,i-r),mctx.lineTo(e-a+c,i-r),mctx.lineTo(e-a+c,i+r),mctx.lineTo(e-a,i+r),mctx.closePath(),mctx.fill(),mctx.fillStyle="#555",mctx.beginPath(),mctx.moveTo(e+l-s,i+o/2),mctx.lineTo(e+l+s,i+o/2),mctx.lineTo(e+l+s,i+o/4),mctx.lineTo(e+l-s,i+o/4),mctx.fill(),mctx.fillStyle=n[2],mctx.beginPath(),mctx.moveTo(e,i),mctx.lineTo(e-s,i-o),mctx.lineTo(e-s+l,i-o),mctx.lineTo(e+l,i),mctx.lineTo(e-s+l,i+o),mctx.lineTo(e-s,i+o),mctx.closePath(),mctx.fill(),mctx.lineWidth=1,mctx.strokeStyle="#000",mctx.beginPath(),mctx.moveTo(e,i),mctx.lineTo(e+l,i),mctx.stroke()}function drawFortEnd(t){let e=endZoneStartX(),i=levelEndX,n=t,a=gameH-n,o=isColorblind()?"#999":"#950",l=isColorblind()?"#777":"#740",c=isColorblind()?"#555":"#520",r=isColorblind()?"#333":"#410",s=null!=hero?hero.color:null!=squire?squire.color:null!=page?page.color:"#777",h=isColorblind()?GetColorblindBackgroundColor():s,u=isColorblind()?GetColorblindColor():"#000";drawFortWall(t,new point(e,n),new point(e,a),[r,c]),drawFortWall(t,new point(e,n),new point(i,n),[c,l]),drawFortWall(t,new point(e,a),new point(i,a),[c,l]),drawFortWall(t,new point(i,n),new point(i,a),[l,o]),drawFortParapet(t,e,n,[l,c,r]),drawFortParapet(t,e,a,[l,c,r]),drawFortParapet(t,i,n,[o,l,c]),drawFortParapet(t,i,a,[o,l,c]),drawLevelFlag(t,e,a,level,h,u),!(Quality<2)&&(drawLevelFlag(t,e,n,level,h,u),drawLevelFlag(t,i,n,level,h,u),drawLevelFlag(t,i,a,level,h,u))}function drawFortWall(t,e,i,n){if(mctx.beginPath(),mctx.lineWidth=t,mctx.strokeStyle=n[0],mctx.moveTo(e.x,e.y),mctx.lineTo(i.x,i.y),mctx.stroke(),Quality<2)return;let a=Math.abs(e.x-i.x),o=Math.abs(e.y-i.y);if(mctx.strokeStyle=n[1],a>o){let l=a/16;mctx.lineWidth=l;for(let c=0;c<16;c+=2)mctx.moveTo(e.x+c*l,e.y-t/2),mctx.lineTo(e.x+c*l,e.y+t/2)}else{let r=o/16;mctx.lineWidth=r;for(let s=0;s<16;s+=2)mctx.moveTo(e.x-t/2,e.y+s*r),mctx.lineTo(e.x+t/2,e.y+s*r)}mctx.stroke()}function drawFortParapet(t,e,i,n){mctx.fillStyle=n[0],mctx.beginPath(),mctx.moveTo(e,i),mctx.lineTo(e+t,i-t),mctx.lineTo(e+t,i+t),mctx.closePath(),mctx.fill(),mctx.fillStyle=n[1],mctx.beginPath(),mctx.moveTo(e,i),mctx.lineTo(e-t,i+t),mctx.lineTo(e+t,i+t),mctx.closePath(),mctx.fill(),mctx.beginPath(),mctx.moveTo(e,i),mctx.lineTo(e-t,i-t),mctx.lineTo(e+t,i-t),mctx.closePath(),mctx.fill(),mctx.fillStyle=n[2],mctx.beginPath(),mctx.moveTo(e,i),mctx.lineTo(e-t,i-t),mctx.lineTo(e-t,i+t),mctx.closePath(),mctx.fill();let a=t/4;mctx.strokeStyle="#0004",mctx.lineWidth=2,mctx.beginPath(),mctx.moveTo(e-t,i-t),mctx.lineTo(e+t,i+t),mctx.moveTo(e+t,i-t),mctx.lineTo(e-t,i+t),mctx.stroke();for(let o=0;o<5;o++)mctx.beginPath(),mctx.moveTo(e-o*a,i-o*a),mctx.lineTo(e+o*a,i-o*a),mctx.lineTo(e+o*a,i+o*a),mctx.lineTo(e-o*a,i+o*a),mctx.closePath(),mctx.stroke()}function drawCastleEnd(t){let e=endZoneStartX(),i=levelEndX,n=t,a=gameH-n;ctx.lineWidth=t;let o="#555",l="#777";drawVWall(t,e,n,[o,"#333"]),drawHWall(t,e,n,[l,o]),drawHWall(t,e,a,[l,o]),drawVWall(t,i,n,["#999",l]),drawGate(2*t,e,[o,l]);let c=isColorblind()?GetColorblindBackgroundColor():"#444",r=isColorblind()?GetColorblindColor():"#666",s=isColorblind()?GetColorblindBackgroundColor():"#888";drawParapet(t,e,n,r,c),drawParapet(t,e,a,r,c),drawParapet(t,i,n,s,r),drawParapet(t,i,a,s,r);let h=null!=hero?hero.color:null!=squire?squire.color:null!=page?page.color:"#777",u=isColorblind()?GetColorblindBackgroundColor():h,m=isColorblind()?GetColorblindColor():"#000";drawLevelFlag(t,e,a,level,u,m),!(Quality<2)&&(drawLevelFlag(t,e,n,level,u,m),drawLevelFlag(t,i,n,level,u,m),drawLevelFlag(t,i,a,level,u,m))}function drawVWall(t,e,i,n){if(isColorblind())return;let a=t,o=gameH-2*i;if(Quality<2){mctx.beginPath(),mctx.strokeStyle=n[0],mctx.moveTo(e,i),mctx.lineTo(e,i+o),mctx.stroke(),mctx.closePath();return}let l=a/8,c=1.625*l,r=Math.ceil(o/c),s=e-a/2,h=i+o;mctx.beginPath();for(let u=0;u<r;u++)for(let m=0;m<8;m++){mctx.fillStyle=n[(u+m)%n.length];let d=s+m*l,x=h-c*u;mctx.fillRect(d,x,l+1,c+1)}for(let f=1;f<r;f+=2){let g=s+8*l,p=h-c*f;mctx.fillRect(g,p,l+1,c),mctx.fillRect(g+l,p-c/4,l+1,1.5*c)}mctx.fillStyle="#F00",mctx.fillRect(s,h,10,10),mctx.closePath()}function drawHWall(t,e,i,n){if(isColorblind())return;let a=t,o=endZoneW();if(Quality<2){mctx.beginPath(),mctx.strokeStyle=n[0],mctx.moveTo(e,i),mctx.lineTo(e+o,i),mctx.stroke(),mctx.closePath();return}let l=a/8,c=1.625*l,r=Math.ceil(o/c),s=e,h=i+a/2;mctx.beginPath();for(let u=0;u<r;u++)for(let m=0;m<8;m++){mctx.fillStyle=n[(u+m)%n.length];let d=s+c*u,x=h-m*l;mctx.fillRect(d,x,c+1,l+1)}mctx.closePath()}function drawParapet(t,e,i,n,a){if(mctx.beginPath(),mctx.fillStyle=n,mctx.arc(e,i,t,0,twoPi),mctx.fill(),Quality<2)return;let o=t/8;mctx.lineWidth=o,mctx.strokeStyle=a,mctx.moveTo(e+o,i),mctx.arc(e,i,1*o,0,twoPi),mctx.moveTo(e+3*o,i),mctx.arc(e,i,3*o,0,twoPi),mctx.moveTo(e+5*o,i),mctx.arc(e,i,5*o,0,twoPi),mctx.moveTo(e+7*o,i),mctx.arc(e,i,7*o,0,twoPi),mctx.stroke(),mctx.beginPath(),mctx.strokeStyle=n,mctx.moveTo(e,i+t),mctx.lineTo(e,i-t),mctx.moveTo(e+t,i),mctx.lineTo(e-t,i),mctx.stroke();let l=3*t/4,c=l/2;mctx.beginPath(),mctx.strokeStyle=n,mctx.moveTo(e+l,i+l),mctx.lineTo(e+c,i+c),mctx.moveTo(e+l,i-l),mctx.lineTo(e+c,i-c),mctx.moveTo(e-l,i+l),mctx.lineTo(e-c,i+c),mctx.moveTo(e-l,i-l),mctx.lineTo(e-c,i-c),mctx.stroke()}function drawGate(t,e,i){if(isColorblind())return;let n=t,a=1.4*pathW;mctx.beginPath();let o=n/16,l=1.625*o,c=Math.ceil(a/l);a=c*l;let r=e-n/2,s=getPathYatX(r)-a/2;if(Quality>=2){mctx.beginPath();for(let h=0;h<c;h++)for(let u=0;u<16;u++){mctx.fillStyle=i[(h+u)%i.length];let m=r+u*o,d=s+l*h;mctx.fillRect(m,d,o+1,l+1)}for(let x=0;x<c;x+=2){let f=r+16*o,g=s+l*x;mctx.fillRect(f,g,o+1,l),mctx.fillRect(f+o,g-l/4,o+1,1.5*l)}}mctx.beginPath(),mctx.fillStyle="#000";let p=3*a/4,y=p/2,$=e-n/2,T=getPathYatX($)-p/2;mctx.fillRect($,T,y,p),mctx.arc($+y-1,T+p/2,y,-halfPi,halfPi),mctx.fill()}function drawRuins(t){let e=achievements.maxLevelCleared.maxCount;switch(e){case 0:default:drawTentRuins(t);break;case 1:drawCabinRuins(t);break;case 2:drawFortRuins(t);break;case 3:drawCastleRuins(t)}}function drawRuinsFlag(t,e,i){mctx.save(),mctx.translate(e,i),mctx.rotate(-1),drawLevelFlag(t,0,0,+level-1,"#777","#000"),mctx.restore()}function drawTentRuins(t){if(0>=+level)return;let e=levelStartX,i=gameH-t;drawBrokenTent(t,e,i),drawRuinsFlag(t,e+t,i+3*t/4/2)}function drawBrokenTent(t,e,i){let n=isColorblind()?"#555":"#950",a=isColorblind()?"#777":"#B71",o=[n,a,"#000"],l=t/2,c=1.4*l,r=2*c,s=c/3;mctx.fillStyle=o[0],mctx.beginPath(),mctx.moveTo(e+1,i+c/2),mctx.lineTo(e-l,i-c/2),mctx.lineTo(e-l,i+c),mctx.closePath(),mctx.fill(),mctx.fillStyle=o[1],mctx.beginPath(),mctx.moveTo(e,i+c/2),mctx.lineTo(e-l,i-c/2),mctx.lineTo(e,i-c/3),mctx.lineTo(e+(r-l),i-c/2),mctx.lineTo(e+(r-1.5*l),i),mctx.lineTo(e+(r-l),i+c),mctx.lineTo(e+r/4,i+.8*c),mctx.lineTo(e-l,i+c),mctx.closePath(),mctx.fill(),mctx.fillStyle=o[2],mctx.strokeStyle=o[2]+"4",mctx.beginPath(),mctx.moveTo(e,i+c/2),mctx.lineTo(e+r/3,i+c/3),mctx.lineTo(e+r/8,i+c/5),mctx.lineTo(e+r-1.5*l,i),mctx.stroke(),mctx.beginPath(),mctx.moveTo(e-l/2,i+s),mctx.lineTo(e-l+1,i-s/2),mctx.lineTo(e-l+1,i+2*s),mctx.closePath(),mctx.fill()}function drawCabinRuins(t){if(0>=+level)return;let e=levelStartX,i=gameH-1.5*t;drawBrokenCabin(t,e,i),drawRuinsFlag(t,e-t/4,i)}function drawBrokenCabin(t,e,i){let n=isColorblind()?"#555":"#950",a=isColorblind()?"#777":"#630",o=isColorblind()?"#000":"#410",l=[n,a,o],c=t/2,r=1.5*c,s=2*r,h=.7*c,u=r/4,m=c/6,d=.9*r,x=c/7;mctx.fillStyle="#555",mctx.beginPath(),mctx.moveTo(e+s-m,i+r/2),mctx.lineTo(e+s+m,i+r/2),mctx.lineTo(e+s+m,i+r/4),mctx.lineTo(e+s-m,i+r/4),mctx.fill(),mctx.fillStyle=l[0],mctx.beginPath(),mctx.moveTo(s+e,i),mctx.lineTo(s+e-m+1,i-d),mctx.lineTo(s+e-c,i-d),mctx.lineTo(s+e-c,i+d),mctx.lineTo(s+e-m,i+d),mctx.closePath(),mctx.fill(),mctx.beginPath(),mctx.strokeStyle=l[1],mctx.lineWidth=x,mctx.moveTo(e-c,i-d),mctx.lineTo(e-c+s+c/2,i-d),mctx.moveTo(e-c,i+d),mctx.lineTo(e-c+s+c/2,i+d),mctx.stroke(),mctx.beginPath(),mctx.strokeStyle=l[1],mctx.lineWidth=x;for(let f=3;f<7;f+=2)mctx.moveTo(s+e-x*f,i-d),mctx.lineTo(s+e-x*f,i+d);mctx.stroke(),drawLogs(t,e+s/2-c/2,i,l[2]),mctx.fillStyle=l[0],mctx.beginPath(),mctx.moveTo(e,i),mctx.lineTo(e-m+1,i-d),mctx.lineTo(e-c,i-d),mctx.lineTo(e-c,i+d),mctx.lineTo(e-m,i+d),mctx.closePath(),mctx.fill(),mctx.beginPath(),mctx.strokeStyle=l[1],mctx.lineWidth=x;for(let g=3;g<7;g+=2)mctx.moveTo(e-x*g,i-d),mctx.lineTo(e-x*g,i+d);mctx.stroke(),mctx.fillStyle=GetStyleColor(),mctx.beginPath(),mctx.moveTo(e-c,i-u),mctx.lineTo(e-c+h,i-u),mctx.lineTo(e-c+h,i+u),mctx.lineTo(e-c,i+u),mctx.closePath(),mctx.fill()}function drawLogs(t,e,i,n){let a=.8*t,o=t/2,l=t/2;mctx.strokeStyle=n,mctx.lineWidth=t/8,mctx.beginPath();for(let c=0;c<12;c++){let r=e+(51*level+372*c)%o-o/2,s=i+(17*level+297*c)%a-a/2,h=r+l*Math.cos(level+c),u=s+l*Math.sin(level+c);mctx.moveTo(r,s),mctx.lineTo(h,u),mctx.stroke()}}function drawFortRuins(t){if(0>=+level)return;let e=levelStartX,i=gameH-1.5*t;drawBrokenFort(t,e,i),drawRuinsFlag(t,e,i)}function drawBrokenFort(t,e,i){let n=isColorblind()?"#999":"#950",a=isColorblind()?"#777":"#740",o=isColorblind()?"#555":"#520",l=endZoneW();mctx.lineWidth=t,mctx.strokeStyle=o,mctx.moveTo(e,i),mctx.lineTo(e-3*l/4,i),mctx.stroke(),mctx.strokeStyle=a,mctx.beginPath();let c=l/16;mctx.lineWidth=c;for(let r=1;r<12;r+=2){let s=((level+r)%3-1)*c,h=(level*r%5-2)*c;mctx.moveTo(e-r*c+s,i-t/2),mctx.lineTo(e-r*c-h,i+t/2)}mctx.stroke(),drawLogs(t,e-l/2,i+t,l/8,t/8,n),drawFortParapet(t,e,i,[n,a,o])}function drawCastleRuins(t){if(0>=+level)return;let e=levelStartX,i=gameH-t;drawBrokenCastleWall(t,e,i),drawRuinsFlag(t,e,i-t/2)}Item.prototype.buildHtml=function(t,e){let i=createNewElement("div",e+"_ItemTitle"+this.id,t,["itemTitle"],null),n=this.score(),a=itemColorClass(n);createNewElement("div",e+"_ItemName"+this.id,i,["itemName"],this.name.fixString()),createNewElement("div",e+"_ItemType"+this.id,i,["itemType",a],this.type.fixString()),createNewElement("div",e+"_ItemScore"+this.id,i,["itemScore"],n),createNewElement("span",e+"_stat"+this.id,t,["itemStat"],this.stat.toString());let o=createNewElement("ul",e+"_ulItem"+this.id,t,["itemAttributeList"],null);for(let l=0;l<this.attributes.length;l++)createNewElement("li",e+"_attr"+this.id+"_"+l,o,["itemAttributes"],this.attributes[l].toString())},Item.prototype.updateHtml=function(t){let e=document.getElementById("divItem"+this.id);if(null==e)return;setElementTextById(t+"_ItemName"+this.id,this.name.fixString()),setElementTextById(t+"_ItemType"+this.id,this.type.fixString()),setElementTextById(t+"_ItemScore"+this.id,this.score()),setElementTextById(t+"_stat"+this.id,this.stat.toString());let i=t+"_ulItem"+this.id,n=document.getElementById(i);for(let a=0;a<this.attributes.length;a++)createNewElement("li",t+"_attr"+this.id+"_"+a,n,["itemAttributes"],this.attributes[a].toString())},Item.prototype.buildSave=function(){let t={};t.e=this.isEquipped()?1:0,t.r=this.tier,t.t=this.type,t.n=this.name,t.p=this.stat.power,t.i=this.stat.range.index,t.l=this.isLocked,t.a=[];for(let e=0;e<this.attributes.length;e++)t.a.push(this.attributes[e].buildSave());return t},Accent.prototype.Recenter=function(t){this.loc.x-=t},Accent.prototype.draw=function(t){mctx.save();let e=getPathYatX(this.loc.x);mctx.translate(this.loc.x,e+this.loc.y);let i=e%6;switch(this.type){case"pebble0":default:mctx.beginPath(),mctx.fillStyle="#7775",mctx.ellipse(0,0,t/16,t/12,i,0,twoPi),mctx.fill();break;case"pebble1":mctx.beginPath(),mctx.fillStyle="#7655",mctx.ellipse(0,0,t/10,t/16,i,0,twoPi),mctx.fill();break;case"pebble2":mctx.beginPath(),mctx.fillStyle="#5565",mctx.ellipse(0,0,t/10,t/8,i,0,twoPi),mctx.fill();break;case"pebble3":mctx.beginPath(),mctx.fillStyle="#2225",mctx.ellipse(0,0,t/8,t/10,i,0,twoPi),mctx.fill();break;case"grass0":mctx.lineWidth=t/16,mctx.strokeStyle="#0709",mctx.beginPath(),mctx.moveTo(0,0),mctx.lineTo(-t/8,-t/4),mctx.moveTo(0,0),mctx.lineTo(t/4,-t/8),mctx.moveTo(0,0),mctx.lineTo(t/12,-e%(t/3)),mctx.stroke();break;case"grass1":mctx.lineWidth=t/16,mctx.strokeStyle="#0508",mctx.beginPath(),mctx.moveTo(0,0),mctx.lineTo(-e%(t/8),-t/8),mctx.moveTo(0,0),mctx.lineTo(0,-t/3),mctx.moveTo(0,0),mctx.lineTo(t/8,-t/6),mctx.stroke();break;case"grass2":mctx.lineWidth=t/16,mctx.strokeStyle="#090D",mctx.beginPath(),mctx.moveTo(0,0),mctx.lineTo(-t/10,-e%(t/3)),mctx.moveTo(0,0),mctx.lineTo(0,-t/5),mctx.moveTo(0,0),mctx.lineTo(t/8,-t/6),mctx.stroke();break;case"grass3":mctx.lineWidth=t/16,mctx.strokeStyle="#090D",mctx.beginPath(),mctx.moveTo(0,0),mctx.lineTo(-e%(t/3),-e%(t/2)),mctx.moveTo(0,0),mctx.lineTo(e%(t/4),-t/6),mctx.stroke()}mctx.restore()};const brickColor=function(t,e){let i="#222F",n="#333F",a="#555F",o="#666F",l="#888F",c="#FFF0",r=[[i,n,a,n,a,n,i],[a,o,i,n,o,i,n,o],[n,o,l,a,l,a,l,n],[a,o,l,o,l,a,l,o],[o,l,c,a,o,l,c,a],[o,l,c,o,l,o,c,l],[o,c,l,c,o,l,c,l],[c,l,c,l,c,c,l,c]],s=Math.min(r.length,t),h=r[s],u=h[e%h.length];return u};function drawBrokenCastleWall(t,e,i){if(isColorblind())return;let n=endZoneW(),a=t;if(Quality<2){mctx.lineWidth=a,mctx.beginPath(),mctx.strokeStyle="#333",mctx.moveTo(e-n,i),mctx.lineTo(e,i),mctx.stroke(),mctx.closePath();return}let o=a/8,l=1.625*o,c=Math.ceil(n/l),r=i+3*o,s=e-n;mctx.beginPath();for(let h=0;h<c;h++)for(let u=0;u<8;u++){mctx.fillStyle=brickColor(u,h*(u+level+1));let m=s+h*l,d=r-o*u;mctx.fillRect(m,d,l,o)}}function drawUnderlings(){let t=getScale()/4;for(let e=0;e<underlings.length;e++)3===Quality?DrawHighQualityMinion(underlings[e],t):underlings[e].Draw();for(let i=0;i<quid.length;i++)ctx.beginPath(),ctx.fillStyle="#6F6",ctx.arc(quid[i].x,quid[i].y,t/12,0,twoPi),ctx.fill()}const drawMinions=function(t){if(3===Quality){let e=getScale()/4;for(let i=0;i<minions.length;i++)minions[i].isFlying===t&&DrawHighQualityMinion(minions[i],e)}else for(let n=0;n<minions.length;n++)minions[n].isFlying===t&&minions[n].Draw()},drawBoss=function(t){if(boss&&boss.health>=0){if(t!==boss.isFlying)return;let e=getScale();Quality>=2?DrawHighQualityBoss(boss,e):boss.Draw()}},drawTowers=function(){let t=getScale()/2;if(3===Quality)for(let e=0;e<towers.length;e++)DrawHighQualityTower(towers[e],t);else for(let i=0;i<towers.length;i++)towers[i].Draw()},drawHero=function(){let t=getScale()/8;hero&&hero.health>=0&&(Quality>=2?DrawHighQualityHero(hero,4*t):hero.Draw()),squire&&squire.health>=0&&(Quality>=2?DrawHighQualityHero(squire,3*t):squire.Draw()),page&&page.health>=0&&(Quality>=2?DrawHighQualityHero(page,2*t):page.Draw())},updateFPS=()=>{let t=(thisLoop=performance.now())-lastLoop;if(frameTime+=(t-frameTime)/16,lastLoop=thisLoop,showFPS()){ctx.fillStyle="#0009",ctx.fillRect(0,0,42,17);let e=Math.floor(1e3/frameTime);ctx.beginPath(),ctx.fillStyle="#FFF9",ctx.font="10pt Helvetica",ctx.fillText(e,10,10),ctx.closePath()}},testAllRuins=()=>{let t=getScale();ctx.save(),ctx.translate(100,-gameH+2*pathW),level=1,drawRuins(t),ctx.translate(150,0),level=2,drawRuins(t),ctx.translate(150,0),level=3,drawRuins(t),ctx.translate(150,0),level=4,drawRuins(t),ctx.translate(150,0),level=5,drawRuins(t),ctx.translate(150,0),level=6,drawRuins(t),ctx.translate(-750,100),level=7,drawRuins(t),ctx.translate(150,0),level=8,drawRuins(t),ctx.translate(150,0),level=9,drawRuins(t),ctx.translate(150,0),level=10,drawRuins(t),ctx.translate(150,0),level=11,drawRuins(t),ctx.translate(150,0),level=12,drawRuins(t),ctx.restore(),stop()};function drawMap(){Quality=GetQuality(),mctx.fillStyle=GetStyleColor(),mctx.beginPath(),mctx.fillRect(0,0,gameW,gameH),mctx.closePath();let t=getScale();drawPath(),drawAccents(t),drawLevelEnd(t),drawRuins(t)}function drawUnits(){if(!paused)requestAnimationFrame(drawUnits),Quality=GetQuality(),ctx.clearRect(0,0,gameW,gameH),0!=Quality&&(getScale(),drawTowers(),drawUnderlings(),drawMinions(0),drawBoss(0),drawMinions(1),drawBoss(1),drawHero(),ctx.globalAlpha=.2,drawHeroAura(),drawBossAura(),ctx.globalAlpha=.4,drawImpacts(),ctx.globalAlpha=1,drawProjectiles(),updateFPS())}const pnl0=document.getElementById("pnl0"),pnl1=document.getElementById("pnl1"),reshowP1=document.getElementById("btnReshowP1");let ctx=document.getElementById("unitLayer").getContext("2d"),mctx=document.getElementById("mapLayer").getContext("2d",{alpha:!1});function setMinionOrder(){minionOrder=unitArrayOrderByLocationX(minions)||[]}function setTeam0(){team0=null==boss?[...underlings,...minions]:[...underlings,...minions,boss]}function setTeam1(){team1=[...towers],null!=hero&&team1.push(hero),null!=squire&&team1.push(squire),null!=page&&team1.push(page)}function isTeam1(t){return void 0!=baseTower[t]||void 0!=baseHero[t]}function isTeam0(t){return void 0!=baseMinion[t]||void 0!=baseBoss[t]||"Boss"===t}function setLeadInvader(){if(0==team0.length){leadInvader=null;return}leadInvader=team0.reduce((t,e)=>t.Location?.x>e.Location?.x?t:e)}const getLeaderDelta=(t,e)=>{let i=["Ram","Air","Earth","Water","Underling"],n=leaderPoint,a=1.8*n,o=e.Location?.x-(i.includes(e.type)?a:n);return t>o?t:o};function followTheLeader(){if(null===leadInvader)return;let t=team0.reduce(getLeaderDelta,0);t>0&&(Quality<2&&(t=pathL),levelEndX-=t,levelStartX-=t,path.forEach(e=>e.x-=t),minions.forEach(e=>e.Recenter(t)),underlings.forEach(e=>e.Recenter(t)),towers.forEach(e=>e.Recenter(t)),projectiles.forEach(e=>e.Recenter(t)),impacts.forEach(e=>e.Recenter(t)),accents.forEach(e=>e.Recenter(t)),hero&&hero.Recenter(t),squire&&squire.Recenter(t),page&&page.Recenter(t),boss&&boss.Recenter(t),addTower(),quid.forEach(e=>{e.x-=t}),drawMap())}function managePath(){for(;path[0].x<-3*pathL;)path.splice(0,1),addPathPoint(!1)}function addPathPoint(t){for(;path.length>0&&path.length<100;){let e=path[path.length-1],i=(halfH-e.y)/16,n=getRandomInt(-gameH/32+1,gameH/32)+i,a=e.x+pathL,o=e.y+n;path.push(new point(a,o)),t||(totalPaths++,buildAccents())}}function endZoneStartX(){return levelEndX-endZoneW()}function endZoneW(){return 12*pathL}function GetGaugesCheckedForUnitType(t){return{Damage:document.getElementById("chkDamage"+t).checked,Health:document.getElementById("chkHealth"+t).checked,Range:document.getElementById("chkRange"+t).checked,Reload:document.getElementById("chkReload"+t).checked}}function GetGaugeChecked(t,e){return document.getElementById("chk"+e+t).checked}function isDeathAbilityActive(){return null!=boss&&"Death"==boss.type&&boss.remainingDuration>0}function hardReset(){deleteSaveData(),cookiesEnabled=0,window.location.reload(!1)}function resetWorld(){totalPaths=64*(level=+resetLevel),path.length=0,hero=null,squire=null,page=null,towers.length=0,boss=null,underlings.length=0,minions.length=0,minionOrder.length=0,addMinionQ.length=0,deployList.length=0,lastGlobalSpawn=0,impacts.length=0,projectiles.length=0,stats.pushReset(),ticksSinceReset=0,team0.length=0,team1.length=0,accents=[],quid=[],buildWorld()}function resetT0(){for(let t in moneyPitLevel=0,resources.a.amt=0,minionUpgrades)for(let e=0;e<minionUpgradeTypes[0].length;e++)minionUpgrades[t][minionUpgradeTypes[0][e]]=0;for(let i in minionResearch)0==minionResearch[i].unlockT&&(minionResearch[i].lastSpawn=0);resetWorld()}function resetT1(){for(let t in resources.b.amt=0,tierMisc.t0.upgradePotency=1,minionUpgrades)for(let e=0;e<minionUpgradeTypes[1].length;e++)minionUpgrades[t][minionUpgradeTypes[1][e]]=0;for(let i in minionResearch)1==minionResearch[i].unlockT&&(minionResearch[i].lastSpawn=0);resetWorld()}function resetT2(){for(let t in resources.c.amt=0,tierMisc.t1.upgradePotency=1,minionUpgrades)for(let e=0;e<minionUpgradeTypes[2].length;e++)minionUpgrades[t][minionUpgradeTypes[2][e]]=0;for(let i in minionResearch)2==minionResearch[i].unlockT&&(minionResearch[i].lastSpawn=0);resetWorld()}function resetT3(){for(let t in totalPaths=0,level=0,resources.d.amt=0,tierMisc.t2.upgradePotency=1,bossUpgrades)for(let e in bossUpgrades[t])bossUpgrades[t][e]=0;for(let i in bossResearch)for(let n in bossResearch[i])bossResearch[i].isUnlocked=0;for(let a in minionUpgrades)for(let o=0;o<minionUpgradeTypes[3].length;o++)minionUpgrades[a][minionUpgradeTypes[3][o]]=0;for(let l in minionResearch)3==minionResearch[l].unlockT&&(minionResearch[l].lastSpawn=0);resetSelectedBoss(),resetWorld()}function remain(){toggleUIElementByID("confirmModal",!0),resetWorld(),start()}function advance(){toggleUIElementByID("confirmModal",!0),achievements.maxLevelCleared.count=0,achievements.maxLevelCleared.maxCount++,resetLevel=0,maxResetLevel=1,setElementTextById("startingLevelSelection","0");let t=getUIElement("startingLevelSelector");t.value=0,t.max=1,resetWorld(),start()}function setElementText(t,e,i){void 0!=t&&null!=t&&(0===e&&(e="0"),"string"==typeof e&&i&&(e=e.fixString()),t.textContent!=e&&(t.textContent=e))}function setElementTextById(t,e,i){if(null===t){console.error("id cannot be null");return}let n=document.getElementById(t);if(null===n){console.error(t+" element not found");return}null===e&&console.error(t,e),"string"==typeof e&&i&&(e=e.fixString()),n.textContent!=e&&(n.textContent=e)}function setButtonAffordableClass(t,e){e?t.classList.add("affordableUpg"):t.classList.remove("affordableUpg")}const frameCount=0;function updateTeam0(){manageUnderlings(),manageMinions(),manageBoss(),setTeam0(),followTheLeader(),setLeadInvader()}function updateTeam1(){manageHero(),manageTowers(),setTeam1()}function updateWorld(){managePath(),manageProjectiles(),manageImpacts(),manageBombCountdown(),checkLevelComplete()}let nextUpdate=0,lastUpdate=performance.now(),gameClock=0;function update(){if(gameClock<36e5){let t=performance.now();gameClock+=t-lastUpdate,lastUpdate=t}gameClock>11&&(gameClock-=11,doUpdate())}function doUpdate(){try{switch(nextUpdate){case 0:updateTeam0(),nextUpdate=1;break;case 1:updateTeam1(),nextUpdate=2;break;case 2:updateWorld(),nextUpdate=0}consecutiveMainCylceErrors=0,sinceQuid++,ticksSinceReset++}catch(t){console.error(t),++consecutiveMainCylceErrors>20&&(stop(),alert("Too many main cycle errors, see console for details. Game paused."))}}function autoBuySell(){try{doAutobuy(),doAutoSell(),doAutoForge(),consecutiveBuySellErrors=0}catch(t){console.error(t),++consecutiveBuySellErrors>20&&(stop(),alert("Too many item management errors, see console for details. Game paused."))}}function updateP0(){}function updateP1(){try{toggleHilite(),setMinionOrder(),updatePnl1(),updateResourceDisplay(),consecutiveP1Errors=0}catch(t){console.error(t),++consecutiveP1Errors>20&&(stop(),alert("Too many button update errors, see console for details. Game paused."))}}function checkLevelComplete(){null===hero&&null===squire&&null===page&&(level>=achievements.maxLevelCleared.maxLevel?(stop(),toggleUIElementByID("confirmModal",!1)):(achievements.maxLevelCleared.count=Math.max(achievements.maxLevelCleared.count,level),levelStartX=getEndOfLevelX((level=+level+1)-1),levelEndX=getEndOfLevelX(level),addHero(),drawMap()))}function updateResourceDisplay(){let t=resources.a.amt>1e6?resources.a.amt.toExponential(4).replace("+",""):Math.floor(resources.a.amt),e=resources.b.amt>1e6?resources.b.amt.toExponential(4).replace("+",""):Math.floor(resources.b.amt),i=resources.c.amt>1e6?resources.c.amt.toExponential(4).replace("+",""):Math.floor(resources.c.amt),n=resources.d.amt>1e6?resources.d.amt.toExponential(4).replace("+",""):Math.floor(resources.d.amt),a=resources.e.amt>1e6?resources.e.amt.toExponential(4).replace("+",""):Math.floor(resources.e.amt),o=resources.f.amt>1e6?resources.f.amt.toExponential(4).replace("+",""):Math.floor(resources.f.amt);setElementText(getUIElement("spnResourceAAmt"),t,!1),setElementText(getUIElement("spnResourceBAmt"),e,!1),setElementText(getUIElement("spnResourceCAmt"),i,!1),setElementText(getUIElement("spnResourceDAmt"),n,!1),setElementText(getUIElement("spnResourceEAmt"),a,!1),setElementText(getUIElement("spnResourceFAmt"),o,!1)}let thisLoop=0,lastLoop=0,frameTime=0;function toggleHilite(){for(let t=0;t<hilites.length;t++)if(hilites[t].count++,hilites[t].count>hilites[t].limit){let e=hilites[t].id,i=document.getElementById(e);if(null==i||hilites[t].blinks<=0){delHilite(hilites[t].id),t--;continue}i.classList.toggle("mnuHilite"),hilites[t].count=0,hilites[t].blinks--}}function addHilite(t,e){!hilites.some(e=>e.id==t)&&hilites.push({count:0,limit:8,id:t,blinks:2*e})}function delHilite(t){let e=hilites.filter(e=>e.id==t);if(e.length>0){let i=hilites.indexOf(e[0]);hilites.splice(i,1);let n=document.getElementById(t);null!=n&&n.classList.remove("mnuHilite")}}function doAutoSell(){if(tierUnlocked(4)&&getUIElement("chkAutoSell").checked)for(let t=0;t<inventory.length;t++){if(inventory[t].isLocked||inventory[t].isEquipped())continue;let e=inventory[t].score();!(e>=autoSellLimit)&&sell(inventory[t].id)}}function autoForgeA(t,e){return e||!!t.canPrestige()&&(prestigeItemByID(t.id),!0)}function autoForgeB(t,e){return e||!(t.stat.score()>=100)&&(upgradeItemAttr(t.id,"stat"),!0)}function autoForgeC(t,e){if(e)return e;let i=t.attributes[0].score(),n=0;for(let a=1;a<t.attributes.length;a++){let o=t.attributes[a].score();o<i&&(i=o,n=a)}return!(i>=100)&&(upgradeItemAttr(t.id,n),!0)}function autoForgeD(t,e){if(e)return e;let i=t.maxAttrIndex(),n=0,a=0;for(let o=0;o<t.attributes.length;o++){let l=t.attributes[o];if(!l)continue;let c=Math.max(0,i+l.indexAdjustment)-l.range.index;c>a&&(a=c,n=o)}return prestigeItemAttr(t.id,n),!0}function doAutoForge(){if(!tierUnlocked(4)||!getUIElement("chkAutoForge").checked)return;let t=[equipped.amulet,equipped.feet,equipped.head,equipped.legs,equipped.shield,equipped.torso,equipped.trinket,equipped.weapon].filter(t=>t);if(0===t.length)return;let e=t.sort((t,e)=>t.score()-e.score())[0];if(e.score()>autoForgeLimit)return;let i=!1;i=autoForgeA(e,i),i=autoForgeB(e,i),i=autoForgeC(e,i),i=autoForgeD(e,i)}function doAutobuy(){for(let t in tierMisc){if(!tierMisc[t].autobuy.isUnlocked)continue;if(!isAutoBuy(t)){toggleTierAutoPrestige(t,!1),toggleUIElementByID(`lblAutoPrestige${t[1]}`,!0),toggleUIElementByID(`chkAutoPrestige${t[1]}`,!0);continue}toggleUIElementByID(`lblAutoPrestige${t[1]}`,!1),toggleUIElementByID(`chkAutoPrestige${t[1]}`,!1);let e=Number(tierMisc[t].tier),i=!0,n=Object.keys(resources)[e],a=resources[n].amt;e>0&&unlockAutobuy(e-1),3==e&&(i=bossAutoUnlock()),i&=minionAutoUnlock(e),e>0&&upgradePotency(e-1),3==e&&(i&=bossAutobuy()),i&=minionAutobuy(e);let o=a-resources[n].amt;miscTierAutobuy(e,o=i?1/0:Math.max(o+1,resources[n].amt/2)),i&&getUIElement("chkAutoPrestige"+e).checked&&prestigeTier(e)}}function minionAutoUnlock(t){for(let e in minionResearch)if(!minionResearch[e].isUnlocked&&minionResearch[e].unlockT===t&&(unlockMinion(e),!minionResearch[e].isUnlocked))return!1;return!0}function minionAutobuy(t){let e=1/0,i=null,n=null,a=minionUpgradeTypes[t];for(let o in minionResearch)if(minionResearch[o].isUnlocked||!(minionResearch[o].unlockT>=t))for(let l in a){let c=a[l],r=minionUpgrades[o][c];r<e&&(e=r,i=o,n=c)}let s=getUpgradeCost(i,n);return null===i||null===n||s===1/0||(buyUpgrade(i,n),!1)}function bossAutoUnlock(){for(let t in bossResearch)if(!bossResearch[t].isUnlocked&&(unlockBoss(t),!bossResearch[t].isUnlocked))return!1;return!0}function bossAutobuy(){let t=1/0,e=null,i=null;for(let n in bossResearch){if(!bossResearch[n].isUnlocked)continue;let a=bossUpgrades[n];for(let o in a){let l=getEnhanceCost(n,o);l<t&&(t=l,e=n,i=o)}}return null===e||null===i||(enhanceBoss(e,i),!1)}function miscTierAutobuy(t,e){let i=miscTierButtons.find(e=>e.tier===t).buttons,n=e,a=-1;for(let o in i){let l=i[o];if(isUIElementHidden(l.button))continue;let c=Number(l.cost.textContent);c<n&&(n=c,a=o)}a>=0&&i[a].button.click()}function updateAutosave(){if(0==cookiesEnabled){toggleUIElementByID("divAutoSave",!0);return}if(toggleUIElementByID("divAutoSave",!1),autoSave()){if(++lastSave>100)try{saveData(),consecutiveSaveErrors=0}catch(t){++consecutiveSaveErrors>5&&(stop(),alert("Too many auto-save errors, see console for details. Game paused."))}document.getElementById("divAutoSaveProgress").style.width=lastSave+"%"}}function updatePnl1(){(toggleTierItems(),isUIElementHiddenByID("divMinionDashboard"))?isUIElementHiddenByID("divBossArea")?isUIElementHiddenByID("divArmory")?isUIElementHiddenByID("divGym")?isUIElementHiddenByID("divLab")?isUIElementHiddenByID("divOffice")?isUIElementHiddenByID("divForge")?isUIElementHiddenByID("divStore")?isUIElementHiddenByID("divStatistics")?isUIElementHiddenByID("divAchievements")?isUIElementHiddenByID("divInfo")&&isUIElementHiddenByID("divOptions"):updateAchievements():updateStatistics():updateT5():updateT4():updateT3():updateT2():updateT1():updateT0():(updateBossTab(),updateEquipped(),updateInventory()):(updateMinionSpawns(),updateMinionDashboard())}function toggleTierItems(){for(let t=0;t<7;t++){let e=document.getElementsByClassName("t"+t),i=tierUnlocked(t);for(let n=0;n<e.length;n++)toggleUIElement(e[n],!i)}for(let a in tierMisc){let o=document.getElementById("btnUnlockAutobuy"+a),l=document.getElementById("divAutobuy"+a);if(null==o||null==l)continue;let c=tierMisc[a].autobuy.isUnlocked;toggleUIElement(o,!c),toggleUIElement(l,c),c||setButtonAffordableClass(o,tierMisc[a].autobuy.cost<=resources[tierMisc[a].autobuy.resource].amt)}}function updatePrestige(t,e){let i=prestigeButtons.filter(e=>e.tier===t);if(1!==i.length)return;let n=i[0],a=getPrestigeGain(t);setElementText(n.gains,a);let o=getPrestigeCost(t);setElementText(n.cost,o),setButtonAffordableClass(n.button,e>=o)}function updateAutoBuy(t){let e=4==t?null:getUIElement("divAutobuyt"+t);if(null!=e){let i=tierMisc["t"+t].autobuy.isUnlocked;toggleUIElement(e,!i)}let n=0==t?null:getUIElement("btnautoBuy_"+t);if(null!=n){let a=tierMisc["t"+(t-1)].autobuy.isUnlocked;toggleUIElement(n,a)}}function updateUpgrades(t,e,i){let n=getUpgradePotency(t),a=getAchievementBonus("prestige"+t),o=getMaxUpgradeLevel();for(let l in e){let c=e[l];if(!minionResearch[c.unitType].isUnlocked&&minionResearch[c.unitType].unlockT>=t){toggleUIElement(c.listElement,!0);continue}for(let r of(toggleUIElement(c.listElement,!1),c.upgrades)){let s=getUpgradeCost(c.unitType,r.upgradeType),h=minionUpgrades[c.unitType][r.upgradeType]||0;setElementText(r.cost,s!==1/0?s:infinitySymbol),setElementText(r.maxLvl,o),setElementText(r.lvl,h),setElementText(r.potency,n>1?n+"x ":""),setElementText(r.perk,a>0?" +"+a:""),setButtonAffordableClass(r.button,s<=i)}}}function updateUnlocks(t,e){let i=unlockButtons.filter(e=>e.tier===t);if(1!==i.length)return;let n=i[0].unlocks;for(let a in n){let o=n[a];if(minionResearch[o.upgradeType]&&minionResearch[o.upgradeType].isUnlocked||bossResearch[o.upgradeType]&&bossResearch[o.upgradeType].isUnlocked){toggleUIElement(o.button,!0);continue}toggleUIElement(o.button,!1);let l=3===t?unlockBossCost():unlockMinionCost(o.upgradeType);setElementText(o.cost,l),setButtonAffordableClass(o.button,l<=e)}}function updateMiscBuy(t,e){let i=miscTierButtons.filter(e=>e.tier===t);if(1!==i.length)return;let n=i[0].buttons;for(let a in n){let o=n[a],l=o.button.getAttribute("purchaseType"),c=GetMiscCost(l,t);setElementText(o.cost,c!==1/0?c:infinitySymbol),setButtonAffordableClass(o.button,c<=e)}}function updateMinionSpawns(){let t=Math.min(100,lastGlobalSpawn/getGlobalSpawnDelay()*100);for(let e in document.getElementById("divQProgress").style.width=t+"%",minionResearch){let i=minionSpawns[e];if(toggleUIElement(i.base,!minionResearch[e].isUnlocked),minionResearch[e].isUnlocked){let n=isColorblind()?"#000":baseMinion[e].color,a=isColorblind()?"#DDD":baseMinion[e].color2,o=minionResearch[e].lastSpawn,l=getMinionSpawnDelay(e),c=Math.min(100,Math.floor(o/l*100));i.progress.style.width=c+"%",i.progress.style.backgroundColor=n,i.progress.style.color=a}}}function updateMinionDashboard(){setElementTextById("lblMinionCounter",getMinionCount()||"0",!1),setElementTextById("lblMaxMinions",getMaxMinions(),!1),setElementTextById("spnBarracks",addMinionQ.length||"0");for(let t=0;t<8;t++){let e=addMinionQ.length>t?addMinionQ[t]:" - Empty - ";setElementTextById("barracks"+t,e)}isCompactMinions()?generateCompactMinionList():generateExpandedMinionList()}const minionCardInfo=function(t,e,i,n){if(n){let a=minions.reduce((e,i)=>e+(i.type!=t||i.zombie?0:1),0);if(i)return t+": "+a;{let o=buildDictionary(getMinionUpgradedStats(t),"stat","prod");return`${t}:${a} |Health:${o.health} |Damage:${o.damage}`}}return i?t:`${t} |Health:${Math.ceil(e.health)} |Damage:${Math.floor(e.damage)}`},minionCardDisplayClasses=function(t,e){let i=["minionBlock"];return e?t?i.push("simpleCompactMinionBlock"):i.push("compactMinionBlock"):t&&i.push("simpleMinionBlock"),i};function generateCompactMinionList(){let t=isSimpleMinions(),e=minionCardDisplayClasses(t,!0);for(let[i,n]of Object.entries(minionResearch)){if(null===n||!n.isUnlocked)continue;minions.filter(t=>t.type==i);let a=minionCardInfo(i,null,t,!0);generateMinionCard(i,i,a,e)}}function generateExpandedMinionList(){let t=isSimpleMinions();for(let e=0;e<minionOrder.length;e++){if(minionOrder[e]>=minions.length)continue;let i=minions[minionOrder[e]],n=i.type,a=minionCardInfo(n,i,t,!1),o=minionCardDisplayClasses(t,!1);generateMinionCard(e,n,a,o)}let l=getUIElement("divMinionList");for(;l.childNodes.length>minionOrder.length;)l.removeChild(l.lastChild)}function generateMinionCard(t,e,i,n){let a=getUIElement("divMinionList"),o=createNewElement("div","divMinionListItem"+t,a,n,i);o.style.color=baseMinion[e].color,o.style.backgroundColor=baseMinion[e].color2,isColorblind()&&(o.style.color=GetColorblindColor(),o.style.backgroundColor=GetColorblindBackgroundColor())}function updateBossTab(){for(let t in unlockBossCost(),baseBoss){let e=bossUIs.filter(e=>e.type==t);if(1!==e.length)return;let i=e[0];if(bossResearch[t].isUnlocked){toggleUIElement(i.select,!1),toggleUIElement(i.selectLabel,!1),toggleUIElement(i.progressBackground,!1);let n=getBossSpawnDelay(t),a=bossResearch[t].lastSpawn,o=Math.min(100,a/n*100);i.progress.style.width=o+"%"}else toggleUIElement(i.select,!0),toggleUIElement(i.selectLabel,!0),toggleUIElement(i.progressBackground,!0)}if(null==boss){toggleUIElementByID("ulBossStats",!0),toggleUIElementByID("effectsTitle",!0),getUIElement("divBossActiveAbilityProgress").style.width="0%",getUIElement("divBossActiveAbility").classList.add("bossButtonDisabled");return}toggleUIElementByID("ulBossStats",!1),toggleUIElementByID("effectsTitle",!1),getUIElement("divBossActiveAbility").classList.remove("bossButtonDisabled");let l=0,c=getUIElement("divBossActiveAbility"),r=getUIElement("divBossActiveAbilityProgress");boss.remainingDuration>=0?(boss.remainingDuration=Math.max(boss.remainingDuration,0),l=100*boss.remainingDuration/boss.abilityDuration,c.classList.add("bossButtonActive"),c.classList.remove("bossButtonAvailable"),c.classList.remove("bossButtonUnavailable")):(l=100*boss.lastActiveAbility/boss.abilityCooldown)>99.999?(c.classList.add("bossButtonAvailable"),c.classList.remove("bossButtonUnavailable")):(c.classList.add("bossButtonUnavailable"),c.classList.remove("bossButtonAvailable")),l=Math.min(100,l);let s=2*+getComputedStyle(c).borderWidth.slice(0,-2),h=(c.offsetWidth-s)*l/100>>1<<1;r.style.width=h+"px";let u=[statTypes.health,statTypes.damage,statTypes.attackDelay,statTypes.attackRange,statTypes.moveSpeed,statTypes.auraRange,statTypes.auraPower,"auraInfo","passiveAbilityInfo","activeAbilityInfo"];for(let m=0;m<u.length;m++){let d=u[m],x="spanBoss"+d;switch(d){case statTypes.attackDelay:{let f=boss.effects.CalculateEffectByName(statTypes.attackRate,1),g=Math.floor(boss.attackDelay/f*100)/100;setElementTextById(x,g);break}case statTypes.health:case statTypes.damage:case statTypes.attackRange:case statTypes.moveSpeed:case statTypes.auraRange:case statTypes.auraPower:{let p=scaledStats.includes(d)?getScale():1,y=boss.CalculateEffect(d)*statAdjustments[d],$=y/p,T=flooredStats.includes(d)?Math.floor($):Math.floor(100*$)/100;setElementTextById(x,T);break}case"auraInfo":case"passiveAbilityInfo":case"activeAbilityInfo":{let b=baseBoss[boss.type][d];setElementTextById(x,b)}}}let _=getUIElement("divBossEffects");boss.effects.effects.forEach(t=>t.updateHtml(_))}function updateEquipped(){for(let[t,e]of Object.entries(equipped)){if(null===e)continue;let i=document.getElementById("divEquipped"+t.fixString());e.buildHtml(i,"eq");let n=createNewElement("button","btnUnequip"+e.id,i,["btnEquip"],"Unequip");addOnclick(n,function(){unequip(e.type)})}}function updateInventory(){setElementTextById("inventoryCount",inventory.length,!1);let t=document.getElementById("divItems");for(let e=0;e<inventory.length;e++){let i=inventory[e].id,n=document.getElementById("divItem"+i);if(null==n){n=createNewElement("div","divItem"+i,t,["item"],null),inventory[e].buildHtml(n,"inv");let a=inventory[e].isLocked?"\uD83D\uDD12":"\uD83D\uDD13",o=createNewElement("button","btnLock"+i,n,["btnLock"],a);addOnclick(o,function(){toggleLock(this,i)});let l=createNewElement("button","btnEquip"+i,n,["btnEquip"],"Equip");addOnclick(l,function(){equip(i)});let c=createNewElement("button","btnSell"+i,n,["btnSell"],"Sell:"+inventory[e].sellValue()+resources.e.symbol);addOnclick(c,function(){sell(i)})}else document.getElementById("btnEquip"+i).disabled=inventory[e].isEquipped(),document.getElementById("btnSell"+i).disabled=inventory[e].isEquipped()||inventory[e].isLocked,inventory[e].updateHtml("inv")}filterInventory()}function populateForgeItems(){let t=getUIElement("ddlForgeItems");clearChildren(t);let e=createNewElement("option","optSelect",t,[]," < Select Item >");e.value=null;for(let i=0;i<inventory.length;i++){let n=createNewElement("option","opt"+inventory[i].id,t,[],inventory[i].toString());n.value=inventory[i].id}populateForgeAttributes()}function populateForgeAttributes(){let t=getUIElement("divForgeStat"),e=getUIElement("divForgeAttributes");clearChildren(t),clearChildren(e);let i=getUIElement("btnPrestigeItem"),n=getUIElement("ddlForgeItems");if(n?.value==null||n?.value=="null"){toggleUIElement(i,!0),toggleUIElement(t,!0);return}toggleUIElement(i,!1),toggleUIElement(t,!1);let a=inventory.find(t=>t.id==n.value);if(!a)return;let o=a.maxAttrIndex(),l=a.canPrestige(),c=l?a.prestigeCost():1/0;setElementTextById("reforgeCost",c==1/0?infinitySymbol:c),setButtonAffordableClass(i,c<=resources.f.amt&&a.canPrestige()),forgeItemButtons.length=0,addStattribute(t,a.id,a.stat,"stat",o,!1);for(let r=0;r<a.attributes.length;r++){let s=createNewElement("div","fAttr"+r,e,["forgeStattribute"],null);addStattribute(s,a.id,a.attributes[r],r,o,!0)}updateStatributesAffordable()}function addStattribute(t,e,i,n,a,o){let l=i.range.step();createNewElement("text","fHeader"+n,t,["forgeHeader"],i.toString());let c=createNewElement("div","fRangeHolder"+n,t,["forgeRangeHolder"],null);createNewElement("div","fMin"+n,c,["forgeLeft"],i.range.min);let r=createNewElement("input","fRange"+n,c,["forgeRange"],null);createNewElement("div","ftMax"+n,c,["forgeRight"],i.range.max),r.type="range",r.min=i.range.min,r.max=i.range.max,r.step=l,r.value=i.power,r.disabled=!0;let s=i.range.upgradePrice(),h=createMiscButton("ItemUpgrade"+n,t,"Upgrade",s,resources.e.symbol);if(addOnclick(h,function(){upgradeItemAttr(e,n)}),h.itemId=e,h.index=n,forgeItemButtons.push(h),o){let u=Math.max(0,a+i.indexAdjustment),m="Attribute Level:"+i.range.index+"/"+u;createNewElement("div","fMaxRange"+n,t,["forgeIndexMax"],m);let d=i.range.prestigePrice(),x=createMiscButton("ItemPrestige"+n,t,"Prestige",d,resources.e.symbol);addOnclick(x,function(){prestigeItemAttr(e,n)}),x.itemId=e,x.index=n,x.maxI=a,forgeItemButtons.push(x);let f=getRerollAttrCost(a),g=createMiscButton("Reroll"+n,t,"Reroll",f,resources.e.symbol);addOnclick(g,function(){rerollItemAttr(e,n)}),g.itemId=e,g.index=n,forgeItemButtons.push(g)}else t.style.height=105}function updateStatributesAffordable(){for(let t of forgeItemButtons){let e=+t.cost,i=t.itemId,n=t.index,a=+t.maxI||0,o=inventory.find(t=>t.id==i);if(void 0==o)return;let l="stat"==n?o.stat:o.attributes[n],c=a+(l.indexAdjustment||0),r=e<=resources.e.amt,s=t.id.startsWith("Reroll",3)||t.id.startsWith("ItemPrestige",3)&&l.power>=l.range.max&&l.range.index<c||t.id.startsWith("ItemUpgrade",3)&&l.power<l.range.max;t.disabled=!s,setButtonAffordableClass(t,s&&r)}}function updateTierTab(t,e,i){if(updatePrestige(t,e),updateAutoBuy(t),updateUpgrades(t,i,e),updateUnlocks(t,e),updateMiscBuy(t,e),t<4){let n=getUIElement("divPrestige"+t),a=10>getPrestigeGain(t);toggleUIElement(n,a)}}function updateT0(){updateTierTab(0,resources.a.amt,t0Upgrades);let t=0===achievements.prestige0.count,e=miscTierButtons.find(t=>0===t.tier).buttons;for(let i=0;i<e.length;i++)toggleUIElement(e[i].button,t)}function updateT1(){updateTierTab(1,resources.b.amt,t1Upgrades)}function updateT2(){updateTierTab(2,resources.c.amt,t2Upgrades)}function updateT3(){updateTierTab(3,resources.d.amt,t3Upgrades);let t=getMaxUpgradeLevel(),e=getUpgradePotency(3),i=getAchievementBonus("prestige3");for(let n in t3BossUpgrades){let a=t3BossUpgrades[n];if(!bossResearch[a.unitType].isUnlocked){toggleUIElement(a.listElement,!0);continue}for(let o of(toggleUIElement(a.listElement,!1),a.upgrades)){let l=getEnhanceCost(a.unitType,o.upgradeType);setElementText(o.cost,l!==1/0?l:infinitySymbol),setElementText(o.maxLvl,t),setElementText(o.lvl,bossUpgrades[a.unitType][o.upgradeType]),setElementText(o.potency,e>1?e+"x ":""),setElementText(o.perk,i>0?" +"+i:""),setButtonAffordableClass(o.button,l<=resources.d.amt)}}}function updateT4(){updateTierTab(4,resources.e.amt,t4Upgrades),updateStatributesAffordable()}function updateT5(){for(let t of getUIElement("divBombStock").children){let e=bombTypes[t.value].remaining;setButtonAffordableClass(t,resources.f.amt>=1&&0==e)}for(let i of getUIElement("divExchange").children)setButtonAffordableClass(i,resources.f.amt>=1);updateExchangeRate("a"),updateExchangeRate("b"),updateExchangeRate("c"),updateExchangeRate("d");let n=getChestCost();setButtonAffordableClass(getUIElement("btnOpenChest"),resources.f.amt>=n)}function updateExchangeRate(t){let e=resources[t],i=getAchievementBonus("itemPrestiged")+2,n=resources.f.value,a=e.value,o=Math.floor((n/a)**2*(8*i)**.8+8*i+8),l=o+" "+e.name,c="btnExchange"+e.name,r=getUIElement(c);r.value=o,setElementText(r,l)}function updateChestStore(){let t=+getUIElement("numStoreChestLevel").value;t>32?(getUIElement("numStoreChestLevel").value=32,t=32):t<0&&(getUIElement("numStoreChestLevel").value=0,t=0);let e=getChestCost();setElementTextById("divChestCost",e);let i=getUIElement("btnOpenChest");setButtonAffordableClass(i,e<=resources.f.amt),t+=getAchievementBonus("itemPrestiged");let n=getUIElement("chestExpectedResultTable");clearChildren(n);let a=getItemTierChances(4*t);for(let o of a){let l=createNewElement("tr","eRow"+o.tier,n,[],null),c=100*o.tier+"-"+((o.tier+1)*100-1);createNewElement("td","eTier"+o.tier,l,[],c);let r=Math.floor(1e4*o.pct)/100;createNewElement("td","ePct"+o.tier,l,[],r)}}function updateAchievements(){let t=getAchievementScore();for(let e in setElementTextById("score",t),achievementElements){let i=achievementElements[e],n=i.type,a=+i.goal.textContent;if(achievements[n].count>=a){let o=getAchievementLevel(n),l=getAchievementNext(n);if(setElementText(i.level,o||"0"),setElementText(i.goal,l||"0"),o>=achievements[n].maxLevel){achievements[n].count=0,achievements[n].maxCount++;let c=getAchievementLevel(n),r=getAchievementNext(n);setElementText(i.level,c||"0"),setElementText(i.goal,r||"0")}}setElementText(i.maxCount,achievements[n].maxCount||"0"),setElementText(i.count,achievements[n].count||"0")}}function updateStatistics(){let t=getUIElement("statsSelect").value;if("Current"!==t)return;let e=stats.getDataSet(t),i=getUIElement("statsTeam").value,n=filterDataSet(e.data,i),a=getUIElement("statsBody");for(let o in setElementTextById("tickCount",e.ticks),n)n[o].updateHTMLRow(a)}function setStats(){let t=getUIElement("statsSelect").value,e=stats.getDataSet(t),i=getUIElement("statsTeam").value,n=filterDataSet(e.data,i),a=getUIElement("statsSort");if(a.disabled="Current"==t,!a.disabled){let o=a.value;n=n.sort((t,e)=>t.compare(e,o))}setElementTextById("tickCount",e.ticks);let l=getUIElement("statsBody");for(let c in clearChildren(l),n)n[c].buildHTMLRow(l)}function clearMinionList(){let t=getUIElement("divMinionList");clearChildren(t)}const addMinionQ=[],maxQ=8;let lastGlobalSpawn=0,globalSpawnDelay=120;const deployList=[];let deployDelay=50,zombieDelay=5,lastDeploy=0,minionsMaxed=!1;const zombieTypes=Object.entries(minionResearch).filter(t=>t[1].unlockT<2).map(t=>t[0]),waitingAreaMax=8*pathL;function getGlobalSpawnDelay(){let t=getEquippedEffect("All",tierMisc.t3.miscUpgrades.reduceDeployTime_3),e=.9**((globalSpawnDelayReduction+1+t.a)*t.m),i=totalPaths/64+1;return Math.max(globalSpawnDelay,globalSpawnDelay*i*e)}function manageMinions(){if(minionsMaxed=getMinionCount()>=getMaxMinions(),0===minions.length)minionOrder.length=0;else{for(let t=0;t<minions.length;t++)if(minions[t].Location.x<langoliers||minions[t].health<=0){if(minions[t].health<=0){if(boss?.type==="Death"&&!minions[t].zombie&&zombieTypes.includes(minions[t].type)){let e=MinionFactory(minions[t].type,!0);e.Location=minions[t].Location,minions.push(e)}if("Water"==minions[t].type){let i=minions[t].Location,n=250*baseMinionDefault.attackDelay/minions[t].attackDelay,a=[new UnitEffect("Water",statTypes.health,effectType.blessing,n,1,minions[t].maxHealth/100),new UnitEffect("Water",statTypes.damage,effectType.blessing,n,1.1,minions[t].damage),new UnitEffect("Water",statTypes.moveSpeed,effectType.blessing,n,1.1,minions[t].moveSpeed/10),new UnitEffect("Water",statTypes.attackRate,effectType.blessing,n,1.1,1)],o=new Projectile(i,"Water",i,minions[t].uid,minions[t].uid,0,0,a,1,0,0,1,!0,!0,2,projectileTypes.blast);projectiles.push(o)}else if("Bomber"==minions[t].type){let l=minions[t].Location,c=(minions[t].attackRange+minions[t].impactRadius)/1.5,r=new Projectile(l,"Bomber",l,minions[t].uid,minions[t].uid,0,2*minions[t].damage,null,1,0,0,c,!0,!0,0,projectileTypes.blast);projectiles.push(r)}null!==boss&&"Death"===boss.type&&(boss.damage+=1)}minions.splice(t,1),t--}for(let s=0;s<minions.length;s++)minions[s].Aim()?minions[s].moving=!1:minions[s].Move(),"Vampire"==minions[s].type&&(minions[s].isFlying=minions[s].moving?1:0),minions[s].DoHealing(),minions[s].effects.ManageEffects()}if(spawnMinions(),deployMinion(),isDeathAbilityActive()&&--zombieDelay<=0){zombieDelay=25;let h=pickOne(zombieTypes);minions.push(MinionFactory(h,!0)),stats.incrementUnitCount(h)}}function spawnMite(){getUIElement("chkClickToSpawn").checked&&!(addMinionQ.length>=8)&&addMinionQ.push(getUIElement("ddlClickToSpawnType").value)}function spawnMinions(){if(addMinionQ.length>=8)return;let t=achievements.minionsSpawned.count+deployList.length+addMinionQ.length===0?2e3:1;for(let e in minionResearch){let i=document.getElementById(`chkSpawn${e}`);if(null===i||!i.checked||!minionResearch[e].isUnlocked)continue;minionResearch[e].lastSpawn+=t;let n=getMinionSpawnDelay(e);minionResearch[e].lastSpawn>n&&(addMinionQ.push(e),minionResearch[e].lastSpawn=0)}}function deployMinion(){if(minionsMaxed)return;if(deployList.length>0&&++lastDeploy>deployDelay){let t=deployList.shift();minions.push(MinionFactory(t,!1)),stats.incrementUnitCount(t),achievements.minionsSpawned.count++,lastDeploy=0}if(0===addMinionQ.length)return;let e=0===achievements.minionsSpawned.count?2e3:1,i=getGlobalSpawnDelay();if(!((lastGlobalSpawn+=e)<i)&&0===deployList.length){let n=addMinionQ.shift();stats.incrementDeployCount(n);let a="Earth"==n?1:getMinionsPerDeploy(n);deployList.length=a,deployList.fill(n),lastGlobalSpawn=0,lastDeploy=deployDelay=3*i/4/a}}function getMinionCount(){let t=0,e={Earth:1};for(let i=0;i<minions.length;i++){if(minions[i].zombie)continue;let n=minions[i].type;e.hasOwnProperty(n)||(e[n]=1/getMinionsPerDeploy(n)),t+=e[n]}return Math.floor(10*t)/10}function getMinionsPerDeploy(t){let e=getEquippedEffect(t,statTypes.minionsPerDeploy),i=getMinionBaseStats(t).minionsPerDeploy+minionUpgrades[t].minionsPerDeploy;return(i+e.a)*e.m}function getMinionSpawnDelay(t){let e=getMinionBaseStats(t).spawnDelay,i=getMinionUpgradeMultipliers(t).spawnDelay,n=getEquippedEffect(t,"spawnDelay"),a=minionUpgrades[t].spawnDelay;return(e+n.a)*i**a*n.m}function getMaxMinions(){let t=getEquippedEffect("All",tierMisc.t1.miscUpgrades.maxMinions_1);return(maxMinions+4+t.a)*t.m}function getMinionBaseStats(t){let e={};return Object.assign(e,baseMinionDefault,baseMinion[t]),e}function getMinionUpgradeMultipliers(t){let e={};return Object.assign(e,minionUpgradeMultipliersDefault,minionUpgradeMultipliers[t]),e}function getMinionUpgradedStats(t){let e=getMinionBaseStats(t),i=getMinionUpgradeMultipliers(t),n=minionUpgrades[t],a=getPotencies(),o=getAchievementBonuses(),l=[];for(let c in statTypes){let r=e[c]||"-",s="minionsPerDeploy"===c?"+1":i[c]||"-",h=getUpgradeTier(c),u=o[h]||0,m=a[h]||1,d=(n[c]+u)*m||"-",x=getEquippedEffect(t,c),f=(r+x.a)*x.m;if("minionsPerDeploy"===c)f=getMinionsPerDeploy(t);else if(!isNaN(s)&&!isNaN(d)){let g=s,p=d;for(;p>48;)f*=g**48,g=(g-1)*.8+1,p-=48;p>0&&(f*=g**p)}statMaxLimits.hasOwnProperty(c)&&(f=Math.min(statMaxLimits[c],f)),statMinLimits.hasOwnProperty(c)&&(f=Math.max(statMinLimits[c],f));let y=flooredStats.includes(c)?Math.floor(f):Math.floor(100*f)/100;!isNaN(y)&&l.push({stat:c,base:r,mult:s,upg:d,prod:y})}if("Earth"===t){let $=l.find(t=>t.stat==statTypes.minionsPerDeploy).prod,T=l.find(t=>t.stat==statTypes.health),b=l.find(t=>t.stat==statTypes.damage),_=l.find(t=>t.stat==statTypes.regen),w=l.find(t=>t.stat==statTypes.attackRange),k=l.find(t=>t.stat==statTypes.impactRadius),v=l.find(t=>t.stat==statTypes.targetCount),P=l.find(t=>t.stat==statTypes.moveSpeed);T.prod=Math.floor(T.prod*$**.7*100)/100,_.prod=Math.floor(_.prod*$**.5*100)/100,v.prod=Math.floor(v.prod*$**.3),b.prod=Math.floor(b.prod*$**.2*100)/100,w.prod=Math.min(statMaxLimits.impactRadius,Math.floor(w.prod*$**.2*100)/100),k.prod=Math.min(statMaxLimits.impactRadius,Math.floor(k.prod*$**.2*100)/100),P.prod=Math.min(statMaxLimits.moveSpeed,Math.floor(P.prod*$**.1*100)/100),l.find(t=>t.stat==statTypes.minionsPerDeploy).prod=1}return l}function clearQ(){addMinionQ.length=0}function clearMinions(){minions.length=0}function generateMinionUid(t){let e="M_"+new Date%1e4+":"+t,i=0,n=minions.filter(t=>t.uid==e+i);for(;n.length;)i++,n=minions.filter(t=>t.uid===e+i);return e+i}function MinionFactory(t,e){let i=getMinionBaseStats(t),n=buildDictionary(getMinionUpgradedStats(t),"stat","prod"),a={};Object.assign(a,i,n);let o=new Minion(t,a.health/statAdjustments.health,a.damage/statAdjustments.damage,a.moveSpeed/statAdjustments.moveSpeed,a.isFlying,a.attackDelay/statAdjustments.attackDelay,a.targetCount/statAdjustments.targetCount,a.attackCharges/statAdjustments.attackCharges,a.chainRange/statAdjustments.chainRange,a.chainReduction/statAdjustments.chainReduction,a.impactRadius/statAdjustments.impactRadius,a.projectileSpeed/statAdjustments.projectileSpeed,a.attackRange/statAdjustments.attackRange,a.regen/statAdjustments.regen,a.projectileType,e,a.color,a.color2);return o}function Minion(t,e,i,n,a,o,l,c,r,s,h,u,m,d,x,f,g,p){if(this.type=t,this.health=e||10,this.maxHealth=4*this.health,this.damage=i||0,this.moveSpeed=n,this.isFlying=a,this.attackDelay=o||1,this.projectileSpeed=u||1,this.projectileType=x||projectileTypes.ballistic,this.attackRange=m||1,this.targetCount=l||1,this.attackCharges=c||1,this.chainRange=r||0,this.chainReduction=s||0,this.impactRadius=h||0,this.regen=d||0,this.color=g,this.color2=p,this.zombie=f,this.waiting="Underling"!==this.type&&isAdvancedTactics(),f){let y=getScale(),$=(boss?.auraRange||3)*y,T=boss?.Location?.x||path[4].x,b=Math.min(levelEndX,T+$),_=getRandomInt(Math.max(0,T-$),b),w=getRandomInt(y,gameH-y);this.Location=new point(_,w),this.health/=2,this.maxHealth=this.health,this.moveSpeed/=2,this.attackDelay*=2,this.targetCount=1,this.attackCharges=1,this.regen=0,this.waiting=!1}else if("Air"==t){let k=this.waiting?waitingAreaMax:Math.min(1.5*leaderPoint,endZoneStartX()),v=getRandomInt(0,k),P=getRandomInt(0,gameH);this.Location=new point(v,P)}else if("Fire"==t){let S=getRandomInt(0,gameH);this.Location=new point(path[0].x,S)}else if("Water"==t){let E=this.waiting?waitingAreaMax:Math.min(1.5*leaderPoint,endZoneStartX()),C=getRandomInt(0,E),L=-pathL;this.Location=new point(C,L)}else this.Location=new point(path[0].x,path[0].y);this.moveTarget=new point(this.Location.x+100,this.Location.y),this.lastAttack=this.attackDelay,this.canHitGround=1,this.canHitAir=1,this.team=0,this.shift=new point(Math.random()-.5,Math.random()-.5),this.effects=new UnitEffects,this.direction=1,this.moving=!0,this.drawCycle=0,this.uid=generateMinionUid(t.charAt(0))}Minion.prototype.CalculateEffect=function(t){let e=this[t];if(null!=e)return t==statTypes.heath&&(result=Math.max(this.maxHealth,result)),this.effects.CalculateEffectByName(t,e)},Minion.prototype.DoHealing=function(){this.regen&&this.health<this.maxHealth/4&&(this.health+=this.regen),this.health=this.effects.DotsAndHots(this.health,this.maxHealth,this.type)},Minion.prototype.Recenter=function(t){this.Location.x-=t};const calcMinionMoveTarget=(t,e,i,n,a,o)=>{n.x;let l=n.y*pathW,c=i.x+pathL;if("Underling"===this.type)return new point(c,getPathYatX(c)+l);if(e)return new point(c,i.y);if(a){let r=n.x*waitingAreaMax+waitingAreaMax/2,s=i.y;switch(t){case"Air":case"Fire":s=i.y;break;case"Water":s=l+pathW/2;break;default:s=getPathYatX(r)+l}return new point(r,s)}switch(t){case"Air":{let h=0,u=1/0;for(let m=0;m<team1.length;m++){if(team1[m].Location.x>levelEndX)continue;let d=(i.x-team1[m].Location.x)**2,x=(i.y-team1[m].Location.y)**2;d+x<u&&(u=d+x,h=m)}return team1[h].Location}case"Earth":{let f=hero?.Location||squire?.Location||page?.Location||null;if(null===f||f.x>c)break;if(inRange(f,i,o))return i;return new point(f.x,f.y)}case"Fire":{let g=new point(towers[0]?.Location?.x,towers[0]?.Location?.y);return(g.x>levelEndX||isNaN(g.x)||isNaN(g.y))&&(hero?.health>0?g=hero.Location:squire?.health>0?g=squire.Location:page?.health>0&&(g=page.Location)),g}case"Water":{let p=i.x+5*pathL;return new point(p,gameH)}}return new point(c,getPathYatX(c)+l)};Minion.prototype.Move=function(){if("Ram"===this.type&&this.lastAttack<this.attackDelay)return;isNaN(this.Location.x)&&(this.Location.x=path[0].x,this.Location.y=path[0].y),this.waiting&&(null!==boss||minionsMaxed||!isAdvancedTactics())&&(this.waiting=!1);let t=this.CalculateEffect(statTypes.moveSpeed),e="Earth"===this.type?this.CalculateEffect(statTypes.attackRange):0;if(this.moveTarget=calcMinionMoveTarget(this.type,this.zombie,this.Location,this.shift,this.waiting,e),"Water"===this.type){let i=getPathYatX(this.moveTarget.x)+this.shift.y*pathW;if(Math.abs(i-this.Location.y)<t){this.TakeDamage(1/0);return}}else if("Fire"===this.type&&this.lastAttack<this.attackDelay){let n=3*getScale(),a=Math.min(2*leaderPoint,endZoneStartX()),o=-((this.moveTarget.x>=a?Math.abs(this.shift.x):this.shift.x)*n),l=(this.moveTarget.y<halfH?n:-n)*Math.abs(this.shift.y);this.moveTarget=this.moveTarget.plus(new point(o,l))}let c=calcMove(t,this.Location,this.moveTarget);c.x=Math.min(c.x,levelEndX),this.moving=!this.Location.equals(c),this.Location=c},Minion.prototype.Draw=function(){if(0===Quality)return;let t=isColorblind()?GetColorblindColor():this.color,e=isColorblind()?GetColorblindBackgroundColor():this.color2,i=minionResearch[this.type]?.unlockT==2,n=getScale()/4*(i?1.5:1)*(this.isUnderling?.5:1);if(isColorblind()){let a=this.type.charAt(0);ctx.font="10pt Helvetica",ctx.fillStyle=t,ctx.beginPath(),ctx.fillRect(this.Location.x,this.Location.y,3,3),ctx.fillText(a,this.Location.x,this.Location.y),this.DrawHUD(),ctx.closePath();return}ctx.strokeStyle=t,ctx.fillStyle=e;let o=n/4;ctx.beginPath(),ctx.fillRect(this.Location.x-n/2,this.Location.y-n/2,n,n),ctx.beginPath(),ctx.lineWidth=o,ctx.rect(this.Location.x-(n+o)/2,this.Location.y-(n+o)/2,n+o,n+o),ctx.stroke(),ctx.closePath(),this.DrawHUD()},Minion.prototype.DrawHUD=function(){if(this.isUnderling)return;let t=isColorblind()?GetColorblindColor():this.color,e=isColorblind()?GetColorblindBackgroundColor():this.color2,i=GetGaugesCheckedForUnitType("Minion");if(i.Range&&(ctx.beginPath(),ctx.strokeStyle=t,ctx.lineWidth=1,ctx.beginPath(),ctx.arc(this.Location.x,this.Location.y,this.CalculateEffect(statTypes.attackRange),0,twoPi),ctx.stroke()),i.Reload){ctx.beginPath(),ctx.strokeStyle=t,ctx.lineWidth=2,ctx.beginPath();let n=this.lastAttack/this.attackDelay;ctx.arc(this.Location.x,this.Location.y,pathL,-halfPi,n*twoPi-halfPi),ctx.stroke()}if(i.Health){ctx.beginPath(),ctx.font="8pt Helvetica";let a=Math.ceil(10*this.health)/10,o=ctx.measureText(a).width,l=this.Location.x-(o>>1)-1,c=this.Location.y-getScale()/2;ctx.fillStyle=e,ctx.fillRect(l-1,c-9,o+3,12),ctx.fillStyle=t,ctx.fillText(a,l,c)}if(i.Damage){ctx.beginPath(),ctx.font="8pt Helvetica";let r=Math.floor(10*this.CalculateEffect(statTypes.damage))/10,s=r+(this.attackCharges<=1?"":"..."+Math.floor(this.attackCharges)),h=ctx.measureText(s).width,u=this.Location.x-(h>>1)-1,m=this.Location.y+getScale()/2;ctx.fillStyle=e,ctx.fillRect(u-1,m-9,h+3,12),ctx.fillStyle=t,ctx.fillText(s,u,m)}ctx.closePath()},Minion.prototype.Aim=function(){if(this.Location.x<0)return!1;"Catapult"===this.type&&this.moving||(this.lastAttack+=this.effects.CalculateEffectByName(statTypes.attackRate,1),this.lastAttack=Math.min(this.attackDelay,this.lastAttack));let t=this.CalculateEffect(statTypes.attackRange),e=[];for(let i=0;i<team1.length&&!(e.length>=this.targetCount);i++){let n=team1[i],a=Math.abs(this.Location.x-n.Location.x),o=Math.abs(this.Location.y-n.Location.y);a<t&&o<t&&inRange(n.Location,this.Location,t)&&e.push(n)}return e.length>0&&(this.moving||(this.moveTarget=new point(e[0].Location.x,e[0].Location.y)),this.Attack(e)),e.length>=this.targetCount&&"Fire"!=this.type&&"Water"!=this.type},Minion.prototype.Attack=function(t){if(0==t.length||this.lastAttack<this.attackDelay)return;let e=null,i=this.CalculateEffect(statTypes.damage);if("Fire"==this.type){let n=-(i/this.attackDelay);e=new UnitEffect("Fire",statTypes.health,effectType.curse,this.attackDelay,null,n),i=0,this.shift=new point(Math.random()-.5,Math.random()-.5)}for(let a=0;a<t.length;a++){let o=t[a],l=this.projectileType==projectileTypes.blast?this.Location:o.Location;if(projectiles.push(new Projectile(this.Location,this.type,l,o.uid,this.uid,this.projectileSpeed,i,e,this.attackCharges||1,this.chainRange||0,this.chainReduction||0,this.impactRadius,this.canHitGround,this.canHitAir,this.team,this.projectileType)),this.projectileType==projectileTypes.blast)break}"Air"==this.type&&this.TakeDamage(1),this.lastAttack=0},Minion.prototype.TakeDamage=function(t){let e=Math.min(t,this.health),i=getDamageModifier();if(t=Math.max(t*(1-i/100)-i,1),"Air"==this.type&&0!==t)this.health-=1/0;else if("Harpy"==this.type)Math.random()>.7&&(t=0);else if("Golem"==this.type){let n=.5+2*this.health/this.maxHealth;t*=n}return this.health-=t,e};let lastUnderlingSpawn=0;function manageUnderlings(){0==underlings.length&&spawnUnderling();for(let t=0;t<quid.length;t++)if(quid[t].x<langoliers){quid.splice(t,1);let e=getEquippedEffect("a","gain");resources.a.amt+=(1+e.a)*e.m,t--}for(let i=0;i<underlings.length;i++)if(underlings[i].Location.x<langoliers||underlings[i].health<=0)underlings.splice(i,1),i--;else{let n=pathL,a=.04*getScale();for(let o=0;o<quid.length;o++){let l=Math.abs(quid[o].x-underlings[i].Location.x),c=Math.abs(quid[o].y-underlings[i].Location.y);if(!(l>n)&&!(c>n)&&(quid[o]=calcMove(a,quid[o],underlings[i].Location),l<=n/8&&c<n/8)){quid.splice(o,1),o--;let r=getEquippedEffect("a","gain");resources.a.amt+=(1+r.a)*r.m}}}for(let s=0;s<underlings.length;s++){let h=underlings[s];h.Move(),h.Location.x,h.DoHealing(),h.effects.ManageEffects()}let u=pathL*(level**2+4);(0==underlings.length||underlings[underlings.length-1].Location.x>u)&&spawnUnderling();let m=achievements.maxLevelCleared.count+achievements.maxLevelCleared.maxCount,d=0===m?100:200*Math.max(1,m-level+2);for(;sinceQuid>d;)addQuid(),sinceQuid-=d}function spawnUnderling(){let t=new Minion("Underling",underling.health/statAdjustments.health,underling.damage/statAdjustments.damage,underling.moveSpeed/statAdjustments.moveSpeed,underling.isFlying,underling.attackDelay/statAdjustments.attackDelay,underling.targetCount/statAdjustments.targetCount,underling.attackCharges/statAdjustments.attackCharges,underling.chainRange/statAdjustments.chainRange,underling.chainReduction/statAdjustments.chainReduction,underling.splashRadius/statAdjustments.splashRadius,underling.projectileSpeed/statAdjustments.projectileSpeed,underling.attackRange/statAdjustments.attackRange,0,underling.projectileType,!1,underling.color,underling.color2);t.damage=0,t.attackRange=0,t.isUnderling=!0,t.canHitGround=1,t.canHitAir=1,t.team=0,t.yShift=Math.random()-.5,t.xShift=Math.random()-.5,t.effects=new UnitEffects,t.direction=1,t.uid=generateMinionUid("_"),t.lastAttack=0,underlings.push(t),lastUnderlingSpawn=0}const towerPassiveRegen=5e-6;function manageTowers(){if(towers.length>0)for(let t=0;t<towers.length;t++){if(towers[t].Location.x<path[0].x||towers[t].health<=0){if(1==towers.length)break;towers[t].health<=0&&(resources.a.amt+=towers[t].deathValue,achievements.towersDestroyed.count++),towers.splice(t,1),t--;continue}towers[t].Aim(),towers[t].DoHealing(),towers[t].effects.ManageEffects()}}function addTower(){let t=getLastTower(),e=t?t.Location.x:pathL,i=e/pathL,n=LevelToTotalPaths(+level+1)-totalPaths;for(;n<i;)n+=64;let a=n-i,o=Math.ceil(Math.max(.1*a,.5)*pathL),l=e+o;if(path[path.length-1].x<l)return;let c=getNextTowerType(),r=level,s=getScale()/2;for(;getEndOfLevelX(r)+s<l;)r++;r+=12*achievements.maxLevelCleared.maxCount;let h=TowerFactory(c,r,l);stats.incrementDeployCount(c),towers.push(h)}function getNextTowerType(){let t=[];for(let e in baseTower){let i=getTowerBaseStats(e).spawnWeight;for(let n=0;n<i;n++)t.push(e)}let a=getRandomInt(0,t.length);return t[a]}function getLastTower(){return towers&&towers.length?towers[towers.length-1]:null}function getTowerBaseStats(t){let e={};return Object.assign(e,baseTowerDefault,baseTower[t]),e}function getTowerLevelMultipliers(t){let e={};return Object.assign(e,towerLevelMultipliersDefault,towerLevelMultipliers[t]),e}function getTowerUpgradedStats(t,e){let i=getTowerBaseStats(t),n=getTowerLevelMultipliers(t);e||(e=level+12*achievements.maxLevelCleared.maxCount);let a=[];for(let o in statTypes){let l=i[o]||"-",c=n[o]||"-",r=getEquippedEffect(t,o),s=(l+r.a)*r.m;"-"!=c&&(s*=c**e),statMaxLimits.hasOwnProperty(o)&&(s=Math.min(1.05*statMaxLimits[o],s)),statMinLimits.hasOwnProperty(o)&&(s=Math.max(.95*statMinLimits[o],s));let h=flooredStats.includes(o)?Math.floor(s):Math.floor(100*s)/100;!isNaN(h)&&a.push({stat:o,base:l,mult:c,upg:e,prod:h})}return a}function generateTowerUid(t){let e="T_"+new Date%1e4+":"+t,i=0,n=towers.filter(t=>t.uid==e+i);for(;n.length;)i++,n=towers.filter(t=>t.uid==e+i);return e+i}function BuildTowerAttackEffect(t,e,i){if(null==e.attackEffect)return null;let n=[];for(let a=0;a<e.attackEffect.length;a++){let o=e.attackEffect[a].aBase*e.attackEffect[a].levelMultiplier**i,l=e.attackEffect[a].mBase*e.attackEffect[a].levelMultiplier**i,c=new UnitEffect(t,e.attackEffect[a].name,effectType.curse,e.attackEffect[a].defaultDuration,l,o);n.push(c)}return n}function getTowerY(t,e,i){let n=getPathYatX(e),a=pathW/2;if("Explosion"===t)return getRandomInt(n-a,n+a);let o=Math.max(i,a),l=Math.max(getScale(),n-o),c=Math.min(gameH-getScale(),n+o),r=getRandomIntExclusions(l,c,{min:n-a,max:n+a});return r}function TowerFactory(t,e,i){let n=getTowerBaseStats(t),a=buildDictionary(getTowerUpgradedStats(t,e),"stat","prod"),o={};Object.assign(o,n,a);let l=o.attackRange/statAdjustments.attackRange*getScale()+getScale(),c=getTowerY(t,i,l),r=BuildTowerAttackEffect(t,n,e),s=getEquippedEffect("a","gain"),h=Math.floor(e**.5)+1;h+=s.a,h*=s.m;let u=new Tower(e,t,h,o.canHitAir,o.canHitGround,o.health/statAdjustments.health,o.damage/statAdjustments.damage,o.targetCount/statAdjustments.targetCount,r,o.attackDelay/statAdjustments.attackDelay,o.projectileSpeed/statAdjustments.projectileSpeed,o.projectileType,o.attackRange/statAdjustments.attackRange,o.attackCharges/statAdjustments.attackCharges,o.chainRange/statAdjustments.chainRange,o.chainReduction/statAdjustments.chainReduction,o.impactRadius/statAdjustments.impactRadius,o.regen/statAdjustments.regen,i,c,o.color,o.color2);return u}function Tower(t,e,i,n,a,o,l,c,r,s,h,u,m,d,x,f,g,p,y,$,T,b){this.level=t,this.type=e,this.deathValue=i,this.canHitAir=n,this.canHitGround=a,this.health=o||5,this.maxHealth=4*o,this.damage=l||0,this.targetCount=Math.floor(c),this.attackEffect=r,this.attackDelay=s||1,this.projectileSpeed=h||1,this.projectileType=u||projectileTypes.ballistic,this.attackRange=m||1,this.Location=new point(y,$),this.color=T,this.color2=b,this.attackCharges=Math.floor(d||0),this.chainRange=x||0,this.chainReduction=f||0,this.impactRadius=g||1,this.lastAttack=this.attackDelay,this.team=1,this.regen=p,this.aimTarget=Math.random()*twoPi,this.effects=new UnitEffects,this.uid=generateTowerUid(e.charAt(0))}function manageHero(){hero&&(hero.Location.x<langoliers||hero.health<=0||isNaN(hero.health)?(itemDrop(hero.level),resources.a.amt+=hero.deathValue,hero.DeathEffect(),hero=null,achievements.heroesKilled.count++):(hero.moving=!hero.Aim(),hero.moving&&hero.Move(),hero.DoHealing(),hero.Aura(),hero.effects.ManageEffects())),squire&&(squire.Location.x<langoliers||squire.health<=0||isNaN(squire.health)?(itemDrop(squire.level),resources.a.amt+=squire.deathValue,squire.DeathEffect(),squire=null,achievements.heroesKilled.count++):(squire.moving=!squire.Aim(),squire.moving&&squire.Move(),squire.DoHealing(),squire.Aura(),squire.effects.ManageEffects())),page&&(page.Location.x<langoliers||page.health<=0||isNaN(page.health)?(itemDrop(page.level),resources.a.amt+=page.deathValue,page.DeathEffect(),page=null,achievements.heroesKilled.count++):(page.moving=!page.Aim(),page.moving&&page.Move(),page.DoHealing(),page.Aura(),page.effects.ManageEffects()))}function addHero(){let t=GetNextHeroX(),e=getPathYatX(t),i=getRandomInt(0,Object.keys(baseHero).length),n=Object.keys(baseHero)[i],a=level+12*achievements.maxLevelCleared.maxCount;if(hero=HeroFactory(n,a,t,e),achievements.maxLevelCleared.count,level>=4){let o=Object.keys(baseHero).filter(t=>t!=hero.type),l=getRandomInt(0,o.length),c=o[l];squire=HeroFactory(c,a-2,t,e)}if(level>=8){let r=Object.keys(baseHero).filter(t=>t!=hero.type&&t!=squire.type),s=getRandomInt(0,r.length),h=r[s];page=HeroFactory(h,a-4,t,e)}}function drawHeroAura(){hero&&hero.health>=0&&hero.DrawAura(),squire&&squire.health>=0&&squire.DrawAura(),page&&page.health>=0&&page.DrawAura()}function GetNextHeroX(){let t=getEndOfLevelX(level);return t-endZoneW()/2}function getHeroBaseStats(t){let e={};return Object.assign(e,baseHeroDefault,baseHero[t]),e}function getHeroLevelMultipliers(t){let e={};return Object.assign(e,heroLevelMultipliersDefault,heroLevelMultipliers[t]),e}function getHeroUpgradedStats(t,e){let i=getHeroBaseStats(t),n=getHeroLevelMultipliers(t);e||(e=level+12*achievements.maxLevelCleared.maxCount);let a=[];for(let o in statTypes){let l=i[o]||"-",c=n[o]||"-",r=getEquippedEffect(t,o),s=(l+r.a)*r.m;"-"!=c&&(s*=c**e),statMaxLimits.hasOwnProperty(o)&&(s=Math.min(1.5*statMaxLimits[o],s)),statMinLimits.hasOwnProperty(o)&&(s=Math.max(.5*statMinLimits[o],s));let h=flooredStats.includes(o)?Math.floor(s):Math.floor(100*s)/100;!isNaN(h)&&a.push({stat:o,base:l,mult:c,upg:e,prod:h})}return a}function HeroFactory(t,e,i,n){let a=getHeroBaseStats(t),o=buildDictionary(getHeroUpgradedStats(t,e),"stat","prod"),l={};Object.assign(l,a,o);let c=4*e+4;level>=achievements.maxLevelCleared.count&&(c*=5),stats.incrementDeployCount(t);let r=new Hero(t,e,l.symbol,c,l.canHitAir,l.canHitGround,l.health/statAdjustments.health,l.regen/statAdjustments.regen,l.damage/statAdjustments.damage,l.moveSpeed/statAdjustments.moveSpeed,l.attackDelay/statAdjustments.attackDelay,l.projectileSpeed/statAdjustments.projectileSpeed,l.projectileType,l.attackRange/statAdjustments.attackRange,l.attackCharges/statAdjustments.attackCharges,l.chainRange/statAdjustments.chainRange,l.chainReduction/statAdjustments.chainReduction,l.impactRadius/statAdjustments.impactRadius,l.targetCount,l.heroPowerType,i,n,l.color,l.color2);return r}function Hero(t,e,i,n,a,o,l,c,r,s,h,u,m,d,x,f,g,p,y,$,T,b,_,w){this.type=t,this.level=e,this.deathValue=n,this.canHitAir=a,this.canHitGround=o,this.health=l||5,this.maxHealth=4*l,this.regen=c,this.damage=r||0,this.moveSpeed=s,this.attackDelay=h||1,this.projectileSpeed=u||1,this.projectileType=m||projectileTypes.ballistic,this.attackRange=d||1,this.Location=new point(T,b),this.home=new point(T,b),this.moveSpeedMultiplier=1,this.attackDelayMultiplier=1,this.damageMultiplier=1,this.color=_,this.color2=w,this.attackCharges=x||1,this.chainRange=f||0,this.chainReduction=g||0,this.impactRadius=p||1,this.targetCount=y||1,this.heroPowerType=$,this.heroPowerValues=[];for(let k=0;k<$.effects.length;k++){let v=$.effects[k];this.heroPowerValues.push({type:v.effectType,mPower:v.mBase*v.mMultiplier**e,aPower:v.aBase*v.aMultiplier**e})}this.lastAttack=this.attackDelay,this.wanderDirection=1,this.patrolX=T,"Knight"==t?this.patrolX-=2*pathL:"Mage"==t&&(this.patrolX+=2*pathL),this.symbol=i,this.canHitGround=1,this.canHitAir=1,this.team=1,this.effects=new UnitEffects,this.drawCycle=0,this.moving=0,this.moveTarget=new point(T-5,b),this.uid="H_"+new Date%1e4+t.charAt(0)}function getHeroSize(t){return hero&&hero.uid==t?getScale()/2:squire&&squire.uid==t?getScale()/3:page&&page.uid==t?getScale()/4:void 0}function getHeroFontSize(t){return hero&&hero.uid==t?"bold 20pt Arial":squire&&squire.uid==t?"bold 15pt Arial":page&&page.uid==t?"bold 10pt Arial":void 0}function manageBoss(){if(tierUnlocked(2)||(boss=null),null===boss){"none"!=activeBoss()&&spawnBoss();let t=getUIElement("divBossEffects");t.childNodes.length>0&&clearChildren(t);return}if(boss.Location.x<langoliers||boss.health<=0)boss=null;else{if(!boss.Aim()||boss.Location.x<0?boss.Move():boss.moving=!1,boss.remainingDuration>=0){if("War"===boss.type)for(let e=0;e<boss.effects.effects.length;e++)1===boss.effects.effects[e].type&&(boss.effects.effects[e].duration=-1);boss.remainingDuration--}else boss.lastActiveAbility>=boss.abilityCooldown&&autoCastAbility()?bossActivateAbility():boss.lastActiveAbility=Math.min(boss.lastActiveAbility+1,boss.abilityCooldown);boss.DoHealing(),boss.Aura(),boss.effects.ManageEffects(!0)}}function spawnBoss(){if(null!=boss)return;let t=activeBoss();"none"!=t&&(bossResearch[t].lastSpawn++,bossResearch[t].lastSpawn>=getBossSpawnDelay(t)&&(addBoss(),bossResearch[t].lastSpawn=0))}function getBossSpawnDelay(t){if("none"==t)return -1;let e=getBossBaseStats(t).spawnDelay,i=1/getBossBoost(),n=getEquippedEffect("Boss",statTypes.spawnDelay);return(e+n.a)*n.m*i}function addBoss(){boss=BossFactory(),achievements.bossesSummoned.count++,stats.incrementDeployCount(boss.type)}function drawBossAura(){boss&&boss.health>=0&&boss.DrawAura()}function activeBoss(){if(!tierUnlocked(2))return"none";let t=document.querySelector("input[name='bossSelect']:checked");return null==t?"none":t.value}function getBossBaseStats(t){let e={};return Object.assign(e,baseBossDefault,baseBoss[t]),e}function getBossUpgradeMultipliers(t){let e={};return Object.assign(e,bossUpgradeMultipliersDefault,bossUpgradeMultipliers[t]),e}function getBossUpgradedStats(t){let e=getBossBaseStats(t),i=getBossUpgradeMultipliers(t),n=bossUpgrades[t],a=getUpgradePotency(3),o=getBossBoost(),l=[];for(let c in statTypes){let r=e[c]||"-",s=i[c]||"-",h=n[c]*a||"-",u=getEquippedEffect("Boss",c),m=(r+u.a)*u.m;if(c!==statTypes.chainReduction&&(backwardsStats.includes(c)?m/=o:m*=o),!isNaN(s)&&!isNaN(h)){let d=s,x=h;for(;x>48;)m*=d**48,d=(d-1)*.8+1,x-=48;x>0&&(m*=d**x)}statMaxLimits.hasOwnProperty(c)&&(m=Math.min(statMaxLimits[c],m)),statMinLimits.hasOwnProperty(c)&&(m=Math.max(statMinLimits[c],m));let f=flooredStats.includes(c)?Math.floor(m):Math.floor(100*m)/100;!isNaN(f)&&l.push({stat:c,base:r,mult:s,upg:h,bonus:o,prod:f})}return l}function getBossMoveTarget(){let t=+document.getElementById("bossPosition").value*((leaderPoint+pathL)/25),e=getPathYatX(t);return new point(t,e)}function bossActivateAbility(){null!=boss&&!(boss.lastActiveAbility<boss.abilityCooldown)&&boss.ActiveAbilityStart()}function BossFactory(){let t=activeBoss(),e=getBossBaseStats(t),i=buildDictionary(getBossUpgradedStats(t),"stat","prod"),n={};Object.assign(n,e,i);let a=n.symbol,o=new Boss(t,a,n.health/statAdjustments.health,n.damage/statAdjustments.damage,n.moveSpeed/statAdjustments.moveSpeed,n.attackDelay/statAdjustments.attackDelay,n.impactRadius/statAdjustments.impactRadius,n.projectileSpeed/statAdjustments.projectileSpeed,n.attackRange/statAdjustments.attackRange,n.targetCount/statAdjustments.targetCount,n.attackCharges/statAdjustments.attackCharges,n.chainRange/statAdjustments.chainRange,n.chainReduction/statAdjustments.chainReduction,n.regen/statAdjustments.regen,n.auraRange/statAdjustments.auraRange,n.auraPower/statAdjustments.auraPower,n.abilityCooldown/statAdjustments.abilityCooldown,n.abilityDuration/statAdjustments.abilityDuration,n.projectileType,n.isFlying,n.color,n.color2);return o}function Boss(t,e,i,n,a,o,l,c,r,s,h,u,m,d,x,f,g,p,y,$,T,b){if(this.type=t,this.symbol=e,this.health=i||10,this.maxHealth=4*i,this.damage=n||0,this.moveSpeed=Math.min(a||1,300),this.isFlying=$,this.attackDelay=o||1,this.projectileSpeed=c||1,this.projectileType=y||projectileTypes.ballistic,this.attackRange=r||1,this.targetCount=s||1,this.attackCharges=h||1,this.chainRange=u||1,this.chainReduction=m||0,this.impactRadius=l||0,this.Location=new point(path[1].x,path[1].y),this.regen=d,this.auraPower=f,this.auraRange=x,this.abilityCooldown=g,this.abilityDuration=p,this.lastActiveAbility=g,this.remainingDuration=0,this.color=T,this.color2=b,this.lastAttack=o,this.canHitGround=1,this.canHitAir=1,this.team=0,this.effects=new UnitEffects,this.attackEffects=[],"Pestilence"===t){let _=-(this.damage/1e3*1);this.attackEffects.push(new UnitEffect(this.type,statTypes.health,effectType.curse,500,null,_))}"War"===t&&(this.impactRadius=this.attackRange),this.drawCycle=0,this.moving=0,this.moveTarget=new point(0,0),this.attackHand=0,this.uid="B_"+new Date%1e4}Tower.prototype.CalculateEffect=function(t){let e=this[t];if(null!=e)return t==statTypes.heath&&(result=Math.max(this.maxHealth,result)),this.effects.CalculateEffectByName(t,e)},Tower.prototype.DoHealing=function(){this.regen&&this.health<this.maxHealth/4&&!this.effects.effects.some(t=>t.type==effectType.curse&&t.name==statTypes.health)&&(this.health+=this.regen),this.health=this.effects.DotsAndHots(this.health,this.maxHealth,this.type)},Tower.prototype.Recenter=function(t){this.Location.x-=t},Tower.prototype.Draw=function(){let t=isColorblind()?GetColorblindColor():this.color,e=isColorblind()?GetColorblindBackgroundColor():this.color2,i=getScale()/3;if(isColorblind()){let n=this.type.charAt(0);ctx.font="10pt Helvetica",ctx.fillStyle=t,ctx.beginPath(),ctx.fillRect(this.Location.x,this.Location.y,3,3),ctx.fillText(n,this.Location.x,this.Location.y),this.DrawHUD(),ctx.closePath();return}ctx.strokeStyle=t,ctx.fillStyle=e;let a=i/4;ctx.beginPath(),ctx.fillRect(this.Location.x-i/2,this.Location.y-i/2,i,i),Quality>=2&&(ctx.beginPath(),ctx.lineWidth=a,ctx.rect(this.Location.x-(i+a)/2,this.Location.y-(i+a)/2,i+a,i+a),ctx.stroke()),ctx.beginPath(),ctx.lineWidth=a,ctx.rect(this.Location.x-a/2-1,this.Location.y-a/2-1,a+2,a+2),ctx.stroke(),ctx.closePath(),this.DrawHUD(t,e)},Tower.prototype.DrawHUD=function(t,e){t=t||isColorblind()?GetColorblindColor():this.color||"#000",e=e||isColorblind()?GetColorblindBackgroundColor():this.color2||"#FFF";let i=3*getScale()/8;if(getUIElement("chkDefenderLevel").checked){ctx.font="bold 12pt Arial";let n=this.level||"0",a=ctx.measureText(n),o=a.width,l=a.actualBoundingBoxAscent,c=this.Location.x+i,r=this.Location.y;ctx.fillStyle=e,ctx.fillRect(c-1,r+i/2,o+l/2,-i),ctx.fillStyle=t,ctx.fillText(n,c,r+5)}let s=GetGaugesCheckedForUnitType("Tower");if(s.Range&&(ctx.beginPath(),ctx.strokeStyle=t,ctx.lineWidth=1,ctx.beginPath(),ctx.arc(this.Location.x,this.Location.y,this.CalculateEffect(statTypes.attackRange),0,twoPi),ctx.stroke()),s.Reload){ctx.beginPath(),ctx.strokeStyle=t,ctx.lineWidth=2,ctx.beginPath();let h=this.lastAttack>0?this.lastAttack/this.attackDelay:-this.lastAttack/this.attackDelay;ctx.arc(this.Location.x,this.Location.y,2*i,-halfPi,h*twoPi-halfPi,0),ctx.stroke()}if(s.Health){ctx.beginPath(),ctx.font="8pt Helvetica";let u=this.health.toFixed(1),m=ctx.measureText(u),d=m.width,x=m.actualBoundingBoxAscent,f=this.Location.y<i?this.Location.x-d-i:this.Location.x-d/2,g=this.Location.y<i?this.Location.y+x:this.Location.y-i;ctx.fillStyle=e,ctx.fillRect(f-1,g-x-2,d+3,x+2),ctx.fillStyle=t,ctx.fillText(u,f-1,g-1)}if(s.Damage){ctx.beginPath(),ctx.font="8pt Helvetica";let p=Math.floor(10*this.CalculateEffect(statTypes.damage))/10,y=(this.targetCount<=1?"":this.targetCount+"x")+p+(this.attackCharges<=1?"":"..."+this.attackCharges),$=ctx.measureText(y),T=$.width,b=$.actualBoundingBoxAscent,_=this.Location.y>gameH-i?this.Location.x+i:this.Location.x-T/2,w=this.Location.y>gameH-i?this.Location.y:this.Location.y+i+b;ctx.fillStyle=e,ctx.fillRect(_-1,w-b-1,T+3,b+3),ctx.fillStyle=t,ctx.fillText(y,_,w)}ctx.closePath()},Tower.prototype.Aim=function(){this.lastAttack+=this.effects.CalculateEffectByName(statTypes.attackRate,1),this.lastAttack=Math.min(this.attackDelay,this.lastAttack);let t=this.CalculateEffect(statTypes.attackRange),e=[];if(null!==boss){let i=boss.isFlying&&this.canHitAir||!boss.isFlying&&this.canHitGround,n=Math.abs(this.Location.x-boss.Location.x),a=Math.abs(this.Location.y-boss.Location.y);i&&n<t&&a<t&&inRange(boss.Location,this.Location,t)&&e.push(boss)}for(let o=0;o<team0.length&&!(e.length>=this.targetCount);o++){let l=team0[o];if("Underling"!==l.type&&(l.isFlying&&!this.canHitAir||!l.isFlying&&!this.canHitGround))continue;let c=Math.abs(this.Location.x-l.Location.x),r=Math.abs(this.Location.y-l.Location.y);c<t&&r<t&&inRange(l.Location,this.Location,t)&&e.push(l)}if(e.length>0){let s=e[0].Location.x-this.Location.x,h=e[0].Location.y-this.Location.y,u=isNaN(s)||isNaN(h)?0:Math.atan2(h,s);return this.aimTarget=u,this.Attack(e),!0}return this.aimTarget=(this.aimTarget+(this.Location.y>halfH?.01:-.01))%twoPi,!1},Tower.prototype.Attack=function(t){if(!(this.lastAttack<this.attackDelay)){for(let e=0;e<t.length;e++){let i=t[e],n=new Projectile(this.Location,this.type,i.Location,i.uid,this.uid,this.projectileSpeed,this.CalculateEffect(statTypes.damage),this.attackEffect,this.attackCharges||0,this.chainRange||0,this.chainReduction||0,this.impactRadius,this.canHitGround,this.canHitAir,this.team,this.projectileType);projectiles.push(n)}this.lastAttack=0}},Tower.prototype.TakeDamage=function(t){let e=getDamageModifier();if(t=Math.max(t/(1-e/200)+e,1),this.Location.x>endZoneStartX()&&this.Location.x<levelEndX){let i=achievements.maxLevelCleared.count,n=Math.max(0,level-(i>>1));t=Math.max(0,t-n)}t=Math.max(0,t=this.effects.CalculateEffectByName(statTypes.damageReduction,t));let a=Math.min(t,this.health);return this.health-=t,a},Hero.prototype.CalculateEffect=function(t){let e=this[t];if(null!=e)return t==statTypes.heath&&(result=Math.max(this.maxHealth,result)),this.effects.CalculateEffectByName(t,e)},Hero.prototype.DoHealing=function(){this.regen&&this.health<this.maxHealth/4&&!this.effects.effects.some(t=>t.type==effectType.curse&&t.name==statTypes.health)&&(this.health+=this.regen),this.health=this.effects.DotsAndHots(this.health,this.maxHealth,this.type)},Hero.prototype.Recenter=function(t){this.Location.x-=t,this.home.x-=t,this.home.y=getPathYatX(this.home.x),this.patrolX-=t,this.moveTarget.x-=t},Hero.prototype.Move=function(){let t=this.CalculateEffect(statTypes.moveSpeed),e=endZoneStartX()-12*pathL;if(null!=leadInvader&&leadInvader.Location.x>e){let i=this.CalculateEffect(statTypes.attackRange),n=Math.abs(this.Location.x-leadInvader.Location.x),a=Math.abs(this.Location.y-leadInvader.Location.y);if(n<i&&a<i&&inRange(leadInvader.Location,this.Location,i)){this.moving=!1;return}this.moveTarget=new point(leadInvader.Location.x,leadInvader.Location.y)}else if(Math.abs(this.Location.x-this.patrolX)>t/2)this.home.y=getPathYatX(this.home.x),this.moveTarget=new point(this.patrolX,this.home.y);else{this.home.y-this.Location.y>gameH/4?this.wanderDirection=1:this.Location.y-this.home.y>gameH/4&&(this.wanderDirection=-1);let o=this.Location.y+pathL*this.wanderDirection;this.moveTarget=new point(this.patrolX,o),t/=4,this.moving=.25}let l=calcMove(t,this.Location,this.moveTarget);if(l.equals(this.Location)){this.moving=!1;return}this.Location=l},Hero.prototype.Draw=function(){let t=isColorblind()?GetColorblindColor():this.color,e=isColorblind()?GetColorblindBackgroundColor():this.color2;if(isColorblind()){let i=this.type.charAt(0);ctx.font="bold 20pt Arial",ctx.fillStyle=t,ctx.beginPath(),ctx.fillRect(this.Location.x,this.Location.y,3,3),ctx.fillText(i,this.Location.x,this.Location.y)}else{ctx.fillStyle=e,ctx.strokeStyle=t,ctx.lineWidth=2;let n=getHeroSize(this.uid);if(ctx.beginPath(),ctx.arc(this.Location.x,this.Location.y,n,0,twoPi),ctx.fill(),ctx.stroke(),Quality>=2){ctx.beginPath(),ctx.fillStyle=t,ctx.font=getHeroFontSize(this.uid);let a=ctx.measureText(this.symbol),o=a.width,l=a.fontBoundingBoxAscent;ctx.fillText(this.symbol,this.Location.x-o/2,this.Location.y+l/2),ctx.font="bold 12pt Arial"}}this.DrawHUD(t,e)},Hero.prototype.DrawHUD=function(t,e){if(t=t||"#000",e=e||"#FFF",getUIElement("chkDefenderLevel").checked){ctx.font="bold 12pt Arial";let i=this.level||"0",n=ctx.measureText(i),a=n.width,o=n.actualBoundingBoxAscent,l=this.Location.x+getScale()/2,c=this.Location.y;ctx.fillStyle=e,ctx.fillRect(l-1,c-o/2-2,a+2,o+4),ctx.fillStyle=t,ctx.fillText(i,l,c+5)}let r=GetGaugesCheckedForUnitType("Hero");if(r.Range&&(ctx.beginPath(),ctx.strokeStyle=t,ctx.lineWidth=1,ctx.beginPath(),ctx.arc(this.Location.x,this.Location.y,this.CalculateEffect(statTypes.attackRange),0,twoPi),ctx.stroke()),r.Reload){ctx.beginPath(),ctx.strokeStyle=t,ctx.lineWidth=2,ctx.beginPath();let s=this.lastAttack>0?this.lastAttack/this.attackDelay:-this.lastAttack/this.attackDelay;ctx.arc(this.Location.x,this.Location.y,1.5*pathL,-halfPi,s*twoPi-halfPi,0),ctx.stroke()}if(r.Health){ctx.beginPath(),ctx.font="8pt Helvetica";let h=this.health.toFixed(1),u=ctx.measureText(h).width,m=this.Location.x-(u>>1),d=this.Location.y-getScale();ctx.fillStyle=e,ctx.fillRect(m-1,d-9,u+3,12),ctx.fillStyle=t,ctx.fillText(h,m,d)}if(r.Damage){ctx.beginPath();let x=Math.floor(10*this.CalculateEffect(statTypes.damage))/10,f=(this.targetCount<=1?"":Math.floor(this.targetCount)+"x")+x+(this.attackCharges<=1?"":"..."+Math.floor(this.attackCharges));ctx.font="8pt Helvetica";let g=ctx.measureText(f).width,p=this.Location.x-(g>>1),y=this.Location.y+getScale();ctx.fillStyle=e,ctx.fillRect(p-1,y-9,g+3,12),ctx.fillStyle=t,ctx.fillText(f,p,y)}ctx.closePath()},Hero.prototype.DrawAura=function(){let t=GetGaugesCheckedForUnitType("Hero");if(t.Range){this.Location.x,this.AuraRange(),this.AuraRange();let e=isColorblind()?GetColorblindColor():this.color;ctx.beginPath(),ctx.fillStyle=e,ctx.arc(this.Location.x,this.Location.y,this.AuraRange(),0,twoPi),ctx.fill(),ctx.closePath()}},Hero.prototype.AuraRange=function(){return this.attackRange*getScale()*2},Hero.prototype.Aim=function(){this.lastAttack+=this.effects.CalculateEffectByName(statTypes.attackRate,1),this.lastAttack=Math.min(this.attackDelay,this.lastAttack);let t=this.CalculateEffect(statTypes.attackRange),e=[];for(let i=0;i<team0.length&&!(e.length>=this.targetCount);i++){let n=team0[i],a=Math.abs(this.Location.x-n.Location.x),o=Math.abs(this.Location.y-n.Location.y);a<t&&o<t&&inRange(n.Location,this.Location,t)&&e.push(n)}return e.length>0&&(this.moving||(this.moveTarget=new point(e[0].Location.x,e[0].Location.y)),this.Attack(e)),e.some(t=>t.uid===leadInvader.uid||t.Location.x===leadInvader.Location.x)},Hero.prototype.Attack=function(t){if(!(this.lastAttack<this.attackDelay)&&0!==t.length){for(let e=0;e<t.length;e++){let i=t[e],n=this.projectileType==projectileTypes.blast?this.Location:i.Location,a=new Projectile(this.Location,this.type,n,i.uid,this.uid,this.projectileSpeed,this.CalculateEffect(statTypes.damage),null,this.attackCharges||0,this.chainRange||0,this.chainReduction||0,this.impactRadius,this.canHitGround,this.canHitAir,this.team,this.projectileType);projectiles.push(a)}this.lastAttack=0}},Hero.prototype.DeathEffect=function(){},Hero.prototype.Aura=function(){let t=this.heroPowerValues,e=this.AuraRange(),i=this.Location.x-e,n=this.Location.x+e;for(let a=0;a<t.length;a++){let o=t[a].aPower,l=t[a].mPower,c=t[a].type;for(let r=0;r<team1.length;r++)team1[r].Location.x>i&&team1[r].Location.x<n&&inRange(team1[r].Location,this.Location,e)&&team1[r].effects.AddEffect(this.type,c,effectType.blessing,1,l,o)}},Hero.prototype.TakeDamage=function(t){let e=getDamageModifier();t=Math.max(t/(1-e/200)+e,1),t=Math.max(0,t=this.effects.CalculateEffectByName(statTypes.damageReduction,t));let i=Math.min(t,this.health);return this.health-=t,i},Boss.prototype.CalculateEffect=function(t){let e=this[t];if(null==e)return;let i=this.effects.CalculateEffectByName(t,e);if(t==statTypes.heath&&(i=Math.max(this.maxHealth,i)),"moveSpeed"===t&&this.Location.x<-pathL){let n=this.Location.x/pathL;i*=n**2}return i},Boss.prototype.DoHealing=function(){this.regen&&this.health<this.maxHealth/4&&(this.health+=this.regen),this.health=this.effects.DotsAndHots(this.health,this.maxHealth,this.type)},Boss.prototype.Recenter=function(t){this.Location.x-=t},Boss.prototype.Move=function(){isNaN(this.Location.x)&&(this.Location.x=path[0].x,this.Location.y=path[0].y);let t=getBossMoveTarget().x,e=this.CalculateEffect(statTypes.moveSpeed),i=Math.abs(t-this.Location.x);if(i<e/2){this.Location.x=t,this.moving=!1;return}if(this.Location.x==t){this.moving=!1;return}let n=1;for(;path[n].x<=this.Location.x&&n<path.length;)n++;n--;let a=t<this.Location.x?-3:3;t<this.Location.x&&(e=this.CalculateEffect(statTypes.moveSpeed));let o=Math.max(0,n+a),l=new point(path[o].x,path[o].y);if(a>0&&"War"===this.type&&this.remainingDuration>0){if((l=team1.find(t=>t.Location.x>this.Location.x).Location).x>levelEndX&&(hero?l=hero.Location:squire?l=squire.Location:page&&(l=page.Location),inRange(l,this.Location,this.CalculateEffect(statTypes.attackRange)))){this.moving=!1;return}l.x-this.Location.x<e&&(this.lastAttack=this.attackDelay)}this.moveTarget=l;let c=calcMove(e,this.Location,l);c.x=Math.min(c.x,levelEndX),this.moving=!this.Location.equals(c),this.Location=c},Boss.prototype.Draw=function(){let t=isColorblind()?GetColorblindColor():this.color,e=isColorblind()?GetColorblindBackgroundColor():this.color2;if(isColorblind()){let i=this.type.charAt(0);ctx.font="bold 20pt Arial",ctx.fillStyle=t,ctx.beginPath(),ctx.fillRect(this.Location.x,this.Location.y,3,3),ctx.fillText(i,this.Location.x,this.Location.y),this.DrawHUD(),ctx.closePath();return}if(Quality>0&&(ctx.lineWidth=2,ctx.fillStyle=e,ctx.strokeStyle=t,ctx.beginPath(),ctx.arc(this.Location.x,this.Location.y,pathL,0,twoPi),ctx.fill(),ctx.stroke()),Quality>1){ctx.beginPath(),ctx.fillStyle=t,ctx.font="bold 20pt Arial";let n=ctx.measureText(this.symbol),a=n.width;ctx.fillText(this.symbol,this.Location.x-a/2,this.Location.y+10),ctx.font="bold 12pt Arial"}ctx.closePath(),this.DrawHUD(t,e)},Boss.prototype.DrawHUD=function(t,e){t=t||"#000",e=e||"#FFF";let i=GetGaugesCheckedForUnitType("Boss");if(i.Range&&(ctx.beginPath(),ctx.strokeStyle=t,ctx.lineWidth=1,ctx.beginPath(),ctx.arc(this.Location.x,this.Location.y,this.CalculateEffect(statTypes.attackRange),0,twoPi),ctx.stroke()),i.Reload){ctx.beginPath(),ctx.strokeStyle=t,ctx.lineWidth=2,ctx.beginPath();let n=this.lastAttack/this.attackDelay;ctx.arc(this.Location.x,this.Location.y,1.5*pathL,-halfPi,n*twoPi-halfPi,0),ctx.stroke()}if(i.Health){ctx.beginPath(),ctx.font="8pt Helvetica";let a=Math.ceil(10*this.health)/10,o=ctx.measureText(a).width,l=this.Location.x-(o>>1)-1,c=this.Location.y-getScale();ctx.fillStyle=e,ctx.fillRect(l-1,c-9,o+3,12),ctx.fillStyle=t,ctx.fillText(a,l,c)}if(i.Damage){ctx.beginPath();let r=Math.floor(10*this.CalculateEffect(statTypes.damage))/10,s=(this.targetCount<=1?"":Math.floor(this.targetCount)+"x")+r+(this.attackCharges<=1?"":"..."+Math.floor(this.attackCharges)),h=ctx.measureText(s).width,u=this.Location.x-(h>>1)-1,m=this.Location.y+getScale();ctx.fillStyle=e,ctx.fillRect(u-1,m-9,h+3,12),ctx.fillStyle=t,ctx.font="8pt Helvetica",ctx.fillText(s,u,m)}ctx.closePath()},Boss.prototype.DrawAura=function(){let t=GetGaugesCheckedForUnitType("Boss");if(t.Range){this.Location.x,this.AuraRange(),this.AuraRange();let e=isColorblind()?GetColorblindColor():this.color;ctx.beginPath(),ctx.fillStyle=e,ctx.arc(this.Location.x,this.Location.y,this.AuraRange(),0,twoPi),ctx.fill(),ctx.closePath()}},Boss.prototype.AuraRange=function(){return this.auraRange*getScale()},Boss.prototype.Aim=function(){this.lastAttack+=this.effects.CalculateEffectByName(statTypes.attackRate,1),this.lastAttack=Math.min(this.attackDelay,this.lastAttack);let t=this.CalculateEffect(statTypes.attackRange),e=this.targetCount,i=[];for(let n=0;n<team1.length&&!(i.length>=e);n++){let a=team1[n],o=Math.abs(this.Location.x-a.Location.x),l=Math.abs(this.Location.y-a.Location.y);o<t&&l<t&&inRange(a.Location,this.Location,t)&&i.push(a)}return i.length>0&&(this.Attack(i),this.moving||(this.moveTarget=new point(i[0].Location.x,i[0].Location.y))),i.length>=this.targetCount},Boss.prototype.Attack=function(t){if(!(this.lastAttack<this.attackDelay)){for(let e=0;e<t.length;e++){let i=t[e],n=this.CalculateEffect(statTypes.damage);if("War"==this.type){let a=getBossSpawnDelay("War");bossResearch.War.lastSpawn+=a/128,bossResearch.War.lastSpawn=Math.min(a,bossResearch.War.lastSpawn)}else if("Famine"==this.type){let o=(i.attackDelay>>2)*3;i.lastAttack-=o}else"Pestilence"===this.type&&(n=0);let l=this.projectileType==projectileTypes.blast?this.Location:i.Location,c=new Projectile(this.Location,this.type,l,i.uid,this.uid,this.projectileSpeed,n,this.attackEffects,this.attackCharges||1,this.chainRange||0,this.chainReduction||0,this.impactRadius,this.canHitGround,this.canHitAir,this.team,this.projectileType);"Pestilence"===this.type&&this.remainingDuration>0&&(c.attackCharges+=3),projectiles.push(c)}this.lastAttack=0,this.attackHand=(this.attackHand+1)%2}},Boss.prototype.Aura=function(){let t=this.auraPower,e=this.Location.x-this.AuraRange(),i=this.Location.x+this.AuraRange();switch(this.type){case"Death":{let n=effectType.blessing,a=statTypes.moveSpeed,o=t**.7;for(let l=0;l<minions.length;l++)minions[l].Location.x>e&&minions[l].Location.x<i&&inRange(minions[l].Location,this.Location,this.AuraRange())&&minions[l].effects.AddEffect(this.type,a,n,1,o);break}case"Famine":{let c=effectType.curse,r=statTypes.health,s=-(t**.7/1024);for(let h=0;h<team1.length;h++)team1[h].Location.x>e&&team1[h].Location.x<i&&inRange(team1[h].Location,this.Location,this.AuraRange())&&team1[h].effects.AddEffect(this.type,r,c,1,null,s);break}case"Pestilence":for(let u=0;u<team1.length;u++)if(team1[u].Location.x>e&&team1[u].Location.x<i&&inRange(team1[u].Location,this.Location,this.AuraRange())){let m=team1[u].effects.effects.find(t=>t.originType===this.type);if(void 0===m){let d=effectType.curse,x=statTypes.damage,f=(1/t)**.1;team1[u].effects.AddEffect(this.type,x,d,5,f)}else m.duration=5}break;case"War":{let g=effectType.blessing,p=statTypes.attackRate,y=t**.7;for(let $=0;$<minions.length;$++)minions[$].Location.x>e&&minions[$].Location.x<i&&inRange(minions[$].Location,this.Location,this.AuraRange())&&minions[$].effects.AddEffect(this.type,p,g,1,y);break}default:console.warn("Unknown boss aura:"+this.type)}},Boss.prototype.ActiveAbilityStart=function(){switch(this.remainingDuration=this.abilityDuration,this.lastActiveAbility=0,this.type){case"Death":break;case"Famine":for(let t=0;t<team1.length;t++)team1[t].lastAttack=0,team1[t].effects.AddEffect(this.type,statTypes.attackRate,effectType.curse,this.abilityDuration+1,.2);break;case"Pestilence":boss.effects.AddEffect(this.type,statTypes.attackRate,effectType.blessing,this.abilityDuration+1,3),boss.effects.AddEffect(this.type,statTypes.attackCharges,effectType.blessing,this.abilityDuration+1,1,3);break;case"War":boss.effects.AddEffect(this.type,statTypes.moveSpeed,effectType.blessing,this.abilityDuration+1,3),boss.effects.AddEffect(this.type,statTypes.attackRate,effectType.blessing,this.abilityDuration+1,3);break;default:console.warn("Unknown boss ability:"+this.type)}},Boss.prototype.TakeDamage=function(t){let e=getDamageModifier();t=Math.max(t*(1-e/100)-e,1),"War"==this.type&&(this.lastAttack+=this.attackDelay,this.lastActiveAbility=Math.min(this.lastActiveAbility+this.abilityCooldown/20,this.abilityCooldown),this.remainingDuration>0&&(t>>=1));let i=Math.min(this.health,t);return this.health-=t,i};const effectType={blessing:0,curse:1};function UnitEffects(){this.effects=[]}function UnitEffect(t,e,i,n,a,o){this.originType=t,this.name=e,this.duration=n,this.mPower=a,this.aPower=o,this.type=i}function drawProjectiles(){for(let t=0;t<projectiles.length;t++)projectiles[t].Draw()}function manageProjectiles(){for(let t=0;t<projectiles.length;t++){if(projectiles[t].Location.x<langoliers||projectiles[t].attackCharges<=0){projectiles.splice(t,1),t--;continue}if(projectiles[t].type===projectileTypes.beam){if(projectiles[t].beamDuration--,projectiles[t].beamDuration<=0){projectiles.splice(t,1),t--;continue}}else if(projectiles[t].type===projectileTypes.homing){if(projectiles[t].hasAttacked||void 0===(projectiles[t].team?team0:team1).find(e=>e.uid===projectiles[t].targetId)){projectiles.splice(t,1),t--;continue}}else if(projectiles[t].hasAttacked){projectiles.splice(t,1),t--;continue}projectiles[t].Move()}}function Projectile(t,e,i,n,a,o,l,c,r,s,h,u,m,d,x,f){this.source=new point(t.x,t.y),this.Location=new point(t.x,t.y),this.originType=e,this.target=new point(i.x,i.y),this.damage=l,this.unitEffect=c,this.targetId=n,this.sourceId=a,this.moveSpeed=o,this.attackCharges=r||0,this.chainRange=s||0,this.chainReduction=h||0,this.impactRadius=u||0,this.team=x,this.canHitGround=m,this.canHitAir=d,this.type=f||projectileTypes.ballistic,this.beamDuration=this.type==projectileTypes.beam?30:-1,this.initialBeamDuration=this.beamDuration,this.hasAttacked=0,this.trail=[],this.scale=getScale()/16,0==this.team?this.color="#FF0000":1==x?this.color="#0000FF":this.color="#00FFFF"}function drawImpacts(){for(let t=0;t<impacts.length;t++)impacts[t].Draw()}function manageImpacts(){for(let t=0;t<impacts.length;t++)if(impacts[t].lifeSpan--,impacts[t].lifeSpan<0){impacts.splice(t,1),t--;continue}}function Impact(t,e,i,n,a){this.Location=new point(t.x,t.y),this.radius=e||.1,this.color=i||"#F00",this.lifeSpan=n||5,this.maxLifeSpan=n||5,this.type=a||0,this.showMaxR=9*n/10||4.5}function manageBombCountdown(){for(let[t,e]of Object.entries(bombTypes))e.remaining>0&&e.remaining--,updateBombRow(t)}function getBombEffect(t){let e=bombTypes[t],i=getAchievementBonus("itemPrestiged"),n=(e.initial.a+e.scaleA.a*i)*e.scaleA.m**i,a=(e.initial.m+e.scaleM.a*i)*e.scaleM.m**i,o=(e.initial.d+e.scaleD.a*i)*e.scaleD.m**i;return n=Math.floor(100*n)/100,a=Math.floor(100*a)/100,o=Math.floor(o),{stats:e.stats,team:e.team,a:n,m:a,d:o,r:e.remaining}}function buyBomb(t){if(resources.f.amt<1||bombTypes[t].remaining>0)return;let e=getBombEffect(t),i=0==e.team?team0:team1,n=0==e.team?effectType.blessing:effectType.curse;for(let a of(resources.f.amt-=1,achievements.boostsPurchased.count++,i))for(let o of e.stats){let l=statAdjustments.hasOwnProperty(o)?e.a/statAdjustments[o]:e.a;a.effects.AddEffect("Store",o,n,e.d,e.m,l)}bombTypes[t].remaining=e.d}function buildBombRow(t,e){let i=getBombEffect(t),n=createNewElement("tr","bombInfo"+t,e,[]),a=`(stat+${i.a})*${i.m}`,o=fixBombStats(i.stats);createNewElement("td","bombName"+t,n,[],t.fixString()),createNewElement("td","bombStat"+t,n,[],o),createNewElement("td","bombFormula"+t,n,[],a),createNewElement("td","bombDuration"+t,n,[],i.d)}function updateBombRow(t){let e=getBombEffect(t),i="stat",n=e.a>0?"+":"";0!=e.a&&1!=e.m?i=`(stat${n}${e.a})*${e.m}`:0==e.a&&1!=e.m?i=`stat*${e.m}`:0!=e.a&&1==e.m&&(i=`stat${n}${e.a}`),setElementTextById("bombFormula"+t,i);let a=(e.r>0?e.r+"/":"")+e.d;setElementTextById("bombDuration"+t,a)}function fixBombStats(t){let e=t[0].fixString();for(let i=1;i<t.length;i++)e+=", "+t[i].fixString();return e}UnitEffects.prototype.AddEffect=function(t,e,i,n,a,o){let l=this.effects.filter(t=>t.name==e&&t.type==i);if(0==l.length){let c=new UnitEffect(t,e,i,n,a,o);this.effects.push(c);return}let r=l.find(e=>e.originType==t),s=[statTypes.health],h=[statTypes.health];if(null!=r&&(i==effectType.curse&&s.includes(e)||i==effectType.blessing&&h.includes(e))){r.mPower=nanMult(r.mPower,a),r.aPower=nanAdd(r.aPower,o),r.duration=nanMax(r.duration,n);return}let u=new UnitEffect(t,e,i,n,a,o);this.effects.push(u)},UnitEffects.prototype.ManageEffects=function(t=!1){for(let e=0;e<this.effects.length;e++)if(this.effects[e].duration--,this.effects[e].duration<=0||isNaN(this.effects[e].duration)){if(t){let i=document.getElementById(this.effects[e].type+"_Effect_"+this.effects[e].name);i&&i.parentNode.removeChild(i)}this.effects.splice(e,1),e--}},UnitEffects.prototype.CalculateEffectByName=function(t,e){let i=this.effects.filter(e=>e.name==t&&e.duration>=0),n=scaledStats.includes(t)?getScale():1;if(null==i||0==i.length)return e*n;let a=1,o=0;for(let l=0;l<i.length;l++)a*=i[l].getMPower(),o+=i[l].getAPower();return(e+o)*a*n},UnitEffects.prototype.DotsAndHots=function(t,e,i){let n=this.effects.filter(t=>t.name==statTypes.health&&t.duration>=0);if(null==n||0==n.length)return t;for(let a=0;a<n.length;a++){let o=Math.min(e,n[a].calculate(t)),l=o-t;!(0===l||isNaN(l))&&(l<0?(l=Math.abs(l),stats.addDamageDone(n[a].originType,l),stats.addDamageTaken(i,l)):stats.addHealingDone(n[a].originType,l),t=o)}return t},UnitEffect.prototype.getMPower=function(){return null==this.mPower||isNaN(this.mPower)||this.duration<0?1:this.mPower||1},UnitEffect.prototype.getAPower=function(){return null==this.aPower||isNaN(this.aPower)||this.duration<0?0:this.aPower||0},UnitEffect.prototype.calculate=function(t){let e=this.getAPower(),i=this.getMPower();return(t+e)*i},UnitEffect.prototype.buildHtml=function(t){if(this.duration<=1)return;let e=createNewElement("div",this.type+"_Effect_"+this.name,t,["effect"],null);createNewElement("div",this.type+"_Duration_"+this.name,e,["effectDuration"],this.duration),createNewElement("div",this.type+"_Name_"+this.name,e,["effectName"],this.name.fixString()),createNewElement("div",this.type+"_Details_"+this.name,e,["effectDetails"],null)},UnitEffect.prototype.updateHtml=function(t){let e=document.getElementById(this.type+"_Effect_"+this.name);if(!e){this.buildHtml(t);return}setElementTextById(this.type+"_Name_"+this.name,this.name,!0),setElementTextById(this.type+"_Duration_"+this.name,Math.floor(this.duration),!1),setElementTextById(this.type+"_Details_"+this.name,this.toString(),!1)},UnitEffect.prototype.toString=function(){let t=isNaN(this.aPower)?0:Math.floor(100*this.aPower)/100;t*=statAdjustments[this.name];let e=isNaN(this.mPower)||0==this.mPower?1:Math.floor(10*this.mPower)/10,i=t>0?"+":"";return 0!==t&&1!==e?`(x${i}${t})*${e}`:0!==t&&1===e?`x${i}${t}`:0===t&&1!==e?`x*${e}`:"-"},Projectile.prototype.Recenter=function(t){this.Location.x-=t,this.target.x-=t,this.source.x-=t;for(let e=0;e<this.trail.length;e++)this.trail[e].x-=t},Projectile.prototype.Resize=function(){this.scale=getScale()/16},Projectile.prototype.Move=function(){if(this.attackCharges<0)return;if(this.type==projectileTypes.beam){this.Location.x=this.target.x,this.Location.y=this.target.y,this.hasAttacked||this.Attack();return}if(this.type==projectileTypes.blast){this.Attack();return}if(this.type==projectileTypes.homing){let t=(this.team?team0:team1).find(t=>t.uid==this.targetId);if(void 0===t)return;this.target=new point(t.Location.x,t.Location.y)}let e=this.moveSpeed/50*getScale(),i=calcMove(e,this.Location,this.target);this.Location=i,inRange(this.Location,this.target,e)&&this.Attack()},Projectile.prototype.Draw=function(){let t=isColorblind()?GetColorblindBackgroundColor():this.color;if(ctx.fillStyle=t,ctx.strokeStyle=t,getUIElement("chkProjectileData").checked){let e=Math.floor(10*this.damage)/10,i=ctx.measureText(e).width,n=this.Location.x-(i>>1)-1,a=this.Location.y+getScale()/4;ctx.fillStyle=this.color,ctx.font="8pt Helvetica",ctx.fillText(e,n,a)}if(this.type==projectileTypes.ballistic||this.type==projectileTypes.blast)ctx.beginPath(),ctx.arc(this.Location.x,this.Location.y,this.scale,0,twoPi),ctx.fill();else if(this.type==projectileTypes.homing){let o=getScale()/50;this.trail.push(new point(this.Location.x,this.Location.y)),ctx.beginPath(),ctx.arc(this.Location.x,this.Location.y,this.scale,0,twoPi),ctx.fill(),ctx.strokeStyle=t+"88";for(let l=4;l<this.trail.length;l+=3)ctx.beginPath(),ctx.lineWidth=((l+3)/3>>1)*o,ctx.moveTo(this.trail[l-3].x,this.trail[l-3].y),ctx.lineTo(this.trail[l].x,this.trail[l].y),ctx.stroke(),ctx.closePath();for(;this.trail.length>24;)this.trail.shift()}else if(this.type==projectileTypes.beam){let c=getScale()/6,r=this.beamDuration/this.initialBeamDuration;if(this.beamDuration<=0)return;ctx.strokeStyle=t+"6",ctx.beginPath(),ctx.lineWidth=c*r,ctx.moveTo(this.source.x,this.source.y),ctx.lineTo(this.target.x,this.target.y),ctx.stroke(),ctx.strokeStyle=t}ctx.closePath()},Projectile.prototype.ImpactRange=function(){return this.impactRadius*getScale()},Projectile.prototype.Attack=function(){if(this.hasAttacked=1,this.type==projectileTypes.ballistic){let t=this.ImpactRange();impacts.push(new Impact(this.Location,t,this.color,12,0))}else if(this.type==projectileTypes.blast){let e=this.ImpactRange();impacts.push(new Impact(this.Location,e,this.color,28,1))}this.Damage();let i=this.NextChainTarget();if(null==i)return;let n=this.damage*this.chainReduction;for(let a=0;a<this.unitEffect?.length;a++)"health"===this.unitEffect[a].name&&(this.unitEffect[a].aPower*=this.chainReduction);let o=new Projectile(this.target,this.originType,new point(i.Location.x,i.Location.y),i.uid,this.targetId,this.moveSpeed,n,this.unitEffect,this.attackCharges-1,this.chainRange,this.chainReduction,this.impactRadius,this.canHitGround,this.canHitAir,this.team,this.type);projectiles.push(o)},Projectile.prototype.Damage=function(){let t=this.team?team0:team1;if(this.type==projectileTypes.homing||this.type==projectileTypes.beam){let e=t.filter(t=>t.uid==this.targetId);if(0==e.length)return;let i=e[0],n=i.TakeDamage(this.damage);stats.addDamageDone(this.originType,n),stats.addDamageTaken(i.type,this.damage),this.ApplyUnitEffect(i)}else if(this.type==projectileTypes.ballistic||this.type==projectileTypes.blast){let a=this.ImpactRange();for(let o=0;o<t.length;o++){let l=Math.abs(t[o].Location.x-this.Location.x),c=Math.abs(t[o].Location.y-this.Location.y);if(l<=a&&c<=a&&inRange(t[o].Location,this.Location,a)){let r=t[o].TakeDamage(this.damage);stats.addDamageDone(this.originType,r),stats.addDamageTaken(t[o].type,this.damage),this.ApplyUnitEffect(t[o])}}}},Projectile.prototype.NextChainTarget=function(){if(this.attackCharges<1)return;let t=this.team?team0:team1;if(0==t.length)return;if(this.type==projectileTypes.blast)return{uid:this.targetId,Location:new point(this.target.x,this.target.y)};let e=this.Location.x-this.chainRange*getScale(),i=this.Location.x+this.chainRange*getScale();if(t=t.filter(t=>t.Location.x>=e&&t.Location.x<=i&&t.uid!=this.sourceId&&t.uid!=this.targetId),this.canHitAir||(t=t.filter(t=>!t.isFlying)),this.canHitGround||(t=t.filter(t=>t.isFlying)),0==(t=t.filter(t=>t.Location.x<gameW&&!inRange(t.Location,this.Location,this.chainRange))).length)return null;let n=gameW,a=-1;for(let o=0;o<t.length;o++){let l=calcDistance(this.Location,t[o].Location);l<n&&(n=l,a=o)}return -1==a?null:t[a]},Projectile.prototype.ApplyUnitEffect=function(t){if(null!=this.unitEffect){if(Array.isArray(this.unitEffect))for(let e=0;e<this.unitEffect.length;e++)t.effects.AddEffect(this.originType,this.unitEffect[e].name,this.unitEffect[e].type,this.unitEffect[e].duration,this.unitEffect[e].mPower,this.unitEffect[e].aPower);else t.effects.AddEffect(this.originType,this.unitEffect.name,this.unitEffect.type,this.unitEffect.duration,this.unitEffect.mPower,this.unitEffect.aPower)}},Impact.prototype.Recenter=function(t){this.Location.x-=t},Impact.prototype.Draw=function(){let t=isColorblind()?GetColorblindColor():this.color;if(this.lifeSpan>this.showMaxR&&(ctx.strokeStyle=t,ctx.beginPath(),ctx.lineWidth=1,ctx.arc(this.Location.x,this.Location.y,this.radius,0,twoPi),ctx.stroke(),ctx.closePath()),0==this.type){ctx.fillStyle=t,ctx.beginPath();let e=Math.max(0,this.Radius());ctx.arc(this.Location.x,this.Location.y,e,0,twoPi),ctx.fill(),ctx.closePath()}else if(1==this.type){let i=this.Radius(),n=0;n=this.lifeSpan>this.maxLifeSpan/2?Math.max(0,i/2):Math.max(0,this.radius-i/2),ctx.strokeStyle=t,ctx.beginPath(),ctx.lineWidth=i,ctx.arc(this.Location.x,this.Location.y,n,0,twoPi),ctx.stroke(),ctx.closePath()}},Impact.prototype.Radius=function(){let t=this.lifeSpan*(this.lifeSpan-this.maxLifeSpan),e=(this.maxLifeSpan/2)**2;return this.radius*(-t/e)};const keysDown=[];function toggleMinionSpawn(t){minionResearch[t].isUnlocked&&(getUIElement("chkSpawn"+t).checked=!getUIElement("chkSpawn"+t).checked)}function ctrlAltShift(t){switch(t.keyCode){case 49:document.getElementById("chkRangeMinion").checked=!document.getElementById("chkRangeMinion").checked;return;case 50:document.getElementById("chkRangeBoss").checked=!document.getElementById("chkRangeBoss").checked;return;case 51:document.getElementById("chkRangeTower").checked=!document.getElementById("chkRangeTower").checked;return;case 52:document.getElementById("chkRangeHero").checked=!document.getElementById("chkRangeHero").checked;return;case 81:document.getElementById("chkReloadMinion").checked=!document.getElementById("chkReloadMinion").checked;return;case 87:document.getElementById("chkReloadBoss").checked=!document.getElementById("chkReloadBoss").checked;return;case 69:document.getElementById("chkReloadTower").checked=!document.getElementById("chkReloadTower").checked;return;case 82:document.getElementById("chkReloadHero").checked=!document.getElementById("chkReloadHero").checked;return;case 65:document.getElementById("chkHealthMinion").checked=!document.getElementById("chkHealthMinion").checked;return;case 83:document.getElementById("chkHealthBoss").checked=!document.getElementById("chkHealthBoss").checked;return;case 68:document.getElementById("chkHealthTower").checked=!document.getElementById("chkHealthTower").checked;return;case 70:document.getElementById("chkHealthHero").checked=!document.getElementById("chkHealthHero").checked;return;case 90:document.getElementById("chkDamageMinion").checked=!document.getElementById("chkDamageMinion").checked;return;case 88:document.getElementById("chkDamageBoss").checked=!document.getElementById("chkDamageBoss").checked;return;case 67:document.getElementById("chkDamageTower").checked=!document.getElementById("chkDamageTower").checked;return;case 86:document.getElementById("chkDamageHero").checked=!document.getElementById("chkDamageHero").checked;return}}function ctrl(t){let e=getUIElement("bossPosition");switch(t.keyCode){case 37:e.value--;break;case 38:case 40:break;case 39:e.value++;break;case 90:getUIElement("chkAutocast").checked=!getUIElement("chkAutocast").checked}}function ctrlShift(t){}function noModifiers(t){let e=null;switch(t.keyCode){case 32:mainCycle?stop():start(),t.preventDefault();break;case 90:boss&&boss.lastActiveAbility==boss.abilityCooldown&&bossActivateAbility();break;case 81:toggleMinionSpawn("Mite");break;case 87:toggleMinionSpawn("Imp");break;case 69:toggleMinionSpawn("Bomber");break;case 82:toggleMinionSpawn("Catapult");break;case 84:toggleMinionSpawn("Golem");break;case 89:toggleMinionSpawn("Harpy");break;case 85:toggleMinionSpawn("Ram");break;case 73:toggleMinionSpawn("Vampire");break;case 79:toggleMinionSpawn("Air");break;case 80:toggleMinionSpawn("Earth");break;case 219:toggleMinionSpawn("Fire");break;case 221:toggleMinionSpawn("Water");break;case 77:{let i=!t.altKey,n=Object.keys(minionResearch);for(let a=0;a<n.length;a++)minionResearch[n[a]].isUnlocked&&(getUIElement("chkSpawn"+n[a]).checked=i);break}case 66:addMinionQ.length=0;break;case 192:if(!tierUnlocked(3))return;e="btnMnuBosses";break;case 49:e="btnMnuMinions";break;case 50:e="btnMnuArmory";break;case 51:if(!tierUnlocked(1))return;e="btnMnuGym";break;case 52:if(!tierUnlocked(2))return;e="btnMnuLab";break;case 53:if(!tierUnlocked(3))return;e="btnMnuOffice";break;case 54:if(!tierUnlocked(4))return;e="btnMnuForge";break;case 55:if(!tierUnlocked(5))return;e="btnMnuStore";break;case 56:e="btnMnuStatistics";break;case 57:e="btnMnuAchievements";break;case 48:e="btnMnuOptions";break;case 189:e="btnMnuInfo";break;case 187:e="btnMnuHelp"}e&&getUIElement(e).click()}function showHelpModal(t){let e=document.getElementById(t),i=getUIElement("helpContent");clearChildren(i);let n=e.cloneNode(!0);n.id=n.id.replace("dd","modal"),getUIElement("helpContent").appendChild(n),toggleUIElementByID("helpModal",!1),n.classList.remove("ddHelp"),n.classList.add("helpText")}function toggleHelp(t,e){let i=document.getElementById(t);if(null==i)return;i.classList.toggle("expand");let n=document.getElementById(e);null!=n&&n.classList.toggle("ddRotate")}window.onkeydown=function(t){let e=document.activeElement;if("INPUT"!=e.nodeName||"textarea"!=e.type&&"number"!=e.type){if(("radio"==e.type||"checkbox"==e.type)&&e.blur(),t.ctrlKey&&t.altKey&&t.shiftKey){ctrlAltShift(t);return}if(t.ctrlKey&&t.shiftKey){ctrlShift(t);return}if(t.ctrlKey){ctrl(t);return}noModifiers(t)}},window.onkeyup=function(t){keysDown[t.key]=!1};const stats=new GameStats;function GameStats(){this.data={},this.pastData={}}function filterDataSet(t,e){let i=[];"All"==e&&(i=[...Object.getOwnPropertyNames(baseMinion),...Object.getOwnPropertyNames(baseBoss),...Object.getOwnPropertyNames(baseTower),...Object.getOwnPropertyNames(baseHero)]),"Invaders"==e&&(i=[...Object.getOwnPropertyNames(baseMinion),...Object.getOwnPropertyNames(baseBoss)]),"Defenders"==e&&(i=[...Object.getOwnPropertyNames(baseTower),...Object.getOwnPropertyNames(baseHero)]);let n=[];for(let[a,o]of Object.entries(t))i.includes(a)&&n.push(o);return n}function UnitStats(t){this.type=t,this.deployCount=0,this.unitCount=0,this.damageDone=0,this.healingDone=0,this.damageTaken=0}GameStats.prototype.incrementDeployCount=function(t){stats.data.hasOwnProperty(t)||(stats.data[t]=new UnitStats(t)),stats.data[t].incrementDeployCount()},GameStats.prototype.incrementUnitCount=function(t){stats.data.hasOwnProperty(t)||(stats.data[t]=new UnitStats(t)),stats.data[t].incrementUnitCount()},GameStats.prototype.addDamageDone=function(t,e){stats.data.hasOwnProperty(t)||(stats.data[t]=new UnitStats(t)),stats.data[t].addDamageDone(e)},GameStats.prototype.addHealingDone=function(t,e){stats.data.hasOwnProperty(t)||(stats.data[t]=new UnitStats(t)),stats.data[t].addHealingDone(e)},GameStats.prototype.addDamageTaken=function(t,e){stats.data.hasOwnProperty(t)||(stats.data[t]=new UnitStats(t)),stats.data[t].addDamageTaken(e)},GameStats.prototype.pushReset=function(){let t=getUIElement("statsSelect"),e="Reset #"+t.childNodes.length;createNewElement("option","dataset"+e,t,[],e),this.pastData[e]={data:this.data,ticks:ticksSinceReset},this.data={},setStats()},GameStats.prototype.getDataSet=function(t){return"Current"==t?{data:this.data,ticks:ticksSinceReset}:this.pastData.hasOwnProperty(t)?this.pastData[t]:{data:{},ticks:0}},Object.defineProperties(UnitStats.prototype,{donePerUnit:{get:function t(){return this.damageDone/this.deployCount}},takenPerUnit:{get:function t(){return this.damageTaken/this.deployCount}}}),UnitStats.prototype.incrementDeployCount=function(){this.deployCount++},UnitStats.prototype.incrementUnitCount=function(){this.unitCount++},UnitStats.prototype.addDamageDone=function(t){this.damageDone+=Math.max(0,t)},UnitStats.prototype.addHealingDone=function(t){this.healingDone+=Math.max(0,t)},UnitStats.prototype.addDamageTaken=function(t){this.damageTaken+=Math.max(0,t)},UnitStats.prototype.getDamageDone=function(){return this.damageDone==-1/0?0:Math.floor(100*this.damageDone)/100},UnitStats.prototype.getHealingDone=function(){return this.damageDone==-1/0?0:Math.floor(100*this.healingDone)/100},UnitStats.prototype.getDamageTaken=function(){return this.damageDone==-1/0?0:Math.floor(100*this.damageTaken)/100},UnitStats.prototype.getDamageDonePerDeploy=function(){if(this.damageDone==-1/0)return 0;let t=Math.max(1,this.deployCount);return Math.floor(this.damageDone/t*100)/100},UnitStats.prototype.getDamageTakenPerDeploy=function(){if(this.damageDone==-1/0)return 0;let t=Math.max(1,this.deployCount);return Math.floor(this.damageTaken/t*100)/100},UnitStats.prototype.getHealingDonePerDeploy=function(){if(this.damageDone==-1/0)return 0;let t=Math.max(1,this.deployCount);return Math.floor(this.healingDone/t*100)/100},UnitStats.prototype.compare=function(t,e){return this[e]<t[e]?-1:this[e]>t[e]?1:0};const formatDeployCount=function(t,e){return t>0&&e>0&&t!=e?`${t}(${e})`:Math.max(t,e)};function turtle(t,e){t.CalculateEffect(statTypes.moveSpeed),t.drawCycle=(t.drawCycle+1)%80;let i=(Math.abs(t.drawCycle-40)-20)/80,n=(t.drawCycle+20)%80;ctx.strokeStyle=t.color2,ctx.fillStyle=t.color2,ctx.beginPath(),ctx.arc(1.7*e,0,e/2,0,twoPi),ctx.fill();let a=i*e,o=(Math.abs(n-40)-20)/80*e,l=e/4,c=e,r=2*e;ctx.lineWidth=l;for(let s=0;s<2;s++){let h=a;switch(s%4){case 0:h=a;break;case 1:h=-o;break;case 2:h=-a;break;case 3:h=o}ctx.beginPath(),ctx.moveTo(e-r*s,0),ctx.lineTo(e-r*s+h,c),ctx.moveTo(e-r*s,0),ctx.lineTo(e-r*s-h,-c),ctx.stroke(),ctx.beginPath(),ctx.arc(e-r*s+h,c,l,0,twoPi),ctx.fill(),ctx.beginPath(),ctx.arc(e-r*s-h,-c,l,0,twoPi),ctx.fill()}ctx.fill(),ctx.fillStyle=t.color,ctx.beginPath(),ctx.ellipse(0,0,1.5*e,e,0,0,twoPi),ctx.fill(),ctx.strokeStyle="#000",ctx.lineWidth=1,ctx.beginPath(),ctx.moveTo(0,e),ctx.lineTo(0,-e),ctx.moveTo(1.5*e,0),ctx.lineTo(-1.5*e,0),ctx.stroke()}function worm(t,e){t.CalculateEffect(statTypes.moveSpeed),t.drawCycle=(t.drawCycle+1)%65;let i=(Math.abs(t.drawCycle-32.5)-65/4)/65;ctx.strokeStyle=t.color2,ctx.lineWidth=e/2;let n=i*(4*e);ctx.beginPath(),ctx.moveTo(n,0),ctx.lineTo(-n+4*e,0),ctx.stroke()}function butterfly(t,e){t.CalculateEffect(statTypes.moveSpeed),t.drawCycle=(t.drawCycle+1)%59;let i=Math.abs(t.drawCycle-29.5)/59;ctx.strokeStyle="#000",ctx.lineWidth=e/8,ctx.beginPath(),ctx.moveTo(2*e,e/3),ctx.lineTo(e,0),ctx.lineTo(2*e,-(e/3)),ctx.stroke(),ctx.lineWidth=e/4,ctx.beginPath(),ctx.moveTo(e,0),ctx.lineTo(-e,0),ctx.moveTo(e/2,e+i*e*4),ctx.lineTo(e,0),ctx.lineTo(e/2,-e-i*e*4),ctx.stroke(),ctx.fillStyle="#F70",ctx.beginPath(),ctx.moveTo(e,e/8),ctx.lineTo(e/2,e+i*e*4),ctx.lineTo(-(2*e),e/4),ctx.closePath(),ctx.fill(),ctx.beginPath(),ctx.moveTo(e,-e/8),ctx.lineTo(e/2,-e-i*e*4),ctx.lineTo(-(2*e),-e/4),ctx.closePath(),ctx.fill(),ctx.lineWidth=e/4,ctx.beginPath(),ctx.moveTo(e/2,e+i*e*4),ctx.lineTo(-(2*e),e/4),ctx.moveTo(e/2,-e-i*e*4),ctx.lineTo(-(2*e),-e/4),ctx.stroke(),ctx.beginPath(),ctx.moveTo(-e,e/2+i*e*2),ctx.lineTo(e,0),ctx.lineTo(-e,-e/2-i*e*2),ctx.stroke()}function snake(t,e){t.CalculateEffect(statTypes.moveSpeed),t.drawCycle=(t.drawCycle+1)%50;let i=Math.abs(t.drawCycle)/50;ctx.strokeStyle=t.color2,ctx.fillStyle=t.color2;let n=e;ctx.beginPath(),ctx.arc(n,0,e/2,0,twoPi),ctx.arc(n+e/2,0,e/4,0,twoPi),ctx.fill();let a=e,o=e/2,l=i*twoPi;ctx.lineWidth=e/2,ctx.beginPath(),ctx.moveTo(n,0);for(let c=0;c<16;c++){let r=a*Math.sin(c-l)/Math.max(4-c/2,1),s=n-o*c;ctx.lineTo(s,r)}ctx.stroke()}function hqUnderling(t,e){snake(t,e)}function hqMite(t,e){let i=t.CalculateEffect(statTypes.moveSpeed)/e,n=340*i**-.5/17;t.drawCycle=(t.drawCycle+(t.moving?1:0))%n;let a=(Math.abs(t.drawCycle-n/2)-n/4)/n;ctx.beginPath(),ctx.fillStyle=t.color2,ctx.ellipse(a*e,e/2,e/2,e,-1.5,0,twoPi),ctx.fill(),ctx.beginPath(),ctx.fillStyle=t.color2,ctx.ellipse(-a*e,-e/2,e/2,e,1.5,0,twoPi),ctx.fill();let o=-a*e,l=1.3*e,c=e/8,r=t.CalculateEffect(statTypes.attackDelay);r<=t.lastAttack&&(ctx.fillStyle="#741",ctx.beginPath(),ctx.moveTo(o,l-c),ctx.lineTo(o+2*e,l-c),ctx.lineTo(o+1.7*e,l+c),ctx.lineTo(o,l+c),ctx.closePath(),ctx.fill()),ctx.beginPath(),ctx.fillStyle=t.color,ctx.arc(o,l,3*c,0,twoPi),ctx.arc(-o,-l,3*c,0,twoPi),ctx.fill(),ctx.beginPath(),ctx.arc(0,0,e,0,twoPi),ctx.moveTo(-e,-2*e),ctx.lineTo(e/2,-e/4),ctx.lineTo(1.5*e,0),ctx.lineTo(e/2,e/4),ctx.lineTo(-e,2*e),ctx.lineTo(-e/2,0),ctx.closePath(),ctx.fill()}function hqImp(t,e){t.CalculateEffect(statTypes.moveSpeed),t.drawCycle=(t.drawCycle+1)%60;let i=Math.abs(t.drawCycle-30)/60,n=Math.abs(t.drawCycle)/60;ctx.fillStyle=t.color,ctx.strokeStyle=t.color,ctx.strokeStyle=t.color2,ctx.lineWidth=e/4,ctx.beginPath(),ctx.arc(1.8*e,0,.6*e,.2*Math.PI,-(.2*Math.PI)),ctx.stroke(),ctx.beginPath(),ctx.arc(e,0,e/2,0,twoPi),ctx.fill(),ctx.lineWidth=e/2,ctx.beginPath(),ctx.moveTo(-e,0),ctx.lineTo(e/2,0),ctx.stroke(),ctx.lineWidth=e/4,ctx.beginPath(),ctx.moveTo(-(2.5*e)-e/2*i,e/2),ctx.lineTo(-(1.5*e),e/2),ctx.moveTo(-(2.5*e)-e/2*(1-i),-e/2),ctx.lineTo(-(1.5*e),-e/2),ctx.stroke(),ctx.beginPath(),ctx.lineWidth=e/2,ctx.lineTo(-(1.5*e),e/2),ctx.lineTo(-e,e/4),ctx.lineTo(-e,0),ctx.lineTo(-e,-e/4),ctx.lineTo(-(1.5*e),-e/2),ctx.stroke();let a=e/8,o=e,l=n*twoPi;ctx.lineWidth=e/4,ctx.strokeStyle=t.color2,ctx.beginPath();let c=0;ctx.moveTo(-e,0);for(let r=0;r<8;r++){let s=e*Math.sin(r*a-l)/Math.max(8-r,1);ctx.lineTo(-e-(o+2*r),s),c=s}ctx.stroke(),ctx.beginPath(),ctx.moveTo(0,0),ctx.lineTo(e,e+e*i),ctx.lineTo(0,e+3*e*i),ctx.lineTo(-(2*e),e+e*i),ctx.closePath(),ctx.fill(),ctx.strokeStyle=t.color2,ctx.lineWidth=e/8,ctx.beginPath(),ctx.moveTo(0,0),ctx.lineTo(e,e+e*i),ctx.lineTo(-(2*e),e+e*i),ctx.moveTo(1.3*e,e+e*i*.8),ctx.lineTo(0,e+3*e*i),ctx.stroke(),ctx.beginPath(),ctx.moveTo(0,0),ctx.lineTo(e,-e-e*i),ctx.lineTo(0,-e-3*e*i),ctx.lineTo(-(2*e),-e-e*i),ctx.closePath(),ctx.fill(),ctx.strokeStyle=t.color2,ctx.lineWidth=e/8,ctx.beginPath(),ctx.moveTo(0,0),ctx.lineTo(e,-e-e*i),ctx.lineTo(-(2*e),-e-e*i),ctx.moveTo(1.3*e,-e-e*i*.8),ctx.lineTo(0,-e-3*e*i),ctx.stroke()}function hqBomber(t,e){ctx.fillStyle=t.color,ctx.strokeStyle=t.color2,ctx.lineWidth=e/8,ctx.beginPath(),ctx.moveTo(-e,0),ctx.lineTo(-(1.5*e),-(1.5*e)),ctx.lineTo(-(2.5*e),-(1.5*e)),ctx.lineTo(-(2*e),0),ctx.lineTo(-(2.5*e),1.5*e),ctx.lineTo(-(1.5*e),1.5*e),ctx.closePath(),ctx.fill(),ctx.fillStyle=t.color,ctx.beginPath(),ctx.ellipse(0,0,2*e,e,0,0,twoPi),ctx.fill(),ctx.stroke(),ctx.beginPath(),ctx.moveTo(2*e,0),ctx.lineTo(-(2*e),0),ctx.stroke(),ctx.beginPath(),ctx.ellipse(0,0,2*e,e/2,0,0,twoPi),ctx.stroke(),ctx.strokeStyle="#000",ctx.lineWidth=e/4,ctx.beginPath(),ctx.moveTo(-e,0),ctx.lineTo(-(2.5*e),0),ctx.stroke()}function hqCatapult(t,e){t.CalculateEffect(statTypes.moveSpeed),t.drawCycle=(t.drawCycle+(t.moving?1:0))%60;let i=t.drawCycle/60,n=(t.drawCycle+15)%60/60,a=(t.drawCycle+30)%60/60,o=(t.drawCycle+45)%60/60,l=t.CalculateEffect(statTypes.attackDelay),c=Math.min(1,t.lastAttack/l);ctx.strokeStyle=t.color2,ctx.beginPath(),ctx.lineWidth=e/2;let r=1.5*e,s=.5*e;ctx.moveTo(-r,-e),ctx.lineTo(-s,-e),ctx.moveTo(r,-e),ctx.lineTo(s,-e),ctx.moveTo(-r,e),ctx.lineTo(-s,e),ctx.moveTo(r,e),ctx.lineTo(s,e),ctx.stroke(),ctx.strokeStyle=t.color,ctx.beginPath(),ctx.lineWidth=e/6,ctx.moveTo(-r+e*i,-(5*e)/4),ctx.lineTo(-r+e*i,-(3*e)/4),ctx.moveTo(-r+e*a,5*e/4),ctx.lineTo(-r+e*a,3*e/4),ctx.moveTo(s+e*n,5*e/4),ctx.lineTo(s+e*n,3*e/4),ctx.moveTo(s+e*o,-(5*e)/4),ctx.lineTo(s+e*o,-(3*e)/4),ctx.stroke(),ctx.beginPath(),ctx.strokeStyle=t.color2,ctx.lineWidth=e/4;let h=6*e/8;ctx.moveTo(-e,-h),ctx.lineTo(e,-h),ctx.lineTo(e,h),ctx.lineTo(-e,h),ctx.moveTo(e/4,-h),ctx.lineTo(e/4,h),ctx.stroke(),ctx.beginPath(),ctx.fillStyle=t.color2,ctx.lineWidth=e/2;let u=-c*e;ctx.moveTo(e,0),ctx.lineTo(u,0),ctx.stroke(),ctx.arc(u,0,e/2,0,twoPi),ctx.fill(),c>.99&&(ctx.beginPath(),ctx.fillStyle=t.color,ctx.arc(u,0,e/4,0,twoPi),ctx.fill())}function hqGolem(t,e){let i=t.CalculateEffect(statTypes.moveSpeed)/e,n=600*i**-.5/17;t.drawCycle=(t.drawCycle+(t.moving?1:0))%n;let a=(Math.abs(t.drawCycle-n/2)-n/4)/n;ctx.beginPath(),ctx.lineWidth=e,ctx.strokeStyle=t.color2;let o=a*e*2-1.5*e,l=e;ctx.moveTo(o,l),ctx.lineTo(o+2*e,l),ctx.stroke(),ctx.beginPath();let c=-a*e*2-1.5*e,r=-e;ctx.moveTo(c,r),ctx.lineTo(c+2*e,r),ctx.stroke(),ctx.beginPath(),ctx.strokeStyle=t.color2;let s=a*e*3-e,h=-a*e*3-e,u=-(1.5*e),m=1.5*e;ctx.moveTo(s,u),ctx.lineTo(s+e,u-e/2),ctx.moveTo(h,m),ctx.lineTo(h+e,m+e/2),ctx.stroke(),ctx.strokeStyle=t.color,ctx.lineWidth=e,ctx.beginPath(),ctx.moveTo(o/2,r-e),ctx.lineTo(c/2,l+e),ctx.stroke(),ctx.strokeStyle=t.color;let d=e,x=.7*d;ctx.beginPath(),ctx.moveTo(-d,0),ctx.lineTo(d,0),ctx.moveTo(x,-x),ctx.lineTo(x,x),ctx.stroke()}function hqHarpy(t,e){t.CalculateEffect(statTypes.moveSpeed),t.drawCycle=(t.drawCycle+1)%65;let i=Math.abs(t.drawCycle-32.5)/65;t.drawCycle,ctx.fillStyle=t.color2,ctx.beginPath(),ctx.moveTo(e,-e/4),ctx.lineTo(2*e,0),ctx.lineTo(e,e/4),ctx.closePath(),ctx.fill(),ctx.fillStyle=t.color,ctx.beginPath(),ctx.arc(e,0,e/2,0,twoPi),ctx.fill(),ctx.strokeStyle=t.color2,ctx.lineWidth=e/2,ctx.beginPath(),ctx.moveTo(-e,0),ctx.lineTo(e/2,0),ctx.stroke();let n=-(2*e),a=e/3;ctx.lineWidth=e/4,ctx.beginPath(),ctx.moveTo(n,a),ctx.lineTo(-e,0),ctx.lineTo(n,-a),ctx.stroke(),ctx.lineWidth=e/10;let o=e/4;ctx.beginPath(),ctx.moveTo(n-e/2,a-o),ctx.lineTo(n,a),ctx.lineTo(n-e/2,a+o),ctx.moveTo(n,a),ctx.lineTo(n-e/2,a),ctx.moveTo(n-e/2,-a-o),ctx.lineTo(n,-a),ctx.lineTo(n-e/2,-a+o),ctx.moveTo(n,-a),ctx.lineTo(n-e/2,-a),ctx.stroke();let l=e,c=e+e*i*2;ctx.lineWidth=e/4,ctx.beginPath(),ctx.moveTo(0,0),ctx.lineTo(l,c),ctx.stroke(),ctx.strokeStyle=t.color2,ctx.lineWidth=e/4,ctx.beginPath(),ctx.moveTo(0,0),ctx.lineTo(l,-c),ctx.stroke();let r=c/8,s=l/8;ctx.lineWidth=r/2,ctx.strokeStyle=t.color,ctx.beginPath();for(let h=0;h<9;h++){let u=h*r,m=-e-e*(8-h)/8;ctx.moveTo(e/10+h*s,u),ctx.lineTo(m,u+r),ctx.moveTo(e/10+h*s,-u),ctx.lineTo(m,-u-r)}for(let d=2;d<9;d+=3){let x=d*r,f=-e-e*(8-d)/8;ctx.moveTo(e/10+d*s,x+r),ctx.lineTo(f,x-r),ctx.moveTo(e/10+d*s,-x-r),ctx.lineTo(f,-x+r)}ctx.stroke(),ctx.beginPath();let g=Math.PI/8;for(let p=1;p<8;p++){let y=-e*Math.cos(p*g),$=c+e*Math.sin(p*g);ctx.moveTo(e,c),ctx.lineTo(y,$),ctx.moveTo(e,-c),ctx.lineTo(y,-$)}ctx.stroke()}function hqRam(t,e){t.CalculateEffect(statTypes.moveSpeed),t.drawCycle=(t.drawCycle+(t.moving?1:0))%60;let i=t.drawCycle/60,n=(t.drawCycle+15)%60/60,a=(t.drawCycle+30)%60/60,o=(t.drawCycle+45)%60/60,l=t.CalculateEffect(statTypes.attackDelay),c=Math.min(1,t.lastAttack/l);ctx.strokeStyle=t.color,ctx.beginPath(),ctx.lineWidth=e/2;let r=1.5*e,s=.5*e;ctx.moveTo(-r,-e),ctx.lineTo(-s,-e),ctx.moveTo(r,-e),ctx.lineTo(s,-e),ctx.moveTo(-r,e),ctx.lineTo(-s,e),ctx.moveTo(r,e),ctx.lineTo(s,e),ctx.stroke(),ctx.strokeStyle=t.color2,ctx.beginPath(),ctx.lineWidth=e/6,ctx.moveTo(-r+e*i,-(5*e)/4),ctx.lineTo(-r+e*i,-(3*e)/4),ctx.moveTo(-r+e*a,5*e/4),ctx.lineTo(-r+e*a,3*e/4),ctx.moveTo(s+e*n,5*e/4),ctx.lineTo(s+e*n,3*e/4),ctx.moveTo(s+e*o,-(5*e)/4),ctx.lineTo(s+e*o,-(3*e)/4),ctx.stroke(),ctx.lineWidth=e/2,ctx.beginPath(),ctx.strokeStyle=t.color;let h=3.5*e-e*c;ctx.moveTo(h,0),ctx.lineTo(h-4*e,0),ctx.moveTo(h-e/2,-e/2),ctx.lineTo(h-e/2,e/2),ctx.stroke(),ctx.fillStyle=t.color2,ctx.beginPath(),ctx.rect(-e,-e,2*e,2*e),ctx.fill(),ctx.strokeStyle=t.color,ctx.lineWidth=e/12,ctx.beginPath(),ctx.moveTo(-e,0),ctx.lineTo(e,0),ctx.stroke()}function hqVampire(t,e){t.moving?vampireMove(t,e):vampireWait(t,e)}function vampireMove(t,e){t.CalculateEffect(statTypes.moveSpeed),t.drawCycle=(t.drawCycle+1)%57;let i=Math.abs(t.drawCycle-28.5)/57;ctx.strokeStyle=t.color2,ctx.fillStyle=t.color2;let n=e+i*e*4,a=.9*n,o=.85*n,l=.75*n,c=.6*n,r=.3*n,s=e/2,h=e/6;ctx.beginPath(),ctx.moveTo(s,0),ctx.lineTo(s+2*h,c),ctx.lineTo(s-0*h,n),ctx.lineTo(s-1*h,a),ctx.lineTo(s-3*h,o),ctx.lineTo(s-3*h,l),ctx.lineTo(s-5*h,c),ctx.lineTo(s-5*h,r),ctx.lineTo(s-8*h,0),ctx.lineTo(s,0),ctx.lineTo(s-8*h,-0),ctx.lineTo(s-5*h,-r),ctx.lineTo(s-5*h,-c),ctx.lineTo(s-3*h,-l),ctx.lineTo(s-3*h,-o),ctx.lineTo(s-1*h,-a),ctx.lineTo(s-0*h,-n),ctx.lineTo(s+2*h,-c),ctx.closePath(),ctx.fill();let u=e/4;ctx.beginPath(),ctx.moveTo(0,u),ctx.lineTo(e,u),ctx.lineTo(3*e/4,0),ctx.lineTo(e,-u),ctx.lineTo(0,-u),ctx.closePath(),ctx.fill()}function vampireWait(t,e){ctx.fillStyle=t.color2,ctx.beginPath(),ctx.moveTo(0,-e),ctx.lineTo(0,e),ctx.arc(0,0,e,Math.PI/2,-Math.PI/2),ctx.fill(),ctx.beginPath(),ctx.fillStyle=t.color,ctx.arc(0,0,e/2,0,twoPi),ctx.fill()}function hqAir(t,e){t.drawCycle=(t.drawCycle+1)%17;let i=Math.abs(t.drawCycle-8.5)/17,n=-e/16,a=e/16,o=i*twoPi;ctx.lineWidth=e/12,ctx.strokeStyle=t.color2,ctx.beginPath();for(let l=0;l<32;l++){let c=a/2*Math.cos(l*n-o);ctx.moveTo(-a+c,l*n),ctx.lineTo(a+c,l*n),a*=1.1}if(ctx.stroke(),Math.random()>.9){let r=Math.random()/2*e,s=-((.8+Math.random()/2)*e);ctx.strokeStyle=t.color,ctx.beginPath(),ctx.moveTo(r,s),ctx.lineTo(r+(Math.random()-.5)*e/4,s+Math.random()*e),ctx.stroke()}}function hqEarth(t,e){t.CalculateEffect(statTypes.moveSpeed),t.drawCycle=(t.drawCycle+1)%59;let i=t.drawCycle/59,n=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","F"],a=1.5*e/4,o=t.moving?a:0;for(let l=0;l<4;l++){let c=n[Math.ceil((1-i)*4)+4*l],r=a*(i+4-l),s=e+o*(1-i-4+l)/2-e;ctx.fillStyle=t.color2+c,ctx.beginPath(),ctx.arc(s,0,r,0,twoPi),ctx.fill()}let h=e/4,u=e/2,m=.7*u;t.moving,ctx.fillStyle=t.color,ctx.strokeStyle=t.color;let d=u,x=(Math.abs(t.drawCycle-29.5)-59/4)/59*h/2;ctx.beginPath(),ctx.moveTo(-h+x,h),ctx.lineTo(h+x,u),ctx.lineTo(h+x,u+h),ctx.lineTo(-u+x,h),ctx.moveTo(-h-x,-h),ctx.lineTo(h-x,-u),ctx.lineTo(h-x,-u-h),ctx.lineTo(-u-x,-h),ctx.fill(),ctx.lineWidth=e/16,ctx.beginPath(),ctx.moveTo(d+x,u-h/2),ctx.lineTo(d+x,u+h),ctx.moveTo(d-x,-u+h/2),ctx.lineTo(d-x,-u-h),ctx.stroke(),ctx.moveTo(d+x,u),ctx.lineTo(d+h+x,u),ctx.lineTo(d+1.2*h+x,u+h/2),ctx.lineTo(d+h+x,u+h),ctx.lineTo(d+x,u+h),ctx.closePath(),ctx.moveTo(d-x,-u),ctx.lineTo(d+h-x,-u),ctx.lineTo(d+1.2*h-x,-u-h/2),ctx.lineTo(d+h-x,-u-h),ctx.lineTo(d-x,-u-h),ctx.closePath(),ctx.fill(),ctx.strokeStyle=t.color2,ctx.lineWidth=e/8,ctx.beginPath(),ctx.moveTo(u,0),ctx.lineTo(m,m),ctx.lineTo(0,m),ctx.lineTo(-m,m),ctx.lineTo(-u,0),ctx.lineTo(-m,-m),ctx.lineTo(0,-m),ctx.lineTo(m,-m),ctx.closePath(),ctx.fill(),ctx.stroke()}function hqFire(t,e){t.drawCycle=(t.drawCycle+1)%55;let i=Math.abs(t.drawCycle-27.5)/55,n=-e/16,a=e/8,o=i*twoPi;ctx.lineWidth=e/12,ctx.strokeStyle=t.color,ctx.beginPath();for(let l=20;l<36;l++){let c=Math.cos(l*n+o);ctx.moveTo(-a+c,l*n),ctx.lineTo(a+c,l*n),a*=.92}ctx.stroke(),ctx.strokeStyle=t.color2,a=e,ctx.beginPath();for(let r=0;r<32;r++){let s=Math.cos(r*n-o);ctx.moveTo(-a+s+e/2,r*n),ctx.lineTo(a+s+e/2,r*n),ctx.moveTo(-a+s-e/2,r*n),ctx.lineTo(a+s-e/2,r*n),a*=.9}ctx.stroke(),ctx.lineWidth=n/2,ctx.strokeStyle=t.color+"7",a=e/2,ctx.beginPath();for(let h=0;h<16;h++){let u=Math.cos(h*n+o);ctx.moveTo(-a+u+e/2,h*n),ctx.lineTo(a+u+e/2,h*n),ctx.moveTo(-a+u-e/2,h*n),ctx.lineTo(a+u-e/2,h*n),a*=.8}ctx.stroke()}function hqWater(t,e){t.drawCycle=(t.drawCycle+1)%70;let i=Math.abs(t.drawCycle-35)/70;ctx.beginPath(),ctx.fillStyle=t.color2,ctx.moveTo(-(.7*e),-(.7*e)),ctx.lineTo(e*Math.cos(i*twoPi),-(2*e)),ctx.lineTo(.7*e,-(.7*e)),ctx.closePath(),ctx.arc(0,0,e,0,twoPi),ctx.closePath(),ctx.fill()}function DrawHighQualityMinion(t,e){ctx.save();let i=t.moveTarget?.x-t.Location.x,n=t.moveTarget?.y-t.Location.y,a=isNaN(i)||isNaN(n)?0:Math.atan2(n,i);ctx.translate(t.Location.x,t.Location.y),["Air","Fire","Water"].includes(t.type)||ctx.rotate(a);let o=.6*e;switch(t.type){case"Underling":hqUnderling(t,e/4);break;case"Mite":hqMite(t,.7*o);break;case"Imp":hqImp(t,.7*o);break;case"Bomber":hqBomber(t,1.2*o);break;case"Catapult":hqCatapult(t,1.2*o);break;case"Golem":hqGolem(t,.9*o);break;case"Harpy":hqHarpy(t,o);break;case"Ram":hqRam(t,1.2*o);break;case"Vampire":hqVampire(t,.7*o);break;case"Air":hqAir(t,1.5*o);break;case"Earth":hqEarth(t,2*o);break;case"Fire":hqFire(t,o);break;case"Water":hqWater(t,o)}ctx.restore(),t.DrawHUD()}function hqBasic(t,e){ctx.fillStyle=t.color2,ctx.strokeStyle=t.color,ctx.lineWidth=e/8,ctx.beginPath(),ctx.rect(-e/2,-e/2,e,e),ctx.fill();let i=e/4,n=e/2,a=Math.PI/4,o=0+a,l=Math.PI/2+a,c=Math.PI+a,r=3*Math.PI/2+a;ctx.rotate(t.aimTarget),ctx.beginPath(),ctx.arc(0,0,n,o,l),ctx.arc(0,0,i,l,c),ctx.arc(0,0,n,c,r),ctx.arc(0,0,i,r,o),ctx.closePath(),ctx.moveTo(i,0),ctx.lineTo(n+i,0),ctx.stroke()}function hqArtillery(t,e){let i=e/3,n=e/1.5;ctx.fillStyle=t.color2,ctx.beginPath(),ctx.arc(0,0,1.5*i,0,twoPi),ctx.fill(),ctx.fillStyle=t.color,ctx.strokeStyle=t.color2,ctx.lineWidth=e/12,ctx.beginPath(),ctx.rect(-i,-i,n,n),ctx.fill(),ctx.beginPath(),ctx.moveTo(0,i/2),ctx.lineTo(n,i/2),ctx.moveTo(0,-i/2),ctx.lineTo(n,-i/2),ctx.stroke()}function hqExplosion(t,e){ctx.strokeStyle=t.color,ctx.lineWidth=e/4,t.drawCycle=((t.drawCycle||0)+.01)%twoPi;let i=e/8,n=e/2,a=-(2.5*t.drawCycle),o=.7*t.drawCycle,l=Math.PI/2;ctx.fillStyle=t.color,ctx.beginPath(),ctx.ellipse(0,0,i,e,a,0,twoPi),ctx.ellipse(0,0,i,e,a+l,0,twoPi),ctx.ellipse(0,0,i,e,1.5*a,0,twoPi),ctx.ellipse(0,0,i,e,1.5*a+l,0,twoPi),ctx.fill(),ctx.fillStyle=t.color2,ctx.beginPath(),ctx.ellipse(0,0,i,n,0,0,twoPi),ctx.ellipse(0,0,i,n,l,0,twoPi),ctx.ellipse(0,0,i,n,o,0,twoPi),ctx.ellipse(0,0,i,n,o+l,0,twoPi),ctx.fill()}function hqIce(t,e){ctx.lineWidth=e/12,ctx.strokeStyle=t.color;let i=e/2,n=.87*i,a=twoPi/6;ctx.beginPath();for(let o=0;o<6;o++)ctx.rotate(a),ctx.moveTo(0,0),ctx.lineTo(i,0),ctx.moveTo(i,n),ctx.lineTo(i/2,0),ctx.lineTo(i,-n);ctx.stroke(),ctx.fillStyle=t.color2,ctx.beginPath(),ctx.moveTo(0,n/3),ctx.lineTo(.7*e,-n/4),ctx.lineTo(.7*e,n/4),ctx.lineTo(0,-n/3),ctx.closePath(),ctx.fill()}function hqLightning(t,e){let i=e/6;if(ctx.strokeStyle=t.color2,ctx.lineWidth=2*i,ctx.beginPath(),ctx.arc(0,0,3*i,0,twoPi),ctx.stroke(),ctx.strokeStyle=t.color,ctx.lineWidth=e/12,ctx.beginPath(),ctx.arc(0,0,i,.5,twoPi-.5),ctx.moveTo(0,0),ctx.lineTo(e,0),ctx.stroke(),Math.random()>.98){let n=Math.random()*twoPi,a=Math.cos(n),o=Math.sin(n);ctx.beginPath(),ctx.moveTo(a*i,o*i),ctx.lineTo(a*i*3,o*i*3),ctx.stroke()}}function hqPoison(t,e){let i=e/4,n=e/2;ctx.fillStyle=t.color2,ctx.strokeStyle="#000",ctx.lineWidth=e/8,ctx.beginPath(),ctx.arc(0,0,e/2,0,twoPi),ctx.fill(),ctx.stroke(),ctx.strokeStyle=t.color2,ctx.fillStyle=t.color,ctx.beginPath(),ctx.arc(i,i,n,15*Math.PI/8,Math.PI/2,1),ctx.arc(i,-i,n,3*Math.PI/2,Math.PI/8,1),ctx.fill(),ctx.stroke()}function hqSniper(t,e){let i=e/2;ctx.strokeStyle=t.color,ctx.lineWidth=e/8,ctx.fillStyle=t.color2,ctx.beginPath(),ctx.arc(0,0,i,0,twoPi),ctx.arc(0,0,i/2,0,twoPi),ctx.fill(),ctx.moveTo(i,0),ctx.lineTo(1.5*i,0),ctx.stroke()}function DrawHighQualityTower(t,e){ctx.save(),ctx.translate(t.Location.x,t.Location.y),["Basic"].includes(t.type)||ctx.rotate(t.aimTarget);let i=e;switch(t.type){case"Basic":hqBasic(t,i);break;case"Artillery":hqArtillery(t,i);break;case"Explosion":hqExplosion(t,i);break;case"Ice":hqIce(t,i);break;case"Lightning":hqLightning(t,i);break;case"Poison":hqPoison(t,i);break;case"Sniper":hqSniper(t,i)}ctx.restore(),t.DrawHUD()}function hqCleric(t,e){let i=t.CalculateEffect(statTypes.moveSpeed)/e,n=340*i**-.5/17;t.drawCycle=(t.drawCycle+t.moving)%n;let a=(Math.abs(t.drawCycle-n/2)-n/4)/n;ctx.beginPath(),ctx.fillStyle=t.color2;let o=e/4+a*e,l=e/2,c=e/4+-a*e,r=-e/2;ctx.ellipse(o,l,e/2,e,-1.5,0,twoPi),ctx.ellipse(c,r,e/2,e,1.5,0,twoPi),ctx.fill(),ctx.beginPath(),ctx.moveTo(o+e,l),ctx.lineTo(c+e,r),ctx.lineTo(c-e,r),ctx.lineTo(o-e,l),ctx.closePath(),ctx.fill();let s=Math.max(0,t.lastAttack)/t.CalculateEffect(statTypes.attackDelay)*10,h=4.75+a,u=s>1?1.5+a:s*(1.5+a),m=Math.cos(u)*e,d=Math.sin(u)*e*1.2,x=e/8;ctx.fillStyle="#420",ctx.beginPath(),ctx.moveTo(m-2*e,d-x/2),ctx.lineTo(m+e,d-x),ctx.lineTo(m+e,d+x),ctx.lineTo(m-2*e,d+x/2),ctx.closePath(),ctx.fill(),ctx.lineWidth=e/4,ctx.strokeStyle=t.color,ctx.beginPath(),ctx.arc(m+2*e,d,e/4,0,twoPi),ctx.moveTo(m+e,d),ctx.lineTo(m+1.8*e,d),ctx.moveTo(m+2*e,d+e/4),ctx.lineTo(m+2*e,d+e),ctx.moveTo(m+2*e,d-e/4),ctx.lineTo(m+2*e,d-e),ctx.moveTo(m+2.2*e,d),ctx.lineTo(m+3*e,d),ctx.stroke(),ctx.fillStyle="#753",ctx.beginPath(),ctx.arc(m,d,3*x,0,twoPi),ctx.fill(),ctx.beginPath(),ctx.arc(Math.cos(h)*e,Math.sin(h)*e*1.2,3*x,0,twoPi),ctx.fill();let f=3*e/4;ctx.fillStyle="#CCC",ctx.beginPath(),ctx.arc(e/8,0,f,Math.PI/2,3*Math.PI/2),ctx.lineTo(e,-(.8*f)),ctx.lineTo(e,.8*f),ctx.closePath(),ctx.fill(),ctx.strokeStyle=t.color,ctx.beginPath(),ctx.moveTo(e,.8*f),ctx.lineTo(e,-(.8*f)),ctx.stroke()}function hqMage(t,e){let i=t.CalculateEffect(statTypes.moveSpeed)/e,n=340*i**-.5/17;t.drawCycle=(t.drawCycle+t.moving)%n;let a=(Math.abs(t.drawCycle-n/2)-n/4)/n;ctx.beginPath(),ctx.fillStyle=t.color2;let o=e/4+a*e,l=e/2,c=e/4+-a*e,r=-e/2;ctx.ellipse(o,l,e/2,e,-1.5,0,twoPi),ctx.ellipse(c,r,e/2,e,1.5,0,twoPi),ctx.fill(),ctx.beginPath(),ctx.moveTo(o+e,l),ctx.lineTo(c+e,r),ctx.lineTo(c-e,r),ctx.lineTo(o-e,l),ctx.closePath(),ctx.fill();let s=Math.max(0,t.lastAttack)/t.CalculateEffect(statTypes.attackDelay)*10,h=4.75+a,u=s>1?1.5+a:s*(1.5+a),m=Math.cos(u)*e,d=Math.sin(u)*e,x=e/8;ctx.fillStyle="#420",ctx.beginPath(),ctx.moveTo(m-2*e,d-x/2),ctx.lineTo(m+1.5*e,d-x),ctx.lineTo(m+1.5*e,d+x),ctx.lineTo(m-2*e,d+x/2),ctx.closePath(),ctx.fill();let f=Date.now()/5%500;f=Math.abs(f-250)/500,ctx.lineWidth=e/8*(3*f+1),ctx.fillStyle=t.color+"9",ctx.strokeStyle=t.color,ctx.beginPath(),ctx.arc(m+2*e,d,e/2,0,twoPi),ctx.stroke(),ctx.fill(),ctx.fillStyle=t.color,ctx.beginPath(),ctx.arc(m,d,3*x,0,twoPi),ctx.fill();let g=Math.cos(h)*e,p=Math.sin(h)*e;ctx.beginPath(),ctx.arc(g,p,3*x,0,twoPi),ctx.fill(),ctx.fillStyle="#0003",ctx.strokeStyle="#0003",ctx.beginPath(),ctx.arc(m,d,3*x,0,twoPi),ctx.arc(g,p,3*x,0,twoPi),ctx.fill(),ctx.fillStyle=t.color,ctx.beginPath(),ctx.arc(0,0,e,0,twoPi),ctx.fill(),ctx.lineWidth=e/8,ctx.beginPath(),ctx.arc(0,0,e/2,Math.PI/2,3*Math.PI/2,1),ctx.lineTo(-e,0),ctx.closePath(),ctx.stroke()}function hqKnight(t,e){let i=t.CalculateEffect(statTypes.moveSpeed)/e,n=340*i**-.5/17;t.drawCycle=(t.drawCycle+t.moving)%n;let a=(Math.abs(t.drawCycle-n/2)-n/4)/n;t.moving?t.block=a+.25:(t.drawCycle=n/2,t.block=Math.max(0,t.block-.1)),ctx.beginPath(),ctx.fillStyle=t.color2,ctx.ellipse(e/4+a*e,e/2,e/2,e,-1.5,0,twoPi),ctx.fill(),ctx.beginPath(),ctx.fillStyle=t.color2,ctx.ellipse(e/4+-a*e,-e/2,e/2,e,1.5,0,twoPi),ctx.fill();let o=Math.max(0,t.lastAttack)/t.CalculateEffect(statTypes.attackDelay)*10,l=t.moving?4.75+a:5.5-t.block,c=o>1?1.5+a:o*(1.5+a),r=Math.cos(c)*e,s=Math.sin(c)*e,h=e/8;ctx.fillStyle="#777",ctx.beginPath(),ctx.moveTo(r-e/2,s-h),ctx.lineTo(r+2.3*e,s-h),ctx.lineTo(r+2.5*e,s),ctx.lineTo(r+2.3*e,s+h),ctx.lineTo(r-e/2,s+h),ctx.closePath(),ctx.moveTo(r+e/4,s-e/2),ctx.lineTo(r+e/2,s-e/2),ctx.lineTo(r+e/2,s+e/2),ctx.lineTo(r+e/4,s+e/2),ctx.closePath(),ctx.fill(),ctx.beginPath(),ctx.fillStyle=t.color,ctx.arc(r,s,3*h,0,twoPi),ctx.fill(),ctx.lineWidth=e/4,ctx.strokeStyle=t.color,ctx.beginPath(),ctx.arc(Math.cos(l)*e,Math.sin(l)*e,3*h,0,twoPi),ctx.fill(),ctx.beginPath(),ctx.arc(0,0,1.4*e,l-.75,l+.75),ctx.stroke();let u=3*e/4;ctx.beginPath(),ctx.fillStyle="#999",ctx.arc(0,0,u,0,twoPi),ctx.fill(),ctx.beginPath(),ctx.lineWidth=e/4,ctx.strokeStyle=t.color,ctx.moveTo(u,0),ctx.lineTo(-u,0),ctx.moveTo(0,u),ctx.lineTo(0,-u),ctx.stroke()}function DrawHighQualityHero(t,e){ctx.save(),ctx.translate(t.Location.x,t.Location.y);let i=t.moveTarget?.x-t.Location.x,n=t.moveTarget?.y-t.Location.y,a=isNaN(i)||isNaN(n)?0:Math.atan2(n,i);ctx.rotate(a);let o=3*e/4;switch(t.type){case"Cleric":hqCleric(t,o);break;case"Mage":hqMage(t,o);break;case"Knight":hqKnight(t,o)}ctx.restore(),t.DrawHUD()}function hqDeath(t,e){let i=t.CalculateEffect(statTypes.moveSpeed)/e,n=340*i**-.5/17;t.drawCycle=(t.drawCycle+t.moving)%n;let a=(Math.abs(t.drawCycle-n/2)-n/4)/n;ctx.beginPath(),ctx.fillStyle=t.color2;let o=e/4+a*e,l=e/3,c=e/4+-a*e,r=-e/3;ctx.ellipse(o,l,e/2,e,-1.5,0,twoPi),ctx.ellipse(c,r,e/2,e,1.5,0,twoPi),ctx.fill(),ctx.beginPath(),ctx.moveTo(o+e,l),ctx.lineTo(c+e,r),ctx.lineTo(c-e,r),ctx.lineTo(o-e,l),ctx.closePath(),ctx.fill();let s=t.lastAttack/t.CalculateEffect(statTypes.attackDelay)*10,h=4.75+a,u=s>1?1.5+a:s*(1.5+a),m=Math.cos(u)*e,d=Math.sin(u)*e*1.5,x=e/8;ctx.fillStyle="#420",ctx.beginPath(),ctx.moveTo(m-1.5*e,d-x/2),ctx.lineTo(m+2.5*e,d-x),ctx.lineTo(m+2.5*e,d+x),ctx.lineTo(m-1.5*e,d+x/2),ctx.closePath(),ctx.fill(),ctx.fillStyle="#000",ctx.beginPath(),ctx.ellipse(m+1.5*e,d,e,2*e,0,3*halfPi,twoPi),ctx.ellipse(m+1.5*e,d,e/2,2*e,0,twoPi,3*halfPi,1),ctx.fill(),ctx.strokeStyle="#999",ctx.lineWidth=e/8,ctx.beginPath(),ctx.ellipse(m+1.5*e,d,e/2,2*e,0,3*halfPi,twoPi),ctx.stroke();let f=Math.cos(h)*e,g=Math.sin(h)*e*1.4,p=e/12,y=p/2;ctx.strokeStyle="#BB8",ctx.lineWidth=p,ctx.beginPath(),ctx.moveTo(-p,e/2),ctx.lineTo(m-p,d-x),ctx.lineTo(m+p,d-x),ctx.lineTo(p,e/2),ctx.stroke(),ctx.lineWidth=y,ctx.beginPath(),ctx.moveTo(m-p,d-x),ctx.lineTo(m-p,d+x),ctx.moveTo(m-p+2*y,d-x),ctx.lineTo(m-p+2*y,d+x),ctx.moveTo(m+p,d-x),ctx.lineTo(m+p,d+x),ctx.stroke(),ctx.lineWidth=p,ctx.beginPath(),ctx.moveTo(-p,-e/2),ctx.lineTo(f-p,g+x),ctx.lineTo(f+p,g+x),ctx.lineTo(p,-e/2),ctx.stroke(),ctx.lineWidth=y,ctx.beginPath(),ctx.moveTo(f-p,g-x),ctx.lineTo(f-p,g+x),ctx.moveTo(f-p+2*y,g-x),ctx.lineTo(f-p+2*y,g+x),ctx.moveTo(f+p,g-x),ctx.lineTo(f+p,g+x),ctx.moveTo(f+p,g+x),ctx.lineTo(f+2.5*p,g+x),ctx.stroke(),ctx.fillStyle="#222",ctx.beginPath(),ctx.ellipse(0,0,e/2,e,0,0,twoPi),ctx.fill();let $=e/2;ctx.lineWidth=e/4,ctx.fillStyle="#333",ctx.beginPath(),ctx.arc(-e/8,0,$,Math.PI/2,3*Math.PI/2),ctx.lineTo(e,-(.8*$)),ctx.lineTo(e,.8*$),ctx.closePath(),ctx.fill(),ctx.strokeStyle="#222",ctx.beginPath(),ctx.moveTo(e,.8*$),ctx.lineTo(e,-(.8*$)),ctx.stroke()}function hqFamine(t,e){let i=t.CalculateEffect(statTypes.moveSpeed)/e,n=340*i**-.5/17;t.drawCycle=(t.drawCycle+1)%n;let a=(Math.abs(t.drawCycle-n/2)-n/4)/n,o=(Math.abs((t.drawCycle+3*n/4)%n-n/2)-n/4)/n,l=e,c=2*e,r=e/12,s=r/2,h=e/5,u=.525*c,m=1.9*l,d=.525*c,x=-(1.9*l);ctx.strokeStyle="#EFBA21",ctx.fillStyle="#EFBA21",ctx.lineWidth=r/2,ctx.beginPath(),ctx.moveTo(u+2*r,m+r),ctx.lineTo(u-.2*c,m+r),ctx.moveTo(u-.65*c,m+r+.55*c),ctx.lineTo(u-.35*c,m+r+.4*c),ctx.lineTo(u-.65*c,m+r+.25*c),ctx.moveTo(u-.65*c,m+r-.55*c),ctx.lineTo(u-.35*c,m+r-.4*c),ctx.lineTo(u-.65*c,m+r-.25*c),ctx.stroke(),ctx.lineWidth=r,ctx.beginPath(),ctx.arc(u-c,m+r,.8*c,-.55,.55),ctx.stroke(),ctx.beginPath(),ctx.arc(u-c/2,m+r+.4*c,.2*c,Math.PI-1,Math.PI+1),ctx.fill(),ctx.beginPath(),ctx.arc(u-c/2,m+r-.4*c,.2*c,Math.PI-1,Math.PI+1),ctx.fill(),ctx.lineWidth=r,ctx.strokeStyle="#BB8",ctx.beginPath(),ctx.moveTo(.65*c,-(1.4*l)),ctx.lineTo(.55*c,-(1.9*l)),ctx.lineTo(.5*c,-(1.9*l)),ctx.lineTo(.6*c,-(1.4*l)),ctx.moveTo(.65*c,1.4*l),ctx.lineTo(.55*c,1.9*l),ctx.lineTo(.5*c,1.9*l),ctx.lineTo(.6*c,1.4*l),ctx.stroke(),ctx.lineWidth=s,ctx.beginPath(),ctx.moveTo(u-r,m),ctx.lineTo(u-r,m+.7*h),ctx.moveTo(u-r+2*s,m),ctx.lineTo(u-r+2*s,m+.7*h),ctx.moveTo(u+r,m),ctx.lineTo(u+r,m+.7*h),ctx.moveTo(u+r,m),ctx.lineTo(u+2*r,m),ctx.stroke(),ctx.beginPath(),ctx.moveTo(d-r,x),ctx.lineTo(d-r,x-h),ctx.moveTo(d-r+2*s,x),ctx.lineTo(d-r+2*s,x-h),ctx.moveTo(d+r,x),ctx.lineTo(d+r,x-h),ctx.moveTo(d+r,x),ctx.lineTo(d+2.5*r,x),ctx.stroke(),ctx.fillStyle=t.color2+"77",ctx.strokeStyle=t.color,ctx.beginPath(),ctx.moveTo(0,-l),ctx.lineTo(-(.7*c),-(.9*l)+l*o),ctx.lineTo(-(1.5*c),-(.8*l)+l*a*1.5),ctx.lineTo(-(.7*c),-(.7*l)+l*o),ctx.lineTo(0,-(.6*l)),ctx.lineTo(-(.7*c),-(.5*l)-l*o),ctx.lineTo(-(1.7*c),-(.4*l)-l*a*1.5),ctx.lineTo(-(.7*c),-(.3*l)-l*o),ctx.lineTo(0,-(.2*l)),ctx.lineTo(-(.6*c),-(.1*l)-l*a),ctx.lineTo(-(1.3*c),0*l-l*o*1.5),ctx.lineTo(-(.6*c),.1*l-l*a),ctx.lineTo(0,.2*l),ctx.lineTo(-(.8*c),.3*l+l*o),ctx.lineTo(-(1.9*c),.4*l+l*a*1.5),ctx.lineTo(-(.8*c),.5*l+l*o),ctx.lineTo(0,.6*l),ctx.lineTo(-(.6*c),.7*l-l*a),ctx.lineTo(-(1.3*c),.8*l-l*o*1.5),ctx.lineTo(-(.6*c),.9*l-l*a),ctx.lineTo(0,l),ctx.closePath(),ctx.fill(),ctx.fillStyle=t.color2+"99",ctx.strokeStyle=t.color,ctx.beginPath(),ctx.moveTo(0,-(.8*l)),ctx.lineTo(-(.7*c),-(.7*l)-l*a),ctx.lineTo(-(1.4*c),-(.6*l)-l*o*1.5),ctx.lineTo(-(.7*c),-(.5*l)-l*a),ctx.lineTo(0,-(.4*l)),ctx.lineTo(-(.7*c),-(.3*l)+l*o),ctx.lineTo(-(1.6*c),-(.2*l)+l*a*1.5),ctx.lineTo(-(.7*c),-(.1*l)+l*o),ctx.lineTo(0,0),ctx.lineTo(-(.7*c),.1*l-l*a),ctx.lineTo(-(1.5*c),.2*l-l*o*1.5),ctx.lineTo(-(.7*c),.3*l-l*a),ctx.lineTo(0,.4*l),ctx.lineTo(-(.8*c),.5*l-l*o),ctx.lineTo(-(1.6*c),.6*l-l*a*1.5),ctx.lineTo(-(.8*c),.7*l-l*o),ctx.lineTo(0,.8*l),ctx.closePath(),ctx.fill(),ctx.fillStyle=t.color2,ctx.strokeStyle=t.color,ctx.beginPath(),ctx.moveTo(c,-l/2),ctx.lineTo(1.2*c,-(.4*l)),ctx.lineTo(1.3*c,-(.2*l)),ctx.lineTo(1.3*c,.2*l),ctx.lineTo(1.2*c,.4*l),ctx.lineTo(c,l/2),ctx.lineTo(.7*c,1.5*l),ctx.lineTo(-c,1.5*l+l*o),ctx.lineTo(-c/2,l+l*a),ctx.lineTo(-(.2*c),.7*l-l*a),ctx.lineTo(-(.8*c),.6*l-l*o),ctx.lineTo(-(1.2*c),.5*l+l*a*2),ctx.lineTo(-(.8*c),.4*l-l*o),ctx.lineTo(-(.2*c),.3*l-l*a),ctx.lineTo(-(.2*c),.2*l-l*a),ctx.lineTo(-(.8*c),.1*l-l*o),ctx.lineTo(-(1.5*c),l*a*2),ctx.lineTo(-(.8*c),-(.1*l)-l*o),ctx.lineTo(-(.2*c),-(.2*l)-l*a),ctx.lineTo(-c/2,-l-l*a),ctx.lineTo(-c,-(1.5*l)-l*o),ctx.lineTo(.7*c,-(1.5*l)),ctx.closePath(),ctx.fill()}function locust(t,e,i,n){ctx.strokeStyle=t.color2,ctx.fillStyle=t.color,ctx.lineWidth=1;let a=e/16,o=.4*e;ctx.beginPath(),ctx.moveTo(o,0),ctx.lineTo(.8*o,.8*a),ctx.lineTo(0,a),ctx.lineTo(-o,0),ctx.lineTo(0,-a),ctx.lineTo(.7*o,-(.8*a)),ctx.closePath(),ctx.fill(),ctx.beginPath(),ctx.moveTo(-o/2,a/2),ctx.lineTo(-o,a),ctx.lineTo(-(1.5*o),a),ctx.moveTo(-o/2,-a/2),ctx.lineTo(-o,-a),ctx.lineTo(-(1.5*o),-a),ctx.moveTo(0,a),ctx.lineTo(-o/4,1.5*a),ctx.lineTo(-(.7*o),2*a),ctx.moveTo(0,-a),ctx.lineTo(-o/4,-(1.5*a)),ctx.lineTo(-(.7*o),-(2*a)),ctx.moveTo(o/2,a),ctx.lineTo(.7*o,1.5*a),ctx.lineTo(o,2*a),ctx.moveTo(o/2,-a),ctx.lineTo(.7*o,-(1.5*a)),ctx.lineTo(o,-(2*a)),ctx.moveTo(.8*o,.7*a),ctx.lineTo(o,.7*a),ctx.lineTo(1.3*o,2*a),ctx.moveTo(.8*o,-(.7*a)),ctx.lineTo(o,-(.7*a)),ctx.lineTo(1.3*o,-(2*a)),ctx.stroke();let l=2*o;ctx.beginPath(),ctx.moveTo(.5*o,.8*a),ctx.lineTo(.7*o,l*i),ctx.arc(.6*o,.8*l*i,.2*o,halfPi,Math.PI),ctx.lineTo(.3*o,.8*a),ctx.closePath(),ctx.moveTo(.5*o,-(.8*a)),ctx.lineTo(.7*o,-l*i),ctx.arc(.6*o,-(.8*l)*i,.2*o,3*halfPi,Math.PI,1),ctx.lineTo(.3*o,-(.8*a)),ctx.closePath(),ctx.moveTo(.2*o,.9*a),ctx.lineTo(.2*o,l*n),ctx.arc(.1*o,.8*l*n,.2*o,halfPi,Math.PI),ctx.lineTo(-(.5*o),a),ctx.closePath(),ctx.moveTo(.2*o,-(.9*a)),ctx.lineTo(.2*o,-l*n),ctx.arc(.1*o,-(.8*l)*n,.2*o,3*halfPi,Math.PI,1),ctx.lineTo(-(.5*o),-a),ctx.closePath(),ctx.fill()}function swarm(t,e){let i=[];for(let n=0;n<5;n++){let a=Math.abs((t.drawCycle+200*n)%800-400)/800;i.push(a)}let o=twoPi/18;ctx.fillStyle=t.color+"3",ctx.beginPath();for(let l=0;l<18;l++){let c=i[l%i.length]*e/2+e,r=Math.cos(o*l)*c,s=Math.sin(o*l)*c;ctx.lineTo(r,s,e/2,0,twoPi)}ctx.closePath(),ctx.fill();let h=t.drawCycle%400/400*twoPi,u=t.drawCycle%128/128*twoPi,m=t.drawCycle%240/240*twoPi,d=t.drawCycle%365/365*twoPi,x=[h,u,m,d,m,u];ctx.fillStyle=t.color2;let f=e/18,g=[e/8,-e/4,-e/2,-e/8,e/4,-e/8],p=[-e/4,e/8,-e/4,-e/4,e/2,e/3],y=[5,6,4,5,3,7],$=[3,7,5,3,7,4];ctx.beginPath();for(let T=0;T<6;T++)for(let b=2;b<4;b++){let _=T>3?1:-1,w=g[T]+Math.cos(x[T]*b*_)*e*(b/y[T]),k=p[T]+Math.sin(x[T]*b*_)*e*(b/$[T]);ctx.fillRect(w,k,f,f)}}function hqPestilence(t,e){e*=2,t.drawCycle=(t.drawCycle+(t.moving?1:.5))%16777216,ctx.fillStyle=t.color,swarm(t,e+1.5);let i=Math.abs(t.drawCycle%10-5)/10*1.5+.25,n=Math.abs(t.drawCycle%5-2.5)/5*2;ctx.translate(e/4,0),locust(t,e/2,i,n),ctx.translate(-e/2,e/3),locust(t,e/4,i,n),ctx.translate(0,-e),locust(t,e/3,i,n),ctx.translate(.7*e,0),locust(t,e/4,i,n)}function hqWar(t,e){e*=1.2,ctx.translate(-e,0);let i=t.CalculateEffect(statTypes.moveSpeed)/e,n=340*i**-.5/17;t.drawCycle=(t.drawCycle+(t.moving?1:0))%n;let a=(Math.abs(t.drawCycle-n/2)-n/4)/n,o=Math.PI,l=o-.3,c=o+.3,r=3*e/4,s=e/2+a*e,h=3*e/4;ctx.fillStyle="#000",ctx.beginPath(),ctx.ellipse(s,h,r,r/2,0,l,-.5),ctx.fill(),ctx.beginPath(),ctx.ellipse(s,h,r,r/2,0,.5,c),ctx.fill();let u=e/2+-a*e,m=-h;ctx.beginPath(),ctx.ellipse(u,m,r,r/2,0,l,-.5),ctx.fill(),ctx.beginPath(),ctx.ellipse(u,m,r,r/2,0,.5,c),ctx.fill();let d=t.lastAttack/t.CalculateEffect(statTypes.attackDelay)*5,x=1.5+a,f=4.75+a,g=Math.cos(x)*e+e,p=Math.sin(x)*e,y=Math.cos(f)*e+e,$=Math.sin(f)*e,T=e/8;ctx.lineWidth=e/4,ctx.fillStyle="#777",ctx.strokeStyle="#AAA";let b=.5*(t.attackHand&&d<1?(d-.5)*2:1);ctx.rotate(b);let _=3*e/4;ctx.beginPath(),ctx.arc(g+2*e,p,_,.5,Math.PI-.5),ctx.stroke(),ctx.beginPath(),ctx.arc(g+2*e,p,_,Math.PI+.5,twoPi-.5),ctx.stroke(),ctx.beginPath(),ctx.arc(g+2*e,p,_,Math.PI-.5,.5,1),ctx.arc(g+2*e,p,_,Math.PI+.5,twoPi-.5),ctx.closePath(),ctx.fill(),ctx.fillStyle="#420",ctx.beginPath(),ctx.moveTo(g-e/2,p-T),ctx.lineTo(g+2*e+_,p-T),ctx.lineTo(g+2*e+_,p+T),ctx.lineTo(g-e/2,p+T),ctx.closePath(),ctx.fill(),ctx.fillStyle=t.color2,ctx.beginPath(),ctx.arc(g,p,3*T,0,twoPi),ctx.ellipse(g/2,p/2,e/2,e/4,x-.5,0,twoPi),ctx.fill(),ctx.rotate(-b),ctx.fillStyle="#777",ctx.strokeStyle="#AAA";let w=.5*(!t.attackHand&&d<1?(d-.5)*2:1);ctx.rotate(-w),ctx.beginPath(),ctx.arc(y+2*e,$,_,.5,Math.PI-.5),ctx.stroke(),ctx.beginPath(),ctx.arc(y+2*e,$,_,Math.PI+.5,twoPi-.5),ctx.stroke(),ctx.beginPath(),ctx.arc(y+2*e,$,_,Math.PI-.5,.5,1),ctx.arc(y+2*e,$,_,Math.PI+.5,twoPi-.5),ctx.closePath(),ctx.fill(),ctx.fillStyle="#420",ctx.beginPath(),ctx.moveTo(y-e/2,$-T),ctx.lineTo(y+2*e+_,$-T),ctx.lineTo(y+2*e+_,$+T),ctx.lineTo(y-e/2,$+T),ctx.closePath(),ctx.fill(),ctx.fillStyle=t.color2,ctx.beginPath(),ctx.arc(y,$,3*T,0,twoPi),ctx.ellipse(y/2,$/2,e/2,e/4,f+.5,0,twoPi),ctx.fill(),ctx.rotate(w),ctx.translate(-e/4,0),ctx.fillStyle=t.color,ctx.beginPath(),ctx.arc(e,0,.4*e,0,twoPi),ctx.ellipse(0,0,e/2,3*e/4,0,0,twoPi),ctx.fill(),ctx.lineWidth=e/4,ctx.strokeStyle=t.color2,ctx.beginPath();let k=e/3;ctx.moveTo(e,k),ctx.lineTo(k,e/2),ctx.lineTo(k,-e/2),ctx.lineTo(e,-k),ctx.closePath(),ctx.fill(),ctx.strokeStyle="#FF0",ctx.lineWidth=e/12,ctx.beginPath(),ctx.ellipse(1.5*e,0,e/6,e/4,0,Math.PI+.5,Math.PI-.5),ctx.stroke(),ctx.fillStyle="#000",ctx.beginPath(),ctx.ellipse(.5*e,.3*e,e/12,e/8,.5,0,twoPi),ctx.ellipse(.5*e,-(.3*e),e/12,e/8,-.5,0,twoPi),ctx.fill();let v=[{x:.1,y:.5,s:.15},{x:.3,y:.8,s:.15},{x:.4,y:.9,s:.14},{x:.6,y:.8,s:.13},{x:.8,y:.6,s:.1},{x:1,y:.5,s:.07},{x:1.5,y:.5,s:.04}];ctx.strokeStyle="#CCC";for(let P=1;P<v.length;P++){let S=v[P-1].x*e,E=v[P-1].y*e,C=v[P].x*e,L=v[P].y*e;ctx.lineWidth=v[P].s*e,ctx.beginPath(),ctx.moveTo(S,E),ctx.lineTo(C,L),ctx.moveTo(S,-E),ctx.lineTo(C,-L),ctx.stroke()}}function DrawHighQualityBoss(t,e){ctx.save(),ctx.translate(t.Location.x,t.Location.y);let i=t.moveTarget?.x-t.Location.x,n=t.moveTarget?.y-t.Location.y,a=isNaN(i)||isNaN(n)?0:Math.atan2(n,i);ctx.rotate(a);let o=e/3;switch(t.type){case"Death":hqDeath(t,o);break;case"Famine":hqFamine(t,o);break;case"Pestilence":hqPestilence(t,o);break;case"War":hqWar(t,o)}ctx.restore(),t.DrawHUD()}function createNewElement(t,e,i,n,a){if(!i)return console.error("parent is null for "+e),null;let o=document.getElementById(e);if(o)return a&&setElementTextById(e,a,!0),o;(o=document.createElement(t)).id=e;for(let l=0;l<n.length;l++)o.classList.add(n[l]);return a&&(o.textContent=a),i.appendChild(o),o}function addOnclick(t,e){null!==t&&null!==e&&(t.onclick=e)}function initialize_components(){try{initialSize(),populateInfo(),populateResourceNames(),createTierUpgrades(),createGaugesTable(),createBossTab(),createStoreStock(),createAchievemetsTab(),resetInputs(),loadURL()||loadCookieData(),createMinionSpawns(),buildWorld(),updateT0(),updateT1(),updateT2(),updateT3(),updateT4(),updateBossTab(),toggleTierItems(),setColorblind(),cookiesEnabled||(getUIElement("btnMnuArmory").click(),document.getElementById("introModal").classList.remove("hide")),window.addEventListener("beforeunload",t=>{cookiesEnabled&&mainCycle>0&&autoSave()&&saveData()}),window.addEventListener("focus",t=>{drawMap()}),drawMap()}catch(t){console.trace(),console.error(t),alert("Init Error, see console for details. Game not initialized.");return}start(defaultInterval)}function initialSize(){let t=Math.max(document.documentElement.clientHeight),e=Math.max(document.documentElement.clientWidth),i=Math.min(e,2.4*t)-10;gameW=i,gameH=i/4,langoliers=-(gameW>>3),halfH=gameH/2,leaderPoint=gameW/2,pathL=gameW>>6,pathW=gameH>>2;let n=document.getElementById("unitLayer");n.style.width=gameW,n.style.height=gameH,n.width=gameW,n.height=gameH;let a=getUIElement("mapLayer");a.style.width=gameW,a.style.height=gameH,a.width=gameW,a.height=gameH,pnl0.style.height=gameH+"px",pnl1.style.top=gameH+5+"px",pnl1.style.height=t-gameH-15+"px",getUIElement("resourceBox").style.top=gameH+5+"px"}function buildWorld(){minions.length=0,minionOrder.length=0,boss=null,path.length=0,towers.length=0,hero=null,squire=null,page=null,totalPaths=totalPaths||0,level=level||0,buildPath(),initialMinions(),initialTowers(),levelStartX=getEndOfLevelX(level-1),levelEndX=getEndOfLevelX(level),initialQuid(),addHero(),drawMap()}function buildPath(){for(path[0]=new point(-(2*pathL),halfH);path.length>0&&path[path.length-1].x<gameW+2*pathL;)addPathPoint(!0);buildAccents()}function buildAccents(){for(addAccent();accents.length>0&&accents[accents.length-1].loc.x<gameW+2*pathL;)addAccent()}function addQuid(){let t=(-(Math.random()**.3*1)+1)*gameW,e=(Math.random()-.5)*pathW,i=getPathYatX(t);quid.push(new point(t,i+e))}function initialQuid(){sinceQuid=0,quid.length=0;let t=achievements.prestige0.count**.4+4;for(let e=0;e<t;e++)addQuid()}function populateResourceNames(){setElementTextById("spnResourceAName",resources.a.name,!1),setElementTextById("spnResourceBName",resources.b.name,!1),setElementTextById("spnResourceCName",resources.c.name,!1),setElementTextById("spnResourceDName",resources.d.name,!1),setElementTextById("spnResourceEName",resources.e.name,!1),setElementTextById("spnResourceFName",resources.f.name,!1),setElementTextById("spnResourceASymbol",resources.a.symbol,!1),setElementTextById("spnResourceBSymbol",resources.b.symbol,!1),setElementTextById("spnResourceCSymbol",resources.c.symbol,!1),setElementTextById("spnResourceDSymbol",resources.d.symbol,!1),setElementTextById("spnResourceESymbol",resources.e.symbol,!1),setElementTextById("spnResourceFSymbol",resources.f.symbol,!1)}function initialMinions(){for(let t in minionUpgrades){let e=minionUpgrades[t].initialMinions;for(let i=0;i<e;i++)addMinionQ.push(t)}}function initialTowers(){let t=-1,e=0;for(;towers.length!=t&&e++<50;)t=towers.length,addTower()}function createMinionSpawns(){let t=document.getElementById("divSpawnPool");for(let e in minionResearch){let i=`div${e}Spawn`,n=`chkSpawn${e}`,a=i+"Progress",o=createNewElement("div",i,t,["spawnPoolRow"],null);createNewElement("span",i+"HK",o,["HK"],`[${minionResearch[e].hotkey}]`);let l=createNewElement("input",n,o,[],null);l.type="checkbox",l.checked=minionResearch[e].isUnlocked;let c=createNewElement("div",i+"Back",o,["progressBackground"],null);c.style.backgroundColor="#777";let r=createNewElement("div",a,c,["progressBar"],e);r.style.backgroundColor=baseMinion[e].color,r.style.color=baseMinion[e].color2||"#000",minionSpawns[e]=new MinionSpawnChildren(o,l,r)}}function createBossTab(){let t=document.getElementById("ulBossSelectList");for(let e in document.getElementById("divActiveData"),unlockBossCost(),baseBoss){let i=createNewElement("li","li"+e,t,["bossListItem"],null),n=createNewElement("div",`div${e}SpawnBackground`,i,["progressBackground","bossProgressBackground"],null),a=createNewElement("div",`div${e}SpawnProgress`,n,["progressBar"],null),o=`select${e}`,l=createNewElement("input",o,a,[],null);l.type="radio",l.name="bossSelect",l.value=e;let c=createNewElement("label",o+"Label",a,["bossSelectLabel"],e+" ");c.for=o,addOnclick(i,function(){l.checked=!0}),bossUIs.push(new BossUIElements(e,l,c,a,n))}}function createStoreStock(){let t=document.getElementById("divBombStock"),e=document.getElementById("storeDetailsBody");for(let[i,n]of Object.entries(bombTypes))createStoreButton(i,n.text,t),buildBombRow(i,e);createResourceConvertButton("a"),createResourceConvertButton("b"),createResourceConvertButton("c"),createResourceConvertButton("d")}function createResourceConvertButton(t){let e=resources[t],i=document.getElementById("divExchange"),n="1 "+e.name,a="Exchange"+e.name,o=createMiscButton(a,i,n,1,resources.f.symbol);o.value=1,o.rType=t,addOnclick(o,function(){exchange(this)}),setButtonAffordableClass(o,!0)}function createStoreButton(t,e,i){let n=createNewElement("button","btnStore"+t,i,["storeButton"],e),a=`./Images/${t}.png`;if(fileExists(a)){let o=createNewElement("img","btnImg"+t,n,["storeButtonImg"],null);o.src=a,o.alt=e}n.value=t,addOnclick(n,function(){buyBomb(t)})}function createUpgrades(t,e,i,n){let a=minionUpgradeTypes[t];for(let o in baseMinion){let l=`div${o}T${t}UpgradeList`,c=createNewElement("div",l,e,["listBlock"],null),r=new UpgradeList(o,l,c),s=o;for(let h in createNewElement("div",l+"Header",c,["listBlockHeader"],s),a){let u=a[h],m=`Upg${o}${u}`;createUpgradeButton(m,c,o,u,n,r)}i.push(r)}}UnitStats.prototype.buildHTMLRow=function(t){let e=createNewElement("tr","statsRow"+this.type,t,[],null);createNewElement("td","srType"+this.type,e,[],this.type),createNewElement("td","srDeploy"+this.type,e,[],formatDeployCount(this.deployCount,this.unitCount)),createNewElement("td","srDone"+this.type,e,[],this.getDamageDone()),createNewElement("td","srTaken"+this.type,e,[],this.getDamageTaken()),createNewElement("td","srHealing"+this.type,e,[],this.getHealingDone()),createNewElement("td","srDonePerDeploy"+this.type,e,[],this.getDamageDonePerDeploy()),createNewElement("td","srTakenPerDeploy"+this.type,e,[],this.getDamageTakenPerDeploy()),createNewElement("td","srHealingPerDeploy"+this.type,e,[],this.getHealingDonePerDeploy())},UnitStats.prototype.updateHTMLRow=function(t){if(null==document.getElementById("srType"+this.type)){this.buildHTMLRow(t);return}setElementTextById("srDeploy"+this.type,formatDeployCount(this.deployCount,this.unitCount)),setElementTextById("srDone"+this.type,this.getDamageDone()),setElementTextById("srTaken"+this.type,this.getDamageTaken()),setElementTextById("srHealing"+this.type,this.getHealingDone()),setElementTextById("srDonePerDeploy"+this.type,this.getDamageDonePerDeploy()),setElementTextById("srTakenPerDeploy"+this.type,this.getDamageTakenPerDeploy()),setElementTextById("srHealingPerDeploy"+this.type,this.getHealingDonePerDeploy())};const unitsByUnlockT=function(t){if(3==t)return bossResearch;let e={},i=Object.entries(minionResearch).filter(e=>e[1].unlockT==t);for(let n in i){let a=i[n][0],o=i[n][1];e[a]=o}return e};function createUnlocks(t,e,i){let n=new UnlockList(t),a=unitsByUnlockT(t),o=3==t?"Boss":"Minion";for(let l in a)createUnlockButton(e,l,o,i,n);unlockButtons.push(n)}function createMiscBuy(t,e,i){let n=new TierMiscButtons(t),a=tierMisc["t"+t].miscUpgrades;for(let o in a)createTierUpgradeButton(t,o,e,a[o],i,n);miscTierButtons.push(n)}function createPrestige(t,e,i,n){let a=document.getElementById("divPrestige"+t),o=createPrestigeButton(t,a,e,i,prestigeButtons);o.setAttribute("tier",t);let l=getUIElement(`divPrestige${t}GainSymbol`);setElementText(l,n,!1)}function createPanelButtons(t,e,i,n,a){let o=document.getElementById(`divMinionT${t}UpgradeTable`);null!==o&&createUpgrades(t,o,i,e);let l=document.getElementById(`divMiscT${t}Upgrades`);createMiscBuy(t,l,e),createUnlocks(t,l,e),n&&createPrestige(t,n,e,a),l.parentNode.appendChild(l)}const buttonBase=function(t,e,i,n){let a="btn"+t,o=createNewElement("button",a,e,["upg"],null),l=createNewElement("div","div"+t+"cost",o,["upgCostDiv"],null);createNewElement("label",a+"Type",o,["partialLabel"],i.fixString());let c=createNewElement("label","lbl"+t+"cost",l,["partialLabel"],"-");return createNewElement("label",a+"Unit",l,["partialLabel"],n),{b:o,l:c}};function createUpgradeButton(t,e,i,n,a,o){let l=buttonBase(t,e,n,a),c=l.b,r=l.l,s=createNewElement("div","div"+t+"Lvl",c,[],null),h=createNewElement("label","lbl"+t+"Potency",s,["partialLabel"],"x1"),u=createNewElement("label","lbl"+t+"Lvl",s,["partialLabel"],"0");createNewElement("label","lbl"+t+"S",s,["partialLabel"],"/");let m=createNewElement("label","lbl"+t+"Maxlvl",s,["partialLabel"],"0"),d=createNewElement("Label","lbl"+t+"Perk",s,["partialLabel"],"0");return o.upgrades.push(new UpgradeIds(n,c,r,u,m,h,d)),addOnclick(c,function(){upgrade(this.id)}),c.setAttribute("minionType",i),c.setAttribute("upgradeType",n),c}function createEnhancementButton(t,e,i,n,a,o){let l=buttonBase(t,e,n,a),c=l.b,r=l.l,s=createNewElement("div","div"+t+"Lvl",c,[],null),h=createNewElement("label","lbl"+t+"Potency",s,["partialLabel"],"x1"),u=createNewElement("label","lbl"+t+"Lvl",s,["partialLabel"],"0");createNewElement("label","lbl"+t+"S",s,["partialLabel"],"/");let m=createNewElement("label","lbl"+t+"Maxlvl",s,["partialLabel"],"0"),d=createNewElement("Label","lbl"+t+"Perk",s,["partialLabel"],"0");return o.upgrades.push(new UpgradeIds(n,c,r,u,m,h,d)),addOnclick(c,function(){upgrade(this.id)}),addOnclick(c,function(){enhance(this.id)}),c.setAttribute("bossType",i),c.setAttribute("upgradeType",n),c}function createUnlockButton(t,e,i,n,a){let o=buttonBase("Unlock"+e,t,"Unlock "+e,n),l=o.b,c=o.l;return a.unlocks.push(new UnlockIds(e,l,c)),addOnclick(l,function(){unlock(this.id)}),l.setAttribute("unlockType",e),l.setAttribute("unlockCategory",i),l}function createTierUpgradeButton(t,e,i,n,a,o){let l=e,c=buttonBase(l,i,n,a),r=c.b,s=c.l;return o.buttons.push(new MiscButton(l,r,s)),addOnclick(r,function(){buy(this.id,t)}),r.setAttribute("purchaseType",e),r.setAttribute("tier",t),r}function createPrestigeButton(t,e,i,n,a){let o=buttonBase("Prestige"+t,e,i,n),l=o.b,c=o.l,r=document.getElementById(`divPrestige${t}Gain`);return a.push(new PrestigeButton(t,l,c,r)),addOnclick(l,function(){prestige(this.id)}),l}function createMiscButton(t,e,i,n,a){let o="btn"+t,l=createNewElement("button",o,e,["upg"],null);l.cost=n;let c=createNewElement("div","div"+t+"cost",l,["upgCostDiv"],null);return createNewElement("label",o+"Type",l,["partialLabel"],i.fixString()),createNewElement("label","lbl"+t+"cost",c,["partialLabel"],n),createNewElement("label",o+"Unit",c,["partialLabel"],a),l}function createTierUpgrades(){createPanelButtons(0,resources.a.symbol,t0Upgrades,"Regroup",resources.b.symbol),createPanelButtons(1,resources.b.symbol,t1Upgrades,"Research",resources.c.symbol),createPanelButtons(2,resources.c.symbol,t2Upgrades,"Recruit",resources.d.symbol),createPanelButtons(3,resources.d.symbol,t3Upgrades,"Restructure",resources.e.symbol),createPanelButtons(4,resources.e.symbol,t4Upgrades,null,resources.f.symbol),createBossButtons()}function createBossButtons(){let t=document.getElementById("divBossEnhancements");for(let e in baseBoss){let i=bossUpgrades[e],n=`div${e}EnhanceList`,a=createNewElement("div",n,t,["listBlock"],null),o=e;createNewElement("div",n+"Header",a,["listBlockHeader"],o);let l=new UpgradeList(e,n,a);for(let c in i){getEnhanceCost(e,c);let r=`Upg${e}${c}`;createEnhancementButton(r,a,e,c,resources.d.symbol,l)}t3BossUpgrades.push(l)}}function createGaugesTable(){let t=document.getElementById("tblGauges"),e=t.createTHead(),i=e.insertRow();for(let n in i.insertCell(),unitTypes){let a=document.createElement("th");a.textContent=n,i.appendChild(a),"Boss"==n&&a.classList.add("t3")}for(let o in gauges){let l=t.insertRow();l.id="row"+o;let c=document.createElement("th");for(let r in c.textContent=o,l.appendChild(c),unitTypes){let s=document.createElement("td");l.appendChild(s),"Boss"==r&&s.classList.add("t3");let h=`chk${o}${r}`,u=createNewElement("input",h,s,[],null);u.setAttribute("unitType",r),u.setAttribute("gaugeType",o),u.type="checkbox"}}}function createAchievement(t,e,i){let n="divAch"+t,a=createNewElement("div",n,i,["listBlock","feat","t"+achievements[t].unlockT],null),o=getAchievementLevel(t),l=getAchievementNext(t),c=createNewElement("div",n+"Header",a,["listBlockHeader"],null);createNewElement("label",c.id+"Name",c,["partialLabel"],e.fixString());let r=createNewElement("label",c.id+"Level",c,["partialLabel","upgCostDiv"],o||"0");createNewElement("label",c.id+"Spacer",c,["partialLabel","upgCostDiv"],"-");let s=createNewElement("label",c.id+"MaxCount",c,["partialLabel","upgCostDiv"],achievements[t].maxCount||"0"),h=createNewElement("div",n+"Body",a,[],null),u=createNewElement("label",h.id+"Current",h,["partialLabel"],achievements[t].count||"0");createNewElement("label",h.id+"Slash",h,["partialLabel"],"/");let m=createNewElement("label",h.id+"Target",h,["partialLabel"],l),d=`Perk: ${achievements[t].bonus}`;createNewElement("div",n+"Footer",a,[],d),achievementElements.push(new AchievementElement(t,r,s,u,m))}function createAchievemetsTab(){let t=document.getElementById("divAchievementTable");for(let e in achievements)createAchievement(e,achievements[e].name,t)}const htmlDecode=function(){let t=document.implementation.createHTMLDocument(""),e=t.createElement("div");function i(t){return e.innerHTML=t,t=e.textContent,e.textContent="",t}return function t(e){if(e&&"string"==typeof e){let n=i(e);for(;e!==n;)e=n,n=i(n);return n}}}();function populateInfo(){let t=document.getElementById("divInfo"),e=createNewElement("div","divInfoTeam0",t,[],null),i=createNewElement("div","divInfoTeam1",t,[],null);for(let n in baseBoss)baseBoss[n].symbol=htmlDecode(baseBoss[n].symbol);for(let a in baseHero)baseHero[a].symbol=htmlDecode(baseHero[a].symbol);for(let o in baseMinion)baseMinion[o].symbol=htmlDecode(baseMinion[o].symbol);createInfoTable(e,"Minion",baseMinion),createInfoTable(e,"Boss",baseBoss),createInfoTable(i,"Tower",baseTower),createInfoTable(i,"Hero",baseHero);let l=document.getElementById("tblBossInfo");l&&l.classList.add("t3")}function createInfoTable(t,e,i){let n=`tbl${e}Info`,a=createNewElement("table",n,t,["infoTable"],null),o=a.insertRow().insertCell();for(let l in o.colSpan=4,o.style.fontWeight="bold",o.style.textAlign="center",o.textContent=`${e} Info`,i){let c=a.insertRow();"Minion"==e&&c.classList.add("t"+minionResearch[l].unlockT);let r=c.insertCell(0);r.id=e+"_"+l,r.textContent=l,r.setAttribute("unitType",e),r.setAttribute("unit",l),r.classList.add("pointer"),addOnclick(r,function(){unitDetails(this.id)});let s=c.insertCell(1),h=htmlDecode(unitTypes[e].infoSymbol);unitTypes[e].uniqueSymbol&&(h=i[l].symbol||h),s.textContent=h,s.style.color=i[l].color,s.style.backgroundColor=i[l].color2||"#000",s.style.fontWeight="bold",s.classList.add("cbh");let u=c.insertCell(2),m=`./Images/${l}.png`,d=`img${l}`,x=createNewElement("img",d,u,["unitImg"],null);x.src=m,x.alt=l+" Image";let f=c.insertCell(3);f.textContent=i[l].info}}function unitDetails(t){let e=document.getElementById(t),i=e.getAttribute("unitType"),n=e.getAttribute("unit");toggleUIElementByID("infoModal",!1),setElementTextById("infoModalHeader",`${i}: ${n}`,!0);let a=[];switch(i){case"Minion":a=getMinionUpgradedStats(n);break;case"Boss":a=getBossUpgradedStats(n);break;case"Tower":a=getTowerUpgradedStats(n);break;case"Hero":a=getHeroUpgradedStats(n);break;default:console.warn("unkown unit type:"+i)}let o=document.getElementById("tblInfoBody");clearChildren(o);for(let l=0;l<a.length;l++){if(isNaN(a[l].base)||0==a[l]||a[l].stat!==statTypes.health&&a[l].stat!==statTypes.damage&&1===a[l].prod)continue;a[l].stat,statTypes.minionsPerDeploy;let c=createNewElement("tr","infoRow"+l,o,[]),r=createNewElement("td","statRow"+l,c,[],a[l].stat.fixString()),s=createNewElement("td","prodRow"+l,c,[],a[l].prod);r.title=statDescription[a[l].stat],s.title=`Base:${a[l].base}  Scale:${a[l].mult}  Upgrades:${a[l].upg}`}}initialize_components();