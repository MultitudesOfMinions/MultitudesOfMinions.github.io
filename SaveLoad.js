//current week
//eyJ0IjoyNDIzMzEsInIiOnsiYSI6MTYsImIiOjUsImMiOjE5fSwibXIiOnsibSI6MzM3LCJjIjo4NjUsImciOjI3NSwiaCI6ODY1LCJhIjo4NjV9LCJtdSI6eyJtIjp7ImhwIjozMCwiZCI6MzAsIm1zIjoyLCJhdCI6Miwic3IiOjJ9LCJjIjp7ImhwIjozMCwiZCI6MzAsIm1zIjoyLCJhdCI6Miwic3IiOjJ9LCJnIjp7ImhwIjozMCwiZCI6MzAsIm1zIjoxLCJhdCI6MSwic3IiOjF9LCJoIjp7ImhwIjozMCwiZCI6MzAsIm1zIjoxLCJhdCI6MSwic3IiOjF9LCJhIjp7ImhwIjoyNiwiZCI6MjYsIm1zIjoyLCJhdCI6Miwic3IiOjJ9fSwiZyI6WyJSYSIsIlJlIiwiSFAiLCJEIl0sImEiOnsiQW0iOjM4MywiQXQiOjQ3NiwiQWsiOjksIkEwIjo2LCJBMSI6MX0sInRtIjp7InQwIjp7ImFiIjoxLCJwIjozfX0sIm0iOnsibCI6MiwibW0iOjMsInVsIjoxMSwiZ3NyIjozfX0=
//eyJ0IjoyNDM0MzEsInIiOnsiYiI6MzksImMiOjE5fSwibXIiOnsibSI6MTc4LCJiIjo4MCwiYyI6ODgxLCJnIjo3ODEsImgiOjk4MSwiciI6MTgwLCJ2IjoyODAsImEiOjk4MX0sIm11Ijp7Im0iOnsiaHAiOjE2LCJkIjoxNiwibXMiOjQsImF0Ijo0LCJzciI6NH0sImIiOnsiaHAiOjEyLCJkIjoxMiwibXMiOjQsImF0Ijo0LCJzciI6NH0sImMiOnsiaHAiOjEyLCJkIjoxMiwibXMiOjQsImF0Ijo0LCJzciI6NH0sImciOnsiaHAiOjEyLCJkIjoxMiwibXMiOjQsImF0Ijo0LCJzciI6NH0sImgiOnsiaHAiOjEyLCJkIjoxMiwibXMiOjUsImF0Ijo1LCJzciI6NX0sInIiOnsiaHAiOjEyLCJkIjo4LCJtcyI6NCwiYXQiOjQsInNyIjo0fSwidiI6eyJocCI6OCwiZCI6OCwibXMiOjQsImF0Ijo0LCJzciI6NH0sImEiOnsiaHAiOjgsImQiOjgsIm1zIjo0LCJhdCI6NCwic3IiOjR9fSwiZyI6WyJSYSIsIlJlIiwiSFAiLCJEIl0sImEiOnsiQW0iOjE0LCJBdCI6MTE1OSwiQWsiOjIxLCJBMCI6MTEsIkExIjoxfSwidG0iOnsidDAiOnsiYWIiOjEsInAiOjN9fSwibSI6eyJtbSI6MywidWwiOjExLCJnc3IiOjN9fQ==
//eyJ0IjoyNDY0MjMsInIiOnsiYSI6NDYsImIiOjQzLCJjIjoxOX0sIm1yIjp7Im0iOjM4NCwiYiI6MzM2LCJjIjo5OTMsImciOjU5NiwiaCI6OTg5LCJyIjo4ODQsInYiOjc4MSwiYSI6OTg5fSwibXUiOnsibSI6eyJocCI6MjgsImQiOjI4LCJtcyI6NCwiYXQiOjQsInNyIjo0fSwiYiI6eyJocCI6MjgsImQiOjI4LCJtcyI6NCwiYXQiOjQsInNyIjo0fSwiYyI6eyJocCI6MjgsImQiOjI4LCJtcyI6NSwiYXQiOjUsInNyIjo1fSwiZyI6eyJocCI6MjgsImQiOjI0LCJtcyI6NSwiYXQiOjUsInNyIjo1fSwiaCI6eyJocCI6MjQsImQiOjI0LCJtcyI6NSwiYXQiOjUsInNyIjo1fSwiciI6eyJocCI6MjQsImQiOjI0LCJtcyI6NCwiYXQiOjQsInNyIjo0fSwidiI6eyJocCI6MjQsImQiOjI0LCJtcyI6NSwiYXQiOjUsInNyIjo0fSwiYSI6eyJocCI6MjQsImQiOjI0LCJtcyI6NCwiYXQiOjQsInNyIjo0fX0sImciOlsiUmEiLCJSZSIsIkhQIiwiRCJdLCJhIjp7IkFtIjo0MDQsIkF0IjoxMjgwLCJBayI6MjQsIkEwIjoxMiwiQTEiOjF9LCJ0bSI6eyJ0MCI6eyJhYiI6MSwicCI6M319LCJtIjp7ImwiOjIsIm1tIjozLCJ1bCI6MTEsImdzciI6M319
//eyJ0IjoyNDkzMzgsInIiOnsiYSI6MTAsImIiOjYzLCJjIjoxNX0sIm1yIjp7Im0iOjM3MSwiYiI6NzcsImMiOjI3OCwiZyI6OTc5LCJoIjo3NzgsInIiOjM3NywidiI6Njc3LCJhIjo3Nzh9LCJtdSI6eyJtIjp7ImhwIjoyMCwiZCI6MjAsIm1zIjo1LCJhdCI6NSwic3IiOjV9LCJiIjp7ImhwIjoyMCwiZCI6MjAsIm1zIjo1LCJhdCI6NSwic3IiOjV9LCJjIjp7ImhwIjoyMCwiZCI6MTYsIm1zIjo1LCJhdCI6NSwic3IiOjV9LCJnIjp7ImhwIjoxNiwiZCI6MTYsIm1zIjo1LCJhdCI6NSwic3IiOjV9LCJoIjp7ImhwIjoxNiwiZCI6MTYsIm1zIjo1LCJhdCI6NSwic3IiOjV9LCJyIjp7ImhwIjoxNiwiZCI6MTYsIm1zIjo1LCJhdCI6NSwic3IiOjR9LCJ2Ijp7ImhwIjoxNiwiZCI6MTYsIm1zIjo1LCJhdCI6NSwic3IiOjR9LCJhIjp7ImhwIjoxNiwiZCI6MTYsIm1zIjo0LCJhdCI6NCwic3IiOjR9fSwiZyI6WyJSYSIsIlJlIiwiSFAiLCJEIl0sImEiOnsiQW0iOjQ5LCJBdCI6MTMwNywiQWsiOjI0LCJBMCI6MTMsIkExIjoxfSwidG0iOnsidDAiOnsiYWIiOjEsInAiOjN9LCJ0MSI6eyJhYiI6MX19LCJtIjp7Im1tIjozLCJ1bCI6MTEsImdzciI6M319


//death/Water
//eyJ0IjoyNTAwNzMsInIiOnsiZCI6Mn0sIm1yIjp7Im0iOjY4LCJ3IjoyMzl9LCJiciI6eyJkZSI6MzA3fSwiYSI6eyJBbSI6MiwiQTIiOjF9LCJ0bSI6eyJ0MiI6eyJhYiI6MX19LCJtIjp7ImdzciI6MX19
//eyJ0IjoyNTA3MzAsInIiOnsiYSI6MjMsImIiOjEsImMiOjEzLCJkIjoyfSwibXIiOnsibSI6Mjk3LCJiIjoyNDcsImMiOjEwNDQsImciOjg0NiwiZSI6MTQ3MywidyI6MzY4fSwibXUiOnsibSI6eyJocCI6NiwiZCI6Niwic2QiOjF9LCJiIjp7ImhwIjo2LCJkIjo2fSwiYyI6eyJocCI6NiwiZCI6Nn0sImciOnsiaHAiOjUsImQiOjV9LCJlIjp7ImhwIjo1LCJkIjo1fSwidyI6eyJocCI6NSwiZCI6NX19LCJiciI6eyJkZSI6MH0sImciOlsiUmEiLCJSZSIsIkhQIiwiRCJdLCJhIjp7IkFtIjozMSwiQXQiOjEyMSwiQWsiOjMxLCJBMCI6MiwiQTEiOjEsIkEyIjoxfSwidG0iOnsidDAiOnsiYWIiOjF9LCJ0MSI6eyJhYiI6MX0sInQyIjp7ImFiIjoxfX0sIm0iOnsibW0iOjEsImdzciI6NX19



//https://stackoverflow.com/a/47227198
function isEmpty(item){
	return Object.keys(item).length === 0;
}
function isObject(item) {
  return (item && typeof item === "object" && !Array.isArray(item));
}
function mergeDeep(target, ...sources) {
	if (!sources.length) return target;
	const source = sources.shift();

	if (!isObject(target) || !isObject(source)) {
		return mergeDeep(target, ...sources);
	}

	for (const key in source) {
		if (isObject(source[key])) {
			if (!target[key]) 
			{
				Object.assign(target, { [key]: {} });
			}
			mergeDeep(target[key], source[key]);
		} else {
			Object.assign(target, { [key]: source[key] });
		}
	}

	return mergeDeep(target, ...sources);
}
function cleanObject(expected, input){
	if (!isObject(expected) || !isObject(input)){return;}
	
	for(var key in input){
		if(!(key in expected)){
			console.warn("Unexpected property '{0}' with value '{1}' on {1}.".format(key, input[key], input));
			delete input[key];
		}
		else if(isObject(expected[key]) && isObject(input[key])){
			cleanObject(expected[key], input[key]);
		}
		
	}
}
function offlineGains(gains){
	if(gains == 0){return;}
	var totalGains = {};
	for(var i=0;i<5;i++){
		if(tierUnlocked(i)){
			switch(i){
				case 0:
					resources.a.amt += gains;
					totalGains["a"] = gains;
					break;
				case 1:
					resources.b.amt += gains;
					totalGains["b"] = gains;
					break;
				case 2:
					resources.c.amt += gains;
					totalGains["c"] = gains;
					break;
				case 3:
					resources.d.amt += gains;
					totalGains["d"] = gains;
					break;
				case 4:
					resources.e.amt += gains;
					totalGains["e"] = gains;
					break;
			}
		}
		gains=Math.floor(gains/128);
	}
	
	var text = "Offline Gains:"
	
	setElementText("gainsModalHeader", "Offline Gains:");
	var ul = document.getElementById("gainsList");
	for(var g in totalGains){
		var text = "\n{0}: {1}{2}".format(resources[g].name, totalGains[g], resources[g].symbol);
		createNewElement("li", "gains"+g, ul, [], text);
	}
	var modal = document.getElementById("gainsModal");
	modal.style.display="block";
}

const year = 525600;

function loadData(){
	var cookie = getSaveCookie();
	if(!cookie || cookie == null){ return; }
	
	loadDataFromString(cookie);
}
function loadDataFromString(gameStateText){
	var gameState = {};
	try{
		gameState = JSON.parse(gameStateText);
	}
	catch{
		console.error("Bad JSON");
	}
	
	loadMinionResearch(gameState);
	loadMinionUpgrades(gameState);
	loadBossResearch(gameState);
	loadBossUpgrades(gameState);
	loadGauges(gameState);
	loadResources(gameState);
	loadTierMisc(gameState);
	loadAchievements(gameState);
	loadMisc(gameState);
	loadTime(gameState);
}
function loadTime(gameState){
	if(!gameState.hasOwnProperty("t")){return;}
	var now = getTimeSave();
	var t = gameState.t;
	
	var gains = now - t;
	while(gains < 0){ gains += year; }
	
	offlineGains(gains);
}
function loadMinionResearch(gs){
	if(!gs.hasOwnProperty("mr")){return;}
	
	for(var m in gs.mr){
		var minion = slMap.toLoad(m);
		if(!minionResearch.hasOwnProperty(minion)){ continue; }
		
		minionResearch[minion].isUnlocked = 1;
		minionResearch[minion].lastSpawn = gs.mr[m];
	}

	minionResearch.Mite.isUnlocked=1;//is always unlocked, even if someone hacks their save.
}
function loadMinionUpgrades(gs){
	if(!gs.hasOwnProperty("mu")){return;}
	
	for(var m in gs.mu){
		var minion = slMap.toLoad(m);
		if(!minionUpgrades.hasOwnProperty(minion)){ continue; }
		
		for(var u in gs.mu[m]){
			var upgrade = slMap.toLoad(u);
			if(!minionUpgrades[minion].hasOwnProperty(upgrade)){continue;}
			
			minionUpgrades[minion][upgrade] = gs.mu[m][u];
		}
	}
}
function loadBossResearch(gs){
	if(!gs.hasOwnProperty("br")){return;}
	
	for(var b in gs.br){
		var boss = slMap.toLoad(b);
		if(!bossResearch.hasOwnProperty(boss)){ continue; }
		
		bossResearch[boss].isUnlocked = 1;
		bossResearch[boss].lastSpawn = gs.br[b];
	}
}
function loadBossUpgrades(gs){
	if(!gs.hasOwnProperty("bu")){return;}
	
	for(var b in gs.bu){
		var boss = slMap.toLoad(b);
		if(!bossUpgrades.hasOwnProperty(boss)){ continue; }
		
		for(var u in gs.bu[b]){
			var upgrade = slMap.toLoad(u);
			if(!bossUpgrades[boss].hasOwnProperty(upgrade)){continue;}
			
			bossUpgrades[boss][upgrade] = gs.bu[b][u];
		}
	}}
function loadGauges(gs){
	if(!gs.hasOwnProperty("g")){return;}
	for(var g in gs.g){
		var gauge = slMap.toLoad(gs.g[g]);
		if(gauges.hasOwnProperty(gauge)){
			gauges[gauge].isUnlocked = 1;
		}
	}
}
function loadResources(gs){
	if(!gs.hasOwnProperty("r")){return;}
	var r = gs.r;
	
	for(var r in gs.r){
		if(!resources.hasOwnProperty(r)){ continue; }
		
		resources[r].amt = gs.r[r];
	}
}
function loadTierMisc(gs){
	if(!gs.hasOwnProperty("tm")){return;}
	var tm = gs.tm;
	
	for(var t in tm){
		if(tm[t].hasOwnProperty("ab")){
			tierMisc[t].autobuy.isUnlocked = 1;
		}
		if(tm[t].hasOwnProperty("p")){
			tierMisc[t].upgradePotency = tm[t].p;
		}
	}
}
function loadAchievements(gs){
	if(!gs.hasOwnProperty("a")){return;}
	var a = gs.a;
	
	for(var a in gs.a){
		var ach = slMap.toLoad(a);
		if(!achievements.hasOwnProperty(ach)){ continue; }
		
		achievements[ach].count = gs.a[a];
	}
}
function loadMisc(gs){
	if(!gs.hasOwnProperty("m")){return;}
	var m = gs.m;
	
	if(m.hasOwnProperty("l")){
		totalPaths = LevelToTotalPaths(m.l);
	}
	if(m.hasOwnProperty("mm")){
		maxMinions = m.mm;
	}
	if(m.hasOwnProperty("l")){
		totalPaths = LevelToTotalPaths(m.l);
	}
	if(m.hasOwnProperty("ul")){
		maxUpgradeLevel = m.ul;
	}
	if(m.hasOwnProperty("gsr")){
		globalSpawnDelayReduction = m.gsr;
	}
}

function saveData() {
    var d = new Date();
    d.setDate(d.getTime() + 7);
	var gs = buildGameState();
	var json = btoa(gs);
	console.log(gs, gs.length, json, json.length);
	var c = "gs={0};expires={1};SameSite=Strict;path=/".format(gs, d.toUTCString());
    document.cookie = c;
	lastSave = 0;
	
	document.getElementById("txtExport").value = null;
}
function buildGameState(){
	var gameState = {
		t:getTimeSave()
	};
	
	var currentResources = getResourcesSave();
	if(!isEmpty(currentResources)){
		gameState.r = currentResources;
	}
	
	var minionResearchSave = getMinionResearchSave();
	if(!isEmpty(minionResearchSave)){
		gameState.mr = minionResearchSave;
	}
	
	var minionUpgradeSave = getMinionUpgradeSave();
	if(!isEmpty(minionUpgradeSave)){
		gameState.mu = minionUpgradeSave;
	}
	
	var bossResearchSave = getBossResearchSave();
	if(!isEmpty(bossResearchSave)){
		gameState.br = bossResearchSave;
	}
	
	var bossUpgradeSave = getBossUpgradeSave();
	if(!isEmpty(bossUpgradeSave)){
		gameState.bu = bossUpgradeSave;
	}

	var gaugesSave = getGaugesSave();
	if(!isEmpty(gaugesSave)){
		gameState.g = gaugesSave;
	}

	var achievementSave = getAchievementSave();
	if(!isEmpty(achievementSave)){
		gameState.a = achievementSave;
	}
	
	var tierMiscSave = getTierMiscSave();
	if(!isEmpty(tierMiscSave)){
		gameState.tm = tierMiscSave;
	}
	
	var miscSave = getMiscSave();
	if(!isEmpty(miscSave)){
		gameState.m = miscSave;
	}
	
	return JSON.stringify(gameState);
}
function getTimeSave(){
	return Math.floor(Date.now() / 60000) % year;
}
function getMinionResearchSave(){
	var unlocked = {};
	for(var minion in minionResearch){
		if(minionResearch[minion].isUnlocked){
			unlocked[slMap.toSave(minion)] = minionResearch[minion].lastSpawn;
		}
	}
	return unlocked;
}
function getMinionUpgradeSave(){
	var upgraded = {};

	for(var minion in minionUpgrades){
		for(var upgrade in minionUpgrades[minion]){
			if(minionUpgrades[minion][upgrade] > 0){
				var m = slMap.toSave(minion);
				if(!upgraded.hasOwnProperty(m)){
					upgraded[m] = {};
				}
				
				upgraded[m][slMap.toSave(upgrade)] = minionUpgrades[minion][upgrade];
			}
		}
	}
	return upgraded;
}
function getBossResearchSave(){
	var unlocked = {};
	for(var boss in bossResearch){
		if(bossResearch[boss].isUnlocked){
			unlocked[slMap.toSave(boss)] = bossResearch[boss].lastSpawn;
		}
	}
	return unlocked;
}
function getBossUpgradeSave(){
	var upgraded = {};

	for(var boss in bossUpgrades){
		for(var upgrade in bossUpgrades[boss]){
			if(bossUpgrades[boss][upgrade] > 0){
				var b = slMap.toSave(boss);
				if(!upgraded.hasOwnProperty(boss)){
					upgraded[b] = {};
				}
				
				upgraded[b][slMap.toSave(upgrade)] = bossUpgrades[boss][upgrade];
			}
		}
	}
	return upgraded;
}
function getGaugesSave(){
	var unlocked = [];
	for(var gauge in gauges){
		if(gauges[gauge].isUnlocked){
			unlocked.push(slMap.toSave(gauge));
		}
	}
	
	return unlocked;
}
function getResourcesSave(){
	var r = {};
	
	for(var resource in resources){
		if(resources[resource].amt > 0){
			r[resource] = resources[resource].amt
		}
	}
	
	return r;
}
function getTierMiscSave(){
	var r = {};
	
	for(var key in tierMisc){
		if(tierMisc[key].autobuy.isUnlocked){
			if(!r.hasOwnProperty(key)){
				r[key] = {};
			}
			r[key].ab = 1;
		}
		if(tierMisc[key].upgradePotency > 0){
			if(!r.hasOwnProperty(key)){
				r[key] = {};
			}
			r[key].p = tierMisc[key].upgradePotency;
		}
	}
	
	return r;
}
function getAchievementSave(){
	var counts = {};
	for(var a in achievements){
		if(achievements[a].count>0){
			counts[slMap.toSave(a)] = achievements[a].count;
		}
	}
	return counts;
}
function getMiscSave(){
	var m = {};
	
	var currentLevel = getLevel();
	if(currentLevel > 0){
		m.l = currentLevel;
	}

	if(maxMinions > 0){
		m.mm = maxMinions;
	}

	if(maxUpgradeLevel > 10){
		m.ul = maxUpgradeLevel;
	}
	
	if(globalSpawnDelayReduction > 0){
		m.gsr = globalSpawnDelayReduction;
	}
	
	return m;
}


const saveLoadDictionary={
	a:"Air",
	Ad:"abilityDuration",
	Ac:"abilityCooldown",
	Ak:"heroesKilled",
	Al:"maxLevelCleared",
	Am:"minionsSpawned",
	A0:"prestige0",
	A1:"prestige1",
	A2:"prestige2",
	A3:"prestige3",
	A4:"prestige4",
	Ar:"itemRarity",
	As:"itemScrapped",
	At:"towersDestroyed",
	ac:"attackCharges",
	ap:"auraPower",
	ar:"auraRange",
	at:"attackRate",
	ag:"attackRange",
	b:"Bomber",
	c:"Catapult",
	de:"Death",
	d:"damage",
	D:"Damage",
	e:"Earth",
	f:"Fire",
	F:"Famine",
	g:"Golem",
	h:"Harpy",
	hp:"health",
	HP:"Health",
	i:"initialMinions",
	l:"lastSpawn",
	m:"Mite",
	mp:"minionsPerSpawn",
	ms:"moveSpeed",	
	ps:"projectileSpeed",
	pt:"projectileType",
	r:"Ram",
	Ra:"Range",
	Re:"Reload",
	sd:"spawnDelay",
	sr:"splashRadius",	
	u:"isUnlocked",
	v:"Vampire",
	w:"Water",
	W:"War"
}
const slMap = new TwoWayMap(saveLoadDictionary)
function TwoWayMap(dictionary) {
   this.map = dictionary;
   this.reverseMap = {};
   for(var key in dictionary) {
      var value = dictionary[key];
      this.reverseMap[value] = key;   
   }
}
TwoWayMap.prototype.toLoad = function(key){ return this.map[key]; };
TwoWayMap.prototype.toSave = function(key){ return this.reverseMap[key]; };

function getSaveCookie() {
    var dc = document.cookie;
    var prefix = "gs=";
    var begin = dc.indexOf("; " + prefix);
    if (begin == -1) {
        begin = dc.indexOf(prefix);
        if (begin != 0) return null;
    }
    else
    {
        begin += 2;
        var end = document.cookie.indexOf(";", begin);
        if (end == -1) {
        end = dc.length;
        }
    }
    return decodeURI(dc.substring(begin + prefix.length, end));
} 
function getExport(){
	saveData();
	
	var gameState = buildGameState();
	var base64 = btoa(gameState);
	
	var txtExport = document.getElementById("txtExport");
	txtExport.value = base64;

	document.getElementById("txtImport").value = null;
}
function doImport(){
	var txtImport = document.getElementById("txtImport");
	var base64 = txtImport.value;
	
	var gameState = atob(base64);
	loadDataFromString(gameState);

	txtImport.value = null;
	document.getElementById("txtExport").value = null;
}

