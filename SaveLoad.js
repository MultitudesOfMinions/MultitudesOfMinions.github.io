//eyJtaW5pb25SZXNlYXJjaCI6eyJNaXRlIjp7ImlzVW5sb2NrZWQiOjEsImxhc3RTcGF3biI6MTN9LCJDYXRhcHVsdCI6eyJpc1VubG9ja2VkIjoxLCJsYXN0U3Bhd24iOjB9LCJNYW50aWNvcmUiOnsiaXNVbmxvY2tlZCI6MSwibGFzdFNwYXduIjo5MX0sIk1pbm90YXVyIjp7ImlzVW5sb2NrZWQiOjAsImxhc3RTcGF3biI6MH19LCJtaW5pb25VcGdyYWRlcyI6eyJNaXRlIjp7ImhlYWx0aCI6MTAsImRhbWFnZSI6MTIsIm1vdmVTcGVlZCI6MCwiYXR0YWNrUmF0ZSI6MSwicHJvamVjdGlsZVNwZWVkIjowLCJzcGxhc2hSYWRpdXMiOjAsImF0dGFja1JhbmdlIjoxLCJzcGF3bkRlbGF5IjowLCJpbml0aWFsTWluaW9ucyI6MCwibWluaW9uc1BlclNwYXduIjowfSwiQ2F0YXB1bHQiOnsiaGVhbHRoIjoxMiwiZGFtYWdlIjoxNCwibW92ZVNwZWVkIjoxLCJhdHRhY2tSYXRlIjoyLCJwcm9qZWN0aWxlU3BlZWQiOjAsInNwbGFzaFJhZGl1cyI6MSwiYXR0YWNrUmFuZ2UiOjIsInNwYXduRGVsYXkiOjAsImluaXRpYWxNaW5pb25zIjowLCJtaW5pb25zUGVyU3Bhd24iOjF9LCJNYW50aWNvcmUiOnsiaGVhbHRoIjoxMiwiZGFtYWdlIjoxMiwibW92ZVNwZWVkIjoxLCJhdHRhY2tSYXRlIjoxLCJwcm9qZWN0aWxlU3BlZWQiOjAsInNwbGFzaFJhZGl1cyI6MSwiYXR0YWNrUmFuZ2UiOjEsInNwYXduRGVsYXkiOjAsImluaXRpYWxNaW5pb25zIjowLCJtaW5pb25zUGVyU3Bhd24iOjB9LCJNaW5vdGF1ciI6eyJoZWFsdGgiOjAsImRhbWFnZSI6MCwibW92ZVNwZWVkIjowLCJhdHRhY2tSYXRlIjowLCJwcm9qZWN0aWxlU3BlZWQiOjAsInNwbGFzaFJhZGl1cyI6MCwiYXR0YWNrUmFuZ2UiOjAsInNwYXduRGVsYXkiOjAsImluaXRpYWxNaW5pb25zIjowLCJtaW5pb25zUGVyU3Bhd24iOjB9fSwiYm9zc1Jlc2VhcmNoIjp7IkRlYXRoIjp7ImlzVW5sb2NrZWQiOjAsImxhc3RTcGF3biI6MH0sIkZhbWluZSI6eyJpc1VubG9ja2VkIjoxLCJsYXN0U3Bhd24iOjB9LCJXYXIiOnsiaXNVbmxvY2tlZCI6MCwibGFzdFNwYXduIjowfX0sImJvc3NVcGdyYWRlcyI6eyJEZWF0aCI6eyJhdHRhY2tSYXRlIjowLCJkYW1hZ2UiOjAsImF1cmFSYW5nZSI6MCwiYXVyYVBvd2VyIjowLCJhYmlsaXR5RHVyYXRpb24iOjAsImFiaWxpdHlDb29sZG93biI6MH0sIkZhbWluZSI6eyJhdHRhY2tSYW5nZSI6MCwic3Bhd25EZWxheSI6MCwiYXVyYVJhbmdlIjowLCJhdXJhUG93ZXIiOjAsImFiaWxpdHlEdXJhdGlvbiI6MCwiYWJpbGl0eUNvb2xkb3duIjowfSwiV2FyIjp7Im1vdmVTcGVlZCI6MCwiaGVhbHRoIjowLCJhdXJhUmFuZ2UiOjAsImF1cmFQb3dlciI6MCwiYWJpbGl0eUR1cmF0aW9uIjowLCJhYmlsaXR5Q29vbGRvd24iOjB9fSwiZ2F1Z2VzIjp7IlJhbmdlIjp7ImlzVW5sb2NrZWQiOjEsImNvc3QiOjF9LCJSZWxvYWQiOnsiaXNVbmxvY2tlZCI6MSwiY29zdCI6MX0sIkhlYWx0aCI6eyJpc1VubG9ja2VkIjoxLCJjb3N0IjoxfSwiRGFtYWdlIjp7ImlzVW5sb2NrZWQiOjEsImNvc3QiOjF9fSwibWF4TWluaW9ucyI6MiwibWluaW9uVXBncmFkZVBvdGVuY3kiOlsxLDAsMF0sInJlc291cmNlcyI6eyJhIjo1NCwiYiI6MTA1LCJjIjoyfSwibGV2ZWwiOjEsInByZXN0aWdlQ291bnRzIjpbNywxXSwiaGVyb0tpbGxzIjowLCJtaW5pb25zU3Bhd25lZCI6NjMsInRpbWUiOjI2NTAxNjA1fQ==
//eyJtaW5pb25SZXNlYXJjaCI6eyJNaXRlIjp7ImlzVW5sb2NrZWQiOjEsImxhc3RTcGF3biI6MTUyfSwiQ2F0YXB1bHQiOnsiaXNVbmxvY2tlZCI6MCwibGFzdFNwYXduIjowfSwiTWFudGljb3JlIjp7ImlzVW5sb2NrZWQiOjAsImxhc3RTcGF3biI6MH0sIk1pbm90YXVyIjp7ImlzVW5sb2NrZWQiOjEsImxhc3RTcGF3biI6NDE4fX0sIm1pbmlvblVwZ3JhZGVzIjp7Ik1pdGUiOnsiaGVhbHRoIjo5LCJkYW1hZ2UiOjEwLCJtb3ZlU3BlZWQiOjAsImF0dGFja1JhdGUiOjAsInByb2plY3RpbGVTcGVlZCI6MCwic3BsYXNoUmFkaXVzIjowLCJhdHRhY2tSYW5nZSI6MCwic3Bhd25EZWxheSI6MCwiaW5pdGlhbE1pbmlvbnMiOjAsIm1pbmlvbnNQZXJTcGF3biI6MH0sIkNhdGFwdWx0Ijp7ImhlYWx0aCI6MCwiZGFtYWdlIjowLCJtb3ZlU3BlZWQiOjAsImF0dGFja1JhdGUiOjAsInByb2plY3RpbGVTcGVlZCI6MCwic3BsYXNoUmFkaXVzIjowLCJhdHRhY2tSYW5nZSI6MCwic3Bhd25EZWxheSI6MCwiaW5pdGlhbE1pbmlvbnMiOjAsIm1pbmlvbnNQZXJTcGF3biI6MX0sIk1hbnRpY29yZSI6eyJoZWFsdGgiOjAsImRhbWFnZSI6MCwibW92ZVNwZWVkIjowLCJhdHRhY2tSYXRlIjowLCJwcm9qZWN0aWxlU3BlZWQiOjAsInNwbGFzaFJhZGl1cyI6MCwiYXR0YWNrUmFuZ2UiOjAsInNwYXduRGVsYXkiOjAsImluaXRpYWxNaW5pb25zIjowLCJtaW5pb25zUGVyU3Bhd24iOjB9LCJNaW5vdGF1ciI6eyJoZWFsdGgiOjksImRhbWFnZSI6MTAsIm1vdmVTcGVlZCI6MCwiYXR0YWNrUmF0ZSI6MCwicHJvamVjdGlsZVNwZWVkIjowLCJzcGxhc2hSYWRpdXMiOjAsImF0dGFja1JhbmdlIjowLCJzcGF3bkRlbGF5IjowLCJpbml0aWFsTWluaW9ucyI6MCwibWluaW9uc1BlclNwYXduIjowfX0sImJvc3NSZXNlYXJjaCI6eyJEZWF0aCI6eyJpc1VubG9ja2VkIjoxLCJsYXN0U3Bhd24iOjB9LCJGYW1pbmUiOnsiaXNVbmxvY2tlZCI6MSwibGFzdFNwYXduIjowfSwiV2FyIjp7ImlzVW5sb2NrZWQiOjEsImxhc3RTcGF3biI6MjkwNi4yNX19LCJib3NzVXBncmFkZXMiOnsiRGVhdGgiOnsiYXR0YWNrUmF0ZSI6MCwibW92ZVNwZWVkIjowLCJhdXJhUmFuZ2UiOjAsImF1cmFQb3dlciI6MCwiYWJpbGl0eUR1cmF0aW9uIjowLCJhYmlsaXR5Q29vbGRvd24iOjB9LCJGYW1pbmUiOnsiYXR0YWNrUmFuZ2UiOjAsInNwYXduRGVsYXkiOjAsImF1cmFSYW5nZSI6MCwiYXVyYVBvd2VyIjowLCJhYmlsaXR5RHVyYXRpb24iOjAsImFiaWxpdHlDb29sZG93biI6MH0sIldhciI6eyJkYW1hZ2UiOjAsImhlYWx0aCI6MCwiYXVyYVJhbmdlIjowLCJhdXJhUG93ZXIiOjAsImFiaWxpdHlEdXJhdGlvbiI6MCwiYWJpbGl0eUNvb2xkb3duIjowfX0sImdhdWdlcyI6eyJSYW5nZSI6eyJpc1VubG9ja2VkIjoxLCJjb3N0IjoxfSwiUmVsb2FkIjp7ImlzVW5sb2NrZWQiOjEsImNvc3QiOjF9LCJIZWFsdGgiOnsiaXNVbmxvY2tlZCI6MSwiY29zdCI6MX0sIkRhbWFnZSI6eyJpc1VubG9ja2VkIjoxLCJjb3N0IjoxfX0sIm1heE1pbmlvbnMiOjIsIm1pbmlvblVwZ3JhZGVQb3RlbmN5IjpbMCwwLDBdLCJyZXNvdXJjZXMiOnsiYSI6Mzc5LCJiIjozMCwiYyI6MTV9LCJsZXZlbCI6MywicHJlc3RpZ2VDb3VudHMiOlszLDJdLCJoZXJvS2lsbHMiOjAsIm1pbmlvbnNTcGF3bmVkIjoxNDEsInRpbWUiOjI2NTAyMDAzfQ==
function offlineGains(offlineMinutes, maxMinions){
	return Math.floor(Math.min(offlineMinutes, 24*7)**(maxMinions**.5));
}

function loadData(){
	setupGauges();
	
	var cookie = getSaveCookie();
	if(!cookie || cookie == null){ return; }
	
	loadDataFromString(cookie);
}
function loadDataFromString(gameStateText){
	var gameState = {};
	try{
		gameState = JSON.parse(gameStateText);
	}
	catch{
		console.error("Bad JSON");
	}
	
	if(gameState.hasOwnProperty('minionResearch')){
		cleanObject(minionResearch, gameState.minionResearch)
		mergeDeep(minionResearch, gameState.minionResearch);
		minionResearch.Mite.isUnlocked=1;//is always unlocked, even if someone hacks their save.
	}

	if(gameState.hasOwnProperty('minionUpgrades')){
		cleanObject(minionUpgrades, gameState.minionUpgrades)
		mergeDeep(minionUpgrades, gameState.minionUpgrades);
	}
	
	if(gameState.hasOwnProperty('minionUpgradePotency')){
		var potLength = Math.min(minionUpgradePotency.length, gameState.minionUpgradePotency.length)
		for(var i=0;i<potLength;i++){
			minionUpgradePotency[i] = gameState.minionUpgradePotency[i];
		}
	}

	if(gameState.hasOwnProperty('bossResearch'))
	{
		cleanObject(bossResearch, gameState.bossResearch)
		mergeDeep(bossResearch, gameState.bossResearch);
	}
	
	if(gameState.hasOwnProperty('bossUpgrades')){
		cleanObject(bossUpgrades, gameState.bossUpgrades)
		mergeDeep(bossUpgrades, gameState.bossUpgrades);
	}
	
	if(gameState.hasOwnProperty('gauges')){
		cleanObject(gauges, gameState.gauges)
		mergeDeep(gauges, gameState.gauges);
	}
	if(gameState.hasOwnProperty('maxMinions')){
		maxMinions = gameState.maxMinions;
	}
	
	if(gameState.hasOwnProperty('resources')){
		for(var key in resources)
		{
			if(gameState.resources.hasOwnProperty(key)){
				resources[key].amt = gameState.resources[key];
			}
			else{
				resources[key].amt = 0;
			}
		}
	}

	if(gameState.hasOwnProperty('level')){
		totalPaths = LevelToTotalPaths(gameState.level);
	}
	
	if(gameState.hasOwnProperty('prestigeCounts')){
		prestigeCounts = gameState.prestigeCounts;
	}
	
	if(gameState.hasOwnProperty('time')){
		offlineTime = Math.floor(Date.now() / 60000) - gameState.time;
		resources.a.amt += offlineGains(offlineTime/60, maxMinions);
	}
	
}

//https://stackoverflow.com/a/47227198
function isObject(item) {
  return (item && typeof item === 'object' && !Array.isArray(item));
}
function mergeDeep(target, ...sources) {
	if (!sources.length) return target;
	const source = sources.shift();

	if (!isObject(target) || !isObject(source)) {
		return mergeDeep(target, ...sources);
	}

	for (const key in source) {
		if (isObject(source[key])) {
			if (!target[key]) 
			{
				Object.assign(target, { [key]: {} });
			}
			mergeDeep(target[key], source[key]);
		} else {
			Object.assign(target, { [key]: source[key] });
		}
	}

	return mergeDeep(target, ...sources);
}
function cleanObject(expected, input){
	if (!isObject(expected) || !isObject(input)){return;}
	
	for(var key in input){
		if(!(key in expected)){
			console.warn("Unexpected property '{0}' with value '{1}' on {1}.".format(key, input[key], input));
			delete input[key];
		}
		else if(isObject(expected[key]) && isObject(input[key])){
			cleanObject(expected[key], input[key]);
		}
		
	}
}

function saveData() {
    var d = new Date();
    d.setDate(d.getTime() + 7);
	var c = "gameState={0};expires={1};path=/".format(buildGameState(), d.toUTCString());
    document.cookie = c;
	lastSave = 0;
	
	document.getElementById('txtExport').value = null;
}
function buildGameState(){
	var gameState = {
		minionResearch: Object.assign({}, minionResearch),
		minionUpgrades:Object.assign({}, minionUpgrades),
		bossResearch: Object.assign({}, bossResearch),
		bossUpgrades: Object.assign({}, bossUpgrades),
		gauges: Object.assign({}, gauges),
		maxMinions:maxMinions,
		minionUpgradePotency:minionUpgradePotency,
		resources:{ a:resources.a.amt||0, b:resources.b.amt||0, c:resources.c.amt||0 },
		level:getLevel(),
		prestigeCounts:prestigeCounts,
		heroKills:heroKills,
		minionsSpawned:minionsSpawned,
		time:Math.floor(Date.now() / 60000)
	}
	
	return JSON.stringify(gameState);
}
function getSaveCookie() {
    var dc = document.cookie;
    var prefix = "gameState=";
    var begin = dc.indexOf("; " + prefix);
    if (begin == -1) {
        begin = dc.indexOf(prefix);
        if (begin != 0) return null;
    }
    else
    {
        begin += 2;
        var end = document.cookie.indexOf(";", begin);
        if (end == -1) {
        end = dc.length;
        }
    }
    return decodeURI(dc.substring(begin + prefix.length, end));
} 

function getExport(){
	saveData();
	
	var gameState = buildGameState();
	var base64 = btoa(gameState);
	
	var txtExport = document.getElementById('txtExport');
	txtExport.value = base64;

	document.getElementById('txtImport').value = null;
}
function doImport(){
	var txtImport = document.getElementById('txtImport');
	var base64 = txtImport.value;
	
	console.log(totalPaths);
	var gameState = atob(base64);
	loadDataFromString(gameState);
	console.log(totalPaths);

	txtImport.value = null;
	document.getElementById('txtExport').value = null;
}

