//eyJtaW5pb25SZXNlYXJjaCI6eyJNaXRlIjp7ImlzVW5sb2NrZWQiOjEsImxhc3RTcGF3biI6MjI3fSwiTWFudGljb3JlIjp7ImlzVW5sb2NrZWQiOjAsImxhc3RTcGF3biI6MH0sIk1pbm90YXVyIjp7ImlzVW5sb2NrZWQiOjAsImxhc3RTcGF3biI6MH19LCJtaW5pb25VcGdyYWRlcyI6eyJNaXRlIjp7ImhlYWx0aCI6NiwiZGFtYWdlIjo2LCJtb3ZlU3BlZWQiOjAsImF0dGFja1JhdGUiOjAsInByb2plY3RpbGVTcGVlZCI6MCwic3BsYXNoUmFkaXVzIjowLCJhdHRhY2tSYW5nZSI6MCwic3Bhd25EZWxheSI6MCwiaW5pdGlhbE1pbmlvbnMiOjAsIm1pbmlvbnNQZXJTcGF3biI6MH0sIk1hbnRpY29yZSI6eyJoZWFsdGgiOjAsImRhbWFnZSI6MCwibW92ZVNwZWVkIjowLCJhdHRhY2tSYXRlIjowLCJwcm9qZWN0aWxlU3BlZWQiOjAsInNwbGFzaFJhZGl1cyI6MCwiYXR0YWNrUmFuZ2UiOjAsInNwYXduRGVsYXkiOjAsImluaXRpYWxNaW5pb25zIjowLCJtaW5pb25zUGVyU3Bhd24iOjF9LCJNaW5vdGF1ciI6eyJoZWFsdGgiOjAsImRhbWFnZSI6MCwibW92ZVNwZWVkIjowLCJhdHRhY2tSYXRlIjowLCJwcm9qZWN0aWxlU3BlZWQiOjAsInNwbGFzaFJhZGl1cyI6MCwiYXR0YWNrUmFuZ2UiOjAsInNwYXduRGVsYXkiOjAsImluaXRpYWxNaW5pb25zIjowLCJtaW5pb25zUGVyU3Bhd24iOjJ9fSwiYm9zc1Jlc2VhcmNoIjp7IldhciI6eyJpc1VubG9ja2VkIjoxLCJsYXN0U3Bhd24iOjgyN30sIkZhbWluZSI6eyJpc1VubG9ja2VkIjowLCJsYXN0U3Bhd24iOjB9LCJEZWF0aCI6eyJpc1VubG9ja2VkIjowLCJsYXN0U3Bhd24iOjB9fSwiYm9zc1VwZ3JhZGVzIjp7IldhciI6eyJtb3ZlU3BlZWQiOjAsImRhbWFnZVJlZHVjdGlvbiI6MCwiYXVyYVJhbmdlIjowLCJhdXJhUG93ZXIiOjAsImFiaWxpdHlEdXJhdGlvbiI6MCwiYWJpbGl0eUNvb2xkb3duIjowfSwiRmFtaW5lIjp7ImF0dGFja1JhbmdlIjowLCJkYW1hZ2VSZWR1Y3Rpb24iOjAsImF1cmFSYW5nZSI6MCwiYXVyYVBvd2VyIjowLCJhYmlsaXR5RHVyYXRpb24iOjAsImFiaWxpdHlDb29sZG93biI6MH0sIkRlYXRoIjp7ImF0dGFja1JhdGUiOjAsImRhbWFnZVJlZHVjdGlvbiI6MCwiYXVyYVJhbmdlIjowLCJhdXJhUG93ZXIiOjAsImFiaWxpdHlEdXJhdGlvbiI6MCwiYWJpbGl0eUNvb2xkb3duIjowfX0sImdhdWdlcyI6eyJSYW5nZSI6eyJpc1VubG9ja2VkIjowLCJjb3N0IjoxfSwiUmVsb2FkIjp7ImlzVW5sb2NrZWQiOjAsImNvc3QiOjF9LCJIZWFsdGgiOnsiaXNVbmxvY2tlZCI6MCwiY29zdCI6MX0sIkRhbWFnZSI6eyJpc1VubG9ja2VkIjowLCJjb3N0IjoxfX0sIm1heE1pbmlvbnMiOjEsIm1pbmlvblVwZ3JhZGVQb3RlbmN5IjpbMCwwLDBdLCJyZXNvdXJjZXMiOnsiYSI6NDUsImIiOjAsImMiOjV9LCJsZXZlbCI6MCwicHJlc3RpZ2VDb3VudHMiOlswLDJdLCJoZXJvS2lsbHMiOjAsIm1pbmlvbnNTcGF3bmVkIjoxLCJ0aW1lIjoyNjQ5MTEwOH0=

//about to promote
//eyJtaW5pb25SZXNlYXJjaCI6eyJNaXRlIjp7ImlzVW5sb2NrZWQiOjEsImxhc3RTcGF3biI6MTcxfSwiTWFudGljb3JlIjp7ImlzVW5sb2NrZWQiOjEsImxhc3RTcGF3biI6MjUyfSwiTWlub3RhdXIiOnsiaXNVbmxvY2tlZCI6MSwibGFzdFNwYXduIjo2NzR9fSwibWluaW9uVXBncmFkZXMiOnsiTWl0ZSI6eyJoZWFsdGgiOjAsImRhbWFnZSI6MCwibW92ZVNwZWVkIjoyLCJhdHRhY2tSYXRlIjoxLCJwcm9qZWN0aWxlU3BlZWQiOjAsInNwbGFzaFJhZGl1cyI6MSwiYXR0YWNrUmFuZ2UiOjIsInNwYXduRGVsYXkiOjAsImluaXRpYWxNaW5pb25zIjowLCJtaW5pb25zUGVyU3Bhd24iOjB9LCJNYW50aWNvcmUiOnsiaGVhbHRoIjowLCJkYW1hZ2UiOjAsIm1vdmVTcGVlZCI6MiwiYXR0YWNrUmF0ZSI6MiwicHJvamVjdGlsZVNwZWVkIjowLCJzcGxhc2hSYWRpdXMiOjIsImF0dGFja1JhbmdlIjozLCJzcGF3bkRlbGF5IjowLCJpbml0aWFsTWluaW9ucyI6MCwibWluaW9uc1BlclNwYXduIjoxfSwiTWlub3RhdXIiOnsiaGVhbHRoIjowLCJkYW1hZ2UiOjAsIm1vdmVTcGVlZCI6MiwiYXR0YWNrUmF0ZSI6MiwicHJvamVjdGlsZVNwZWVkIjowLCJzcGxhc2hSYWRpdXMiOjMsImF0dGFja1JhbmdlIjoyLCJzcGF3bkRlbGF5IjowLCJpbml0aWFsTWluaW9ucyI6MCwibWluaW9uc1BlclNwYXduIjoxfX0sImJvc3NSZXNlYXJjaCI6eyJXYXIiOnsiaXNVbmxvY2tlZCI6MSwibGFzdFNwYXduIjowfSwiRmFtaW5lIjp7ImlzVW5sb2NrZWQiOjAsImxhc3RTcGF3biI6MH0sIkRlYXRoIjp7ImlzVW5sb2NrZWQiOjAsImxhc3RTcGF3biI6MH19LCJib3NzVXBncmFkZXMiOnsiV2FyIjp7Im1vdmVTcGVlZCI6MCwiZGFtYWdlUmVkdWN0aW9uIjowLCJhdXJhUmFuZ2UiOjAsImF1cmFQb3dlciI6MCwiYWJpbGl0eUR1cmF0aW9uIjowLCJhYmlsaXR5Q29vbGRvd24iOjB9LCJGYW1pbmUiOnsiYXR0YWNrUmFuZ2UiOjAsImRhbWFnZVJlZHVjdGlvbiI6MCwiYXVyYVJhbmdlIjowLCJhdXJhUG93ZXIiOjAsImFiaWxpdHlEdXJhdGlvbiI6MCwiYWJpbGl0eUNvb2xkb3duIjowfSwiRGVhdGgiOnsiYXR0YWNrUmF0ZSI6MCwiZGFtYWdlUmVkdWN0aW9uIjowLCJhdXJhUmFuZ2UiOjAsImF1cmFQb3dlciI6MCwiYWJpbGl0eUR1cmF0aW9uIjowLCJhYmlsaXR5Q29vbGRvd24iOjB9fSwiZ2F1Z2VzIjp7IlJhbmdlIjp7ImlzVW5sb2NrZWQiOjEsImNvc3QiOjF9LCJSZWxvYWQiOnsiaXNVbmxvY2tlZCI6MSwiY29zdCI6MX0sIkhlYWx0aCI6eyJpc1VubG9ja2VkIjoxLCJjb3N0IjoxfSwiRGFtYWdlIjp7ImlzVW5sb2NrZWQiOjEsImNvc3QiOjF9fSwibWF4TWluaW9ucyI6NCwibWluaW9uVXBncmFkZVBvdGVuY3kiOlsyLDAsMF0sInJlc291cmNlcyI6eyJhIjoyNSwiYiI6MTM1LCJjIjo1fSwibGV2ZWwiOjAsInByZXN0aWdlQ291bnRzIjpbOSwxXSwiaGVyb0tpbGxzIjowLCJtaW5pb25zU3Bhd25lZCI6NDgsInRpbWUiOjI2NDkxMDQ3fQ==

//eyJtaW5pb25SZXNlYXJjaCI6eyJNaXRlIjp7ImlzVW5sb2NrZWQiOjEsImxhc3RTcGF3biI6MTg2fSwiTWFudGljb3JlIjp7ImlzVW5sb2NrZWQiOjAsImxhc3RTcGF3biI6MH0sIk1pbm90YXVyIjp7ImlzVW5sb2NrZWQiOjEsImxhc3RTcGF3biI6OTV9fSwibWluaW9uVXBncmFkZXMiOnsiTWl0ZSI6eyJoZWFsdGgiOjEwLCJkYW1hZ2UiOjEwLCJtb3ZlU3BlZWQiOjAsImF0dGFja1JhdGUiOjAsInByb2plY3RpbGVTcGVlZCI6MCwic3BsYXNoUmFkaXVzIjowLCJhdHRhY2tSYW5nZSI6MCwic3Bhd25EZWxheSI6MywiaW5pdGlhbE1pbmlvbnMiOjMsIm1pbmlvbnNQZXJTcGF3biI6M30sIk1hbnRpY29yZSI6eyJoZWFsdGgiOjAsImRhbWFnZSI6MCwibW92ZVNwZWVkIjowLCJhdHRhY2tSYXRlIjowLCJwcm9qZWN0aWxlU3BlZWQiOjAsInNwbGFzaFJhZGl1cyI6MCwiYXR0YWNrUmFuZ2UiOjAsInNwYXduRGVsYXkiOjAsImluaXRpYWxNaW5pb25zIjowLCJtaW5pb25zUGVyU3Bhd24iOjF9LCJNaW5vdGF1ciI6eyJoZWFsdGgiOjksImRhbWFnZSI6MTAsIm1vdmVTcGVlZCI6MCwiYXR0YWNrUmF0ZSI6MCwicHJvamVjdGlsZVNwZWVkIjowLCJzcGxhc2hSYWRpdXMiOjAsImF0dGFja1JhbmdlIjowLCJzcGF3bkRlbGF5IjowLCJpbml0aWFsTWluaW9ucyI6MCwibWluaW9uc1BlclNwYXduIjoyfX0sImJvc3NSZXNlYXJjaCI6eyJXYXIiOnsiaXNVbmxvY2tlZCI6MSwibGFzdFNwYXduIjowfSwiRmFtaW5lIjp7ImlzVW5sb2NrZWQiOjEsImxhc3RTcGF3biI6MH0sIkRlYXRoIjp7ImlzVW5sb2NrZWQiOjEsImxhc3RTcGF3biI6MH19LCJib3NzVXBncmFkZXMiOnsiV2FyIjp7Im1vdmVTcGVlZCI6MCwiZGFtYWdlUmVkdWN0aW9uIjowLCJhdXJhUmFuZ2UiOjAsImF1cmFQb3dlciI6MCwiYWJpbGl0eUR1cmF0aW9uIjowLCJhYmlsaXR5Q29vbGRvd24iOjB9LCJGYW1pbmUiOnsiYXR0YWNrUmFuZ2UiOjAsImRhbWFnZVJlZHVjdGlvbiI6MCwiYXVyYVJhbmdlIjowLCJhdXJhUG93ZXIiOjAsImFiaWxpdHlEdXJhdGlvbiI6MCwiYWJpbGl0eUNvb2xkb3duIjowfSwiRGVhdGgiOnsiYXR0YWNrUmF0ZSI6MCwiZGFtYWdlUmVkdWN0aW9uIjowLCJhdXJhUmFuZ2UiOjAsImF1cmFQb3dlciI6MCwiYWJpbGl0eUR1cmF0aW9uIjowLCJhYmlsaXR5Q29vbGRvd24iOjB9fSwiZ2F1Z2VzIjp7IlJhbmdlIjp7ImlzVW5sb2NrZWQiOjEsImNvc3QiOjF9LCJSZWxvYWQiOnsiaXNVbmxvY2tlZCI6MSwiY29zdCI6MX0sIkhlYWx0aCI6eyJpc1VubG9ja2VkIjoxLCJjb3N0IjoxfSwiRGFtYWdlIjp7ImlzVW5sb2NrZWQiOjEsImNvc3QiOjF9fSwibWF4TWluaW9ucyI6MSwibWluaW9uVXBncmFkZVBvdGVuY3kiOlswLDAsMF0sInJlc291cmNlcyI6eyJhIjoyOTgsImIiOjEsImMiOjEyMX0sImxldmVsIjozLCJwcmVzdGlnZUNvdW50cyI6WzIsMl0sImhlcm9LaWxscyI6MCwibWluaW9uc1NwYXduZWQiOjk5LCJ0aW1lIjoyNjQ5MTg1OX0=

function offlineGains(offlineMinutes, maxMinions){
	return Math.floor(Math.min(offlineMinutes, 24*7)**(maxMinions**.5));
}

function loadData(){
	setupGauges();
	
	var cookie = getSaveCookie();
	if(!cookie || cookie == null){ return; }
	
	loadDataFromString(cookie);
}
function loadDataFromString(gameStateText){
	var gameState = JSON.parse(gameStateText);
	
	if(gameState.hasOwnProperty('minionResearch')){
		cleanObject(minionResearch, gameState.minionResearch)
		mergeDeep(minionResearch, gameState.minionResearch);
		minionResearch.Mite.isUnlocked=1;//is always unlocked, even if someone hacks their save.
	}

	if(gameState.hasOwnProperty('minionUpgrades')){
		cleanObject(minionUpgrades, gameState.minionUpgrades)
		mergeDeep(minionUpgrades, gameState.minionUpgrades);
	}
	
	if(gameState.hasOwnProperty('minionUpgradePotency')){
		var potLength = Math.min(minionUpgradePotency.length, gameState.minionUpgradePotency.length)
		for(var i=0;i<potLength;i++){
			minionUpgradePotency[i] = gameState.minionUpgradePotency[i];
		}
	}

	if(gameState.hasOwnProperty('bossResearch'))
	{
		cleanObject(bossResearch, gameState.bossResearch)
		mergeDeep(bossResearch, gameState.bossResearch);
	}
	
	if(gameState.hasOwnProperty('bossUpgrades')){
		cleanObject(bossUpgrades, gameState.bossUpgrades)
		mergeDeep(bossUpgrades, gameState.bossUpgrades);
	}
	
	if(gameState.hasOwnProperty('gauges')){
		cleanObject(gauges, gameState.gauges)
		mergeDeep(gauges, gameState.gauges);
	}
	if(gameState.hasOwnProperty('maxMinions')){
		maxMinions = gameState.maxMinions;
	}
	
	if(gameState.hasOwnProperty('resources')){
		for(var key in resources)
		{
			if(gameState.resources.hasOwnProperty(key)){
				resources[key].amt = gameState.resources[key];
			}
			else{
				resources[key].amt = 0;
			}
		}
	}

	if(gameState.hasOwnProperty('level')){
		totalPaths += LevelToTotalPaths(gameState.level);
	}
	
	if(gameState.hasOwnProperty('prestigeCounts')){
		prestigeCounts = gameState.prestigeCounts;
	}
	
	if(gameState.hasOwnProperty('time')){
		offlineTime = Math.floor(Date.now() / 60000) - gameState.time;
		resources.a.amt += offlineGains(offlineTime/60, maxMinions);
	}
	
}

//https://stackoverflow.com/a/47227198
function isObject(item) {
  return (item && typeof item === 'object' && !Array.isArray(item));
}
function mergeDeep(target, ...sources) {
	if (!sources.length) return target;
	const source = sources.shift();

	if (!isObject(target) || !isObject(source)) {
		return mergeDeep(target, ...sources);
	}

	for (const key in source) {
		if (isObject(source[key])) {
			if (!target[key]) 
			{
				Object.assign(target, { [key]: {} });
			}
			mergeDeep(target[key], source[key]);
		} else {
			Object.assign(target, { [key]: source[key] });
		}
	}

	return mergeDeep(target, ...sources);
}
function cleanObject(expected, input){
	if (!isObject(expected) || !isObject(input)){return;}
	
	for(var key in input){
		if(!(key in expected)){
			console.warn("Unexpected property '{0}' with value '{1}' on {1}.".format(key, input[key], input));
			delete input[key];
		}
		else if(isObject(expected[key]) && isObject(input[key])){
			cleanObject(expected[key], input[key]);
		}
		
	}
}

function saveData() {
    var d = new Date();
    d.setDate(d.getTime() + 7);
	var c = "gameState={0};expires={1};path=/".format(buildGameState(), d.toUTCString());
    document.cookie = c;
	lastSave = 0;
	
	document.getElementById('txtExport').value = null;
}
function buildGameState(){
	var gameState = {
		minionResearch: Object.assign({}, minionResearch),
		minionUpgrades:Object.assign({}, minionUpgrades),
		bossResearch: Object.assign({}, bossResearch),
		bossUpgrades: Object.assign({}, bossUpgrades),
		gauges: Object.assign({}, gauges),
		maxMinions:maxMinions,
		minionUpgradePotency:minionUpgradePotency,
		resources:{ a:resources.a.amt||0, b:resources.b.amt||0, c:resources.c.amt||0 },
		level:getLevel(),
		prestigeCounts:prestigeCounts,
		heroKills:heroKills,
		minionsSpawned:minionsSpawned,
		time:Math.floor(Date.now() / 60000)
	}
	
	return JSON.stringify(gameState);
}
function getSaveCookie() {
    var dc = document.cookie;
    var prefix = "gameState=";
    var begin = dc.indexOf("; " + prefix);
    if (begin == -1) {
        begin = dc.indexOf(prefix);
        if (begin != 0) return null;
    }
    else
    {
        begin += 2;
        var end = document.cookie.indexOf(";", begin);
        if (end == -1) {
        end = dc.length;
        }
    }
    return decodeURI(dc.substring(begin + prefix.length, end));
} 

function getExport(){
	saveData();
	
	var gameState = buildGameState();
	var base64 = btoa(gameState);
	
	var txtExport = document.getElementById('txtExport');
	txtExport.value = base64;

	document.getElementById('txtImport').value = null;
}
function doImport(){
	var txtImport = document.getElementById('txtImport');
	var base64 = txtImport.value;
	
	var gameState = atob(base64);
	loadDataFromString(gameState);
	
	txtImport.value = null;
	document.getElementById('txtExport').value = null;
}

